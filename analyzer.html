<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- å®‰å…¨æ¨™é ­ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://sheets.googleapis.com https://generativelanguage.googleapis.com https://raw.githubusercontent.com; form-action 'self'; base-uri 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <title>ç„¡é™ææ€– ST åŠ©æ‰‹ v2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-abyss: #0a0a0c;
            --bg-deep: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #222230;
            --bg-hover: #2a2a3a;
            --accent-blood: #c41e3a;
            --accent-blood-dim: #8b1528;
            --accent-gold: #d4a020;
            --accent-ember: #ff6b35;
            --accent-purple: #9b59b6;
            --accent-blue: #3498db;
            --accent-cyan: #00d4aa;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-dim: #606070;
            --border: #333340;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            --info: #70a1ff;
            --radius: 16px;
            --radius-sm: 10px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg-abyss);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-abyss); }
        ::-webkit-scrollbar-thumb { background: var(--accent-blood-dim); border-radius: 4px; }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--accent-blood-dim) 0%, var(--bg-deep) 40%, var(--bg-abyss) 100%);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-blood);
            position: relative;
        }
        header::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            animation: scan 3s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(196, 30, 58, 0.5);
        }
        h1 .highlight { color: var(--accent-gold); }
        .subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .version { display: inline-block; padding: 2px 8px; background: var(--accent-gold); color: #000; font-size: 0.7rem; font-weight: 700; border-radius: 8px; margin-left: 8px; }

        /* Navigation */
        .main-nav {
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 5px;
            padding: 10px 15px;
        }
        .nav-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-btn.active { background: var(--accent-blood-dim); color: var(--accent-gold); }

        /* Container */
        .container { max-width: 1300px; margin: 0 auto; padding: 20px 15px; }

        /* Pages */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 22px;
            margin-bottom: 22px;
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--accent-blood), var(--accent-gold));
        }
        .card.gold::before { background: linear-gradient(90deg, var(--accent-gold), var(--accent-ember)); }
        .card.purple::before { background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue)); }
        .card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)); }
        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 0.85rem; color: var(--text-secondary); }
        .input-group input, .input-group select, .input-group textarea {
            padding: 12px 15px;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--accent-gold); }
        .input-group input::placeholder, .input-group textarea::placeholder { color: var(--text-dim); }
        .input-hint { font-size: 0.75rem; color: var(--text-dim); }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blood), var(--accent-blood-dim)); color: #fff; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(196,30,58,0.4); }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold), var(--accent-ember)); color: #000; }
        .btn-gold:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-secondary { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--accent-gold); color: var(--text-primary); }
        .action-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 18px; }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 18px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover { border-color: var(--accent-gold); }
        .tab-btn.active { background: var(--accent-blood-dim); border-color: var(--accent-blood); color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tags */
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            padding: 6px 14px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 18px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag:hover { border-color: var(--accent-gold); }
        .tag.selected { background: var(--accent-blood-dim); border-color: var(--accent-blood); color: #fff; }

        /* Textarea */
        .text-area {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.8;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-primary);
            outline: none;
            resize: vertical;
            font-family: inherit;
        }
        .text-area:focus { border-color: var(--accent-gold); }

        /* Preview */
        .preview-box {
            margin-top: 18px;
            padding: 18px;
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            max-height: 350px;
            overflow-y: auto;
        }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .preview-title { font-weight: 600; color: var(--accent-gold); font-size: 0.9rem; }
        .preview-stats { font-size: 0.8rem; color: var(--text-dim); }
        .char-card { background: var(--bg-card); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--accent-blood); }
        .char-card h4 { color: var(--accent-gold); margin-bottom: 6px; font-size: 0.95rem; }
        .char-card .notes { font-size: 0.8rem; color: var(--accent-ember); background: rgba(255,107,53,0.1); padding: 6px 10px; border-radius: 5px; margin-top: 8px; }

        /* Results */
        .result-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 18px; overflow: hidden; }
        .result-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 22px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
        .result-name { font-size: 1.1rem; font-weight: 700; }
        .power-level { padding: 6px 16px; font-size: 0.95rem; font-weight: 900; border-radius: 20px; font-family: 'Orbitron', sans-serif; }
        .power-level.S { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
        .power-level.A { background: linear-gradient(135deg, #c41e3a, #8b1528); color: #fff; }
        .power-level.B { background: linear-gradient(135deg, #9b59b6, #6c3483); color: #fff; }
        .power-level.C { background: linear-gradient(135deg, #3498db, #2471a3); color: #fff; }
        .power-level.D { background: linear-gradient(135deg, #27ae60, #1e8449); color: #fff; }
        .result-body { padding: 22px; }
        .result-section { margin-bottom: 18px; }
        .result-section h4 { font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 10px; }
        .result-section ul { list-style: none; }
        .result-section li { padding: 10px 14px; margin-bottom: 6px; background: var(--bg-deep); border-radius: var(--radius-sm); border-left: 3px solid var(--accent-blood-dim); font-size: 0.9rem; }
        .result-section li.warning { border-left-color: var(--danger); background: rgba(255,71,87,0.1); }
        .result-section li.weakness { border-left-color: var(--info); }
        .result-section li.success { border-left-color: var(--success); }
        .rule-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .rule-tag { padding: 5px 12px; font-size: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 15px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .rule-tag:hover { background: var(--accent-blood-dim); color: #fff; }

        /* Chart */
        .chart-container { position: relative; height: 320px; margin: 15px 0; }

        /* BOSS Simulator */
        .boss-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 18px; }
        .stat-input { text-align: center; }
        .stat-input label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 4px; }
        .stat-input input { width: 100%; padding: 10px; font-size: 1.1rem; font-weight: 700; text-align: center; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-deep); color: var(--accent-gold); }
        .sim-result { background: var(--bg-deep); border-radius: var(--radius-sm); padding: 18px; margin-top: 18px; }
        .sim-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .sim-row:last-child { border-bottom: none; }
        .sim-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .sim-badge.danger { background: rgba(255,71,87,0.2); color: var(--danger); }
        .sim-badge.warning { background: rgba(255,165,2,0.2); color: var(--warning); }
        .sim-badge.safe { background: rgba(46,213,115,0.2); color: var(--success); }

        /* Chat */
        .chat-box { display: flex; flex-direction: column; height: 450px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-deep); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .chat-msg { margin-bottom: 15px; display: flex; gap: 10px; }
        .chat-msg.user { flex-direction: row-reverse; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .chat-msg.user .chat-avatar { background: var(--accent-gold); }
        .chat-msg.ai .chat-avatar { background: var(--accent-blood); }
        .chat-bubble { max-width: 75%; padding: 10px 14px; border-radius: var(--radius-sm); font-size: 0.9rem; line-height: 1.6; }
        .chat-msg.user .chat-bubble { background: var(--accent-gold); color: #000; border-bottom-right-radius: 3px; }
        .chat-msg.ai .chat-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 3px; }
        .chat-input-row { display: flex; gap: 10px; }
        .chat-input-row input { flex: 1; }

        /* Checklist */
        .checklist { list-style: none; }
        .checklist li { padding: 12px 14px; margin-bottom: 6px; background: var(--bg-deep); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .checklist li:hover { background: var(--bg-hover); }
        .checklist li.checked { background: rgba(46,213,115,0.1); border-left: 3px solid var(--success); }
        .check-icon { font-size: 1.1rem; color: var(--text-dim); }
        .checklist li.checked .check-icon { color: var(--success); }

        /* History */
        .history-item { background: var(--bg-deep); border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; border-left: 3px solid var(--accent-gold); cursor: pointer; transition: all 0.2s; }
        .history-item:hover { background: var(--bg-hover); transform: translateX(4px); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .history-title { font-weight: 600; font-size: 0.95rem; }
        .history-date { font-size: 0.75rem; color: var(--text-dim); }
        .history-preview { font-size: 0.8rem; color: var(--text-secondary); }

        /* Messages */
        .msg { padding: 12px 16px; border-radius: var(--radius-sm); margin-bottom: 12px; display: none; font-size: 0.9rem; }
        .msg.show { display: block; }
        .msg.error { background: rgba(255,71,87,0.1); border: 1px solid var(--danger); color: var(--danger); }
        .msg.success { background: rgba(46,213,115,0.1); border: 1px solid var(--success); color: var(--success); }
        .msg.info { background: rgba(112,161,255,0.1); border: 1px solid var(--info); color: var(--info); }

        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,12,0.92); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; gap: 18px; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--border); border-top-color: var(--accent-blood); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 0.95rem; color: var(--text-secondary); }

        /* Footer */
        footer { text-align: center; padding: 22px 15px; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 25px; }
        footer a { color: var(--accent-gold); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Save indicator */
        .save-indicator { font-size: 0.75rem; color: var(--success); opacity: 0; transition: opacity 0.3s; margin-left: auto; }
        .save-indicator.show { opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-btn { padding: 8px 12px; font-size: 0.8rem; }
            .form-grid { grid-template-columns: 1fr; }
            .input-row { flex-direction: column; }
            .action-row { flex-direction: column; }
            .action-row .btn { width: 100%; }
            .result-header { flex-direction: column; text-align: center; }
            .boss-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-container { height: 260px; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸšŒ ç„¡é™ææ€– <span class="highlight">ST åŠ©æ‰‹</span> <span class="version">v2.0</span></h1>
    <p class="subtitle">è§’å¡åˆ†æ Â· BOSSæ¨¡æ“¬ Â· è¦å‰‡å•ç­” Â· NPCç”Ÿæˆ Â· é­é‡è¨­è¨ˆ</p>
</header>

<nav class="main-nav">
    <div class="nav-container">
        <button class="nav-btn active" onclick="switchPage('analyze')" data-page="analyze">âš”ï¸ è§’å¡åˆ†æ</button>
        <button class="nav-btn" onclick="switchPage('boss')" data-page="boss">ğŸ‘¹ BOSSæ¨¡æ“¬</button>
        <button class="nav-btn" onclick="switchPage('qa')" data-page="qa">ğŸ“š è¦å‰‡å•ç­”</button>
        <button class="nav-btn" onclick="switchPage('npc')" data-page="npc">ğŸ² NPCç”Ÿæˆ</button>
        <button class="nav-btn" onclick="switchPage('checklist')" data-page="checklist">âœ… è¨­è¨ˆæª¢æŸ¥</button>
        <button class="nav-btn" onclick="switchPage('history')" data-page="history">ğŸ“Š æ­·å²ç´€éŒ„</button>
        <button class="nav-btn" onclick="switchPage('settings')" data-page="settings">âš™ï¸ è¨­å®š</button>
    </div>
</nav>

<div class="container">

    <!-- ===== è§’å¡åˆ†æé  ===== -->
    <section class="page active" id="page-analyze">
        <div class="card">
            <div class="card-title">ğŸ“‹ è§’å¡è³‡æ–™è¼¸å…¥</div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('sheets')">ğŸ“Š Google Sheets</button>
                <button class="tab-btn" onclick="switchTab('text')">ğŸ“ è²¼ä¸Šæ–‡å­—</button>
            </div>
            <div class="tab-content active" id="tab-sheets">
                <div class="input-row" style="margin-bottom: 12px;">
                    <input type="text" id="sheetsUrl" placeholder="è²¼ä¸Š Google Sheets é€£çµ...">
                    <button class="btn btn-gold" onclick="fetchSheets()">ğŸ“¥ è®€å–</button>
                </div>
                <p class="input-hint">ğŸ’¡ è©¦ç®—è¡¨éœ€è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººéƒ½èƒ½æª¢è¦–ã€</p>
                <div id="sheetSelector" style="display:none; margin-top:15px;">
                    <label style="display:block; margin-bottom:8px; color:var(--text-secondary); font-size:0.85rem;">é¸æ“‡è¦åˆ†æçš„è§’è‰²ï¼š</label>
                    <div class="tag-list" id="sheetTabs"></div>
                </div>
            </div>
            <div class="tab-content" id="tab-text">
                <textarea class="text-area" id="textInput" placeholder="ç›´æ¥è²¼ä¸Šè§’å¡å…§å®¹...

ç¯„ä¾‹ï¼š
========== è§’è‰²ï¼šè«çˆ¾ç´¢ ==========
åŠ›é‡ï¼š6  æ•æ·ï¼š4  æ„å¿—å€¼ï¼š16
ç‰¹æ®Šèƒ½åŠ›ï¼šå¾·ç‘ªè¥¿äºæ­£ç¾©ã€å‚™è¨»ï¼šæ¥è§¸æ”»æ“Šç„¡è¦–è­·ç”²ã€‘"></textarea>
            </div>
            <div class="preview-box" id="previewBox" style="display:none;">
                <div class="preview-header">
                    <span class="preview-title">ğŸ“„ è³‡æ–™é è¦½</span>
                    <span class="preview-stats" id="previewStats"></span>
                </div>
                <div id="previewContent"></div>
            </div>
            <div class="msg error" id="analyzeError"></div>
            <div class="action-row">
                <button class="btn btn-primary" onclick="analyzeCharacters()" style="flex:2;">âš”ï¸ åˆ†æè§’å¡æˆ°åŠ›</button>
                <button class="btn btn-secondary" onclick="window.open('index.html','_blank')">ğŸ“š è¦å‰‡æŸ¥è©¢</button>
            </div>
        </div>
        <div id="analyzeResults" style="display:none;">
            <div class="card gold">
                <div class="card-title">
                    ğŸ“Š åˆ†æçµæœ
                    <div style="margin-left:auto; display:flex; gap:8px;">
                        <button class="btn btn-secondary" onclick="exportResults('discord')" style="padding:6px 12px; font-size:0.8rem;">ğŸ“‹ è¤‡è£½</button>
                        <button class="btn btn-secondary" onclick="exportResults('json')" style="padding:6px 12px; font-size:0.8rem;">ğŸ’¾ JSON</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="radarChart"></canvas></div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </section>

    <!-- ===== BOSS æ¨¡æ“¬é  ===== -->
    <section class="page" id="page-boss">
        <div class="card purple">
            <div class="card-title">ğŸ‘¹ BOSS å°æˆ°æ¨¡æ“¬å™¨</div>
            <p style="color:var(--text-secondary); margin-bottom:15px; font-size:0.9rem;">è¼¸å…¥ BOSS æ•¸å€¼ï¼Œé æ¸¬ç©å®¶æ“Šæ®ºå›åˆæ•¸</p>
            <div class="boss-grid">
                <div class="stat-input"><label>ç”Ÿå‘½å€¼</label><input type="number" id="bossHp" value="50"></div>
                <div class="stat-input"><label>é˜²ç¦¦</label><input type="number" id="bossDef" value="20"></div>
                <div class="stat-input"><label>æ”»æ“Š</label><input type="number" id="bossAtk" value="15"></div>
                <div class="stat-input"><label>å‚·å®³</label><input type="number" id="bossDmg" value="10"></div>
                <div class="stat-input"><label>å…ˆæ”»</label><input type="number" id="bossInit" value="10"></div>
                <div class="stat-input"><label>æŠ—æ€§</label><input type="number" id="bossResist" value="0"></div>
            </div>
            <div class="input-group">
                <label>BOSS ç‰¹æ®Šèƒ½åŠ›ï¼ˆé¸å¡«ï¼‰</label>
                <textarea class="text-area" id="bossAbilities" style="min-height:80px;" placeholder="å¦‚ï¼šå…ç–«ç²¾ç¥æ”»æ“Šã€æ¯3å›åˆæ¢å¾©10HP..."></textarea>
            </div>
            <div class="msg error" id="bossError"></div>
            <button class="btn btn-primary" onclick="simulateBoss()" style="width:100%; margin-top:15px;">âš”ï¸ é–‹å§‹æ¨¡æ“¬</button>
            <button class="btn btn-secondary" onclick="checkBossStandards()" style="width:100%; margin-top:10px;">
                ğŸ“Š æª¢æŸ¥æ•¸å€¼æ˜¯å¦ç¬¦åˆè¦å‰‡æ›¸æ¨™æº–
            </button>
            <div class="sim-result" id="bossResult" style="display:none;">
                <h4 style="color:var(--accent-gold); margin-bottom:12px;">ğŸ“Š æ¨¡æ“¬çµæœ</h4>
                <div id="bossResultContent"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ’¡ è¨­è¨ˆå»ºè­°</div>
            <div id="bossTips"><p style="color:var(--text-dim);">å®Œæˆæ¨¡æ“¬å¾Œé¡¯ç¤ºå»ºè­°</p></div>
        </div>
    </section>

    <!-- ===== è¦å‰‡å•ç­”é  ===== -->
    <section class="page" id="page-qa">
        <div class="card cyan">
            <div class="card-title">ğŸ“š è¦å‰‡æ›¸ AI å•ç­”</div>
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-msg ai">
                        <div class="chat-avatar">ğŸ¤–</div>
                        <div class="chat-bubble">ä½ å¥½ï¼æˆ‘å¯ä»¥å›ç­”ç„¡é™ææ€–è¦å‰‡å•é¡Œã€‚<br><br>è©¦è©¦å•ï¼šã€Œæ“’æŠ±è¦å‰‡ï¼Ÿã€ã€ŒåŸºå› é–æ•ˆæœï¼Ÿã€ã€Œç ´ç”²æ€éº¼ç®—ï¼Ÿã€</div>
                    </div>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-gold" onclick="sendChat()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== NPC ç”Ÿæˆé  ===== -->
    <section class="page" id="page-npc">
        <div class="card">
            <div class="card-title">ğŸ² å¿«é€Ÿ NPC ç”Ÿæˆå™¨</div>
            <div class="form-grid">
                <div class="input-group">
                    <label>é›£åº¦</label>
                    <select id="npcDiff">
                        <option value="minion">é›œå…µ</option>
                        <option value="standard" selected>æ¨™æº–</option>
                        <option value="elite">ç²¾è‹±</option>
                        <option value="boss">é ­ç›®</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>é¡å‹</label>
                    <select id="npcType">
                        <option value="melee">è¿‘æˆ°</option>
                        <option value="ranged">é ç¨‹</option>
                        <option value="mage">æ³•å¸«</option>
                        <option value="tank">å¦å…‹</option>
                        <option value="assassin">åˆºå®¢</option>
                    </select>
                </div>
            </div>
            <div class="input-group" style="margin-top:15px;">
                <label>é¡å¤–æè¿°</label>
                <input type="text" id="npcDesc" placeholder="å¦‚ï¼šç•°å½¢é¢¨æ ¼ã€æ“…é•·æ½›è¡Œ...">
            </div>
            <div class="msg error" id="npcError"></div>
            <button class="btn btn-primary" onclick="generateNPC()" style="width:100%; margin-top:15px;">ğŸ² ç”Ÿæˆ NPC</button>
            <div id="npcOutput" style="display:none; margin-top:18px; padding:18px; background:var(--bg-deep); border-radius:var(--radius-sm); white-space:pre-wrap; font-size:0.9rem; line-height:1.8;"></div>
        </div>
    </section>

    <!-- ===== è¨­è¨ˆæª¢æŸ¥é  ===== -->
    <section class="page" id="page-checklist">
        <div class="card">
            <div class="card-title">âœ… å‰¯æœ¬è¨­è¨ˆæª¢æŸ¥æ¸…å–®</div>
            <ul class="checklist" id="checklistItems">
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>BOSS HP æ˜¯å¦è¶³å¤ æ‰¿å—éšŠä¼æœ€é«˜è¼¸å‡ºï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰æ²’æœ‰é‡å°é«˜æ©Ÿå‹•è§’è‰²çš„é™åˆ¶ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰æ²’æœ‰åç§’æ®ºæ©Ÿåˆ¶ï¼Ÿï¼ˆåˆ†éšæ®µ/ç„¡æ•µæ™‚é–“ï¼‰</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>ä½æˆ°åŠ›è§’è‰²æœ‰ç™¼æ®ç©ºé–“å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>BOSS èƒ½çªç ´é«˜é˜²è§’è‰²å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>ç²¾ç¥æ”»æ“Šå°é«˜æ„å¿—è§’è‰²æœ‰æ•ˆå—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æˆ°å ´æœ‰åˆ©ç”¨åƒ¹å€¼å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰å‚™æ¡ˆæ–¹æ¡ˆå—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>è€ƒæ…®éç©å®¶çš„éš±è—åº•ç‰Œå—ï¼Ÿ</li>
            </ul>
            <div class="action-row">
                <button class="btn btn-secondary" onclick="resetChecklist()">ğŸ”„ é‡ç½®</button>
            </div>
        </div>
        <div class="card gold">
            <div class="card-title">ğŸ’¡ AI é­é‡å»ºè­°</div>
            <div class="input-group">
                <label>æè¿°ä½ æƒ³è¨­è¨ˆçš„é­é‡</label>
                <textarea class="text-area" id="encounterDesc" style="min-height:100px;" placeholder="å¦‚ï¼šå»¢æ£„é†«é™¢çš„è®Šç•°è­·å£«æˆ°é¬¥..."></textarea>
            </div>
            <div class="msg error" id="encounterError"></div>
            <button class="btn btn-gold" onclick="getEncounterTips()" style="width:100%; margin-top:12px;">ğŸ§  ç²å–å»ºè­°</button>
            <div id="encounterTips" style="display:none; margin-top:15px; padding:15px; background:var(--bg-deep); border-radius:var(--radius-sm);"></div>
        </div>
    </section>

    <!-- ===== æ­·å²ç´€éŒ„é  ===== -->
    <section class="page" id="page-history">
        <div class="card">
            <div class="card-title">
                ğŸ“Š åˆ†ææ­·å²
                <button class="btn btn-secondary" onclick="clearHistory()" style="margin-left:auto; padding:6px 12px; font-size:0.8rem;">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="historyList"><p style="color:var(--text-dim); text-align:center; padding:30px;">å°šç„¡ç´€éŒ„</p></div>
        </div>
        <div class="card purple">
            <div class="card-title">ğŸ“ˆ è§’è‰²æˆé•·è¿½è¹¤</div>
            <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:12px;">æ¯”è¼ƒåŒä¸€è§’è‰²ä¸åŒæ™‚é–“çš„è®ŠåŒ–</p>
            <select id="trackSelect" style="width:100%; padding:10px; background:var(--bg-deep); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary);">
                <option value="">-- å®Œæˆåˆ†æå¾Œå¯é¸æ“‡ --</option>
            </select>
            <div id="trackResult" style="display:none; margin-top:15px;"></div>
        </div>
    </section>

    <!-- ===== è¨­å®šé  ===== -->
    <section class="page" id="page-settings">
        <div class="card">
            <div class="card-title">ğŸ”‘ API è¨­å®š <span class="save-indicator" id="saveIndicator">âœ“ å·²å„²å­˜</span></div>
            <div class="form-grid">
                <div class="input-group">
                    <label>Google Sheets API Key</label>
                    <input type="password" id="sheetsApiKey" placeholder="AIzaSy...">
                    <span class="input-hint">è®€å–è©¦ç®—è¡¨ç”¨</span>
                </div>
                <div class="input-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
                    <span class="input-hint">AI åˆ†æç”¨</span>
                </div>
            </div>
            <div class="msg info" style="display:block; margin-top:15px;">ğŸ”’ API Key åƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ“– è¦å‰‡æ›¸ç‹€æ…‹</div>
            <div id="rulesStatus"><p style="color:var(--text-dim);">è¼‰å…¥ä¸­...</p></div>
        </div>
    </section>

</div>

<footer>
    <a href="index.html">ğŸ“– è¦å‰‡æŸ¥è©¢</a> | 
    <a href="https://www.hktrpg.com/INF/2.35Christmas.html" target="_blank">è¦å‰‡æ›¸ä¾†æº</a>
    <p style="margin-top:6px;">åƒ…ä¾›å­¸ç¿’ä½¿ç”¨ Â· v2.0</p>
</footer>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è™•ç†ä¸­...</div>
</div>

<script>
'use strict';

// ===== é…ç½® =====
const CONFIG = Object.freeze({
    STORAGE_PREFIX: 'inf_st_',
    SHEETS_API: 'https://sheets.googleapis.com/v4/spreadsheets',
    GEMINI_API: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
    RULES_URL: './rules-2.35.txt',
    MAX_INPUT: 50000,
    MAX_RULES: 12000,
    MAX_HISTORY: 30,
});

// ============================================================
// ç„¡é™ææ€– 2.35 æ€ªç‰©åœ–é‘‘ç¸½ç¶± - NPC æ§‹å»ºè¦å‰‡
// ============================================================
const NPC_RULES = {
    // 1. åŸºç¤å±¬æ€§æ§‹å»ºè¦å‰‡ (ä¸»å±¬æ€§x2, å‰¯å±¬æ€§x3, é€šå¸¸x1)
    statStructure: {
        "Minion": {
            rank: "ç„¡æ”¯ç·š",
            attr: { pri: 4, sec: 2, norm: 1 },
            skill: { pri: 3, sec: 2, norm: 1 },
            desc: "æœ€åŸºç¤çš„é›œé­šæ•µäºº"
        },
        "D": {
            rank: "D",
            attr: { pri: 6, sec: 4, norm: 2 },
            skill: { pri: 5, sec: 3, norm: 1 },
            desc: "åˆéšè¼ªè¿´è€…æ°´å¹³"
        },
        "C": {
            rank: "C",
            attr: { pri: 11, sec: 6, norm: 4 },
            skill: { pri: 8, sec: 4, norm: 2 },
            desc: "æœ‰1-2å€‹Cç´šå¼·åŒ–çš„è¼ªè¿´è€…"
        },
        "B": {
            rank: "B",
            attr: { pri: 16, sec: 11, norm: 6 },
            skill: { pri: 10, sec: 5, norm: 3 },
            desc: "è³‡æ·±è¼ªè¿´è€…/åŸºå› é–äºŒéš"
        },
        "A": {
            rank: "A",
            attr: { pri: 21, sec: 16, norm: 8 },
            skill: { pri: 13, sec: 8, norm: 4 },
            desc: "é ‚å°–æˆ°åŠ›/åŸºå› é–ä¸‰éšä»¥ä¸Š"
        },
        "S": {
            rank: "S",
            attr: { pri: 26, sec: 21, norm: 11 },
            skill: { pri: 15, sec: 10, norm: 5 },
            desc: "ç¥ç´šå­˜åœ¨/åŸºå› é–å››éš"
        }
    },

    // 2. æˆ°åŠ›åƒè€ƒè¡¨ (å–ã€Œæ™®é€šã€æ¨™æº–ä½œç‚ºåŸºæº–ç·š)
    // æ”»æ“ŠDPã€å‚·å®³ä¸Šé™ã€é˜²ç¦¦åŠ›ã€å»ºè­°HP
    combatBenchmarks: {
        "D": { atk: 30, dmgCap: 17, def: 16, hp: "200-400", hpNum: 300 },
        "C": { atk: 54, dmgCap: 27, def: 36, hp: "800-1500", hpNum: 1000 },
        "B": { atk: 78, dmgCap: 38, def: 56, hp: "3000-5000", hpNum: 4000 },
        "A": { atk: 104, dmgCap: 49, def: 76, hp: "10000+", hpNum: 10000 },
        "S": { atk: 130, dmgCap: 60, def: 96, hp: "ç„¡æ³•ä¼°é‡", hpNum: 50000 }
    },

    // 3. BOSS æ¨¡æ¿å…ç–«èƒ½åŠ› (è¦å‰‡æ›¸æ¨™æº–)
    bossImmunities: {
        "D": "å…ç–«è‡ªç„¶æ¯’ç´ ã€ç–¾ç—…ã€é»‘æš—è¦–è¦ºã€ç„¡è¦–å›°é›£åœ°å½¢",
        "C": "å…ç–«è¶…è‡ªç„¶æ¯’ç´ /ç–¾ç—…/ç–²å‹/éœ‡æ‡¾/éº»ç—¹/ç²¾ç¥æŸç¸›/æªæ‰‹ä¸åŠ/éš±å½¢ã€ç›²è¦–",
        "B": "å…ç–«è®Šå½¢/ä¸è‰¯é»æ•¸/çŸ³åŒ–/å†°å°/èƒ½é‡å¸å–/å¿ƒéˆå½±éŸ¿ã€éˆè¦–ã€å…ç–«å¤šæ¬¡æ”»æ“Šæ¸›å€¼",
        "A": "å…ç–«è€åŒ–ã€å…ç–«å±¬æ€§å‚·å®³ã€å…ç–«å³æ­»ã€çœŸå¯¦è¦–è¦º",
        "S": "å…ç–«è§£é›¢ã€å…ç–«å±¬æ€§å¸å–ã€å…ç–«å› æœå¾‹ã€å…ç–«æ™‚é–“ã€å…ç–«ç©ºé–“"
    },

    // 4. æ“Šæ®ºåŸºç¤çå‹µ
    rewards: {
        "D": "500é»",
        "C": "Cç´šæ”¯ç·š + 1000é»",
        "B": "Bç´šæ”¯ç·š + 2000é»",
        "A": "Aç´šæ”¯ç·š + 3000é»",
        "S": "Sç´šæ”¯ç·š + 4000é»"
    },

    // 5. é¡å‹å°æ‡‰çš„ä¸»å±¬æ€§å»ºè­°
    typeAttributes: {
        "melee": { primary: ["è‚Œè‚‰", "ç´°èƒ"], secondary: ["æ•æ·", "åæ‡‰", "ç²¾ç¥"] },
        "ranged": { primary: ["æ•æ·", "åæ‡‰"], secondary: ["æ„ŸçŸ¥", "ç²¾ç¥", "ç´°èƒ"] },
        "mage": { primary: ["æ™ºåŠ›", "ç²¾ç¥"], secondary: ["æ„å¿—", "æ„ŸçŸ¥", "é­…åŠ›"] },
        "tank": { primary: ["ç´°èƒ", "è‚Œè‚‰"], secondary: ["æ„å¿—", "ç²¾ç¥", "åæ‡‰"] },
        "assassin": { primary: ["æ•æ·", "åæ‡‰"], secondary: ["æ„ŸçŸ¥", "è‚Œè‚‰", "æ™ºåŠ›"] },
        "support": { primary: ["æ™ºåŠ›", "é­…åŠ›"], secondary: ["ç²¾ç¥", "æ„å¿—", "æ„ŸçŸ¥"] }
    }
};

// ============================================================
// ç„¡é™ææ€– 2.35 ç©å®¶æˆ°åŠ›æ¨™æº–è¡¨
// å–®ä½ï¼šDP (éª°æ± )ï¼Œ1 é™„åŠ æˆåŠŸ â‰ˆ 3 DP
// ============================================================
const PLAYER_STANDARDS = {
    "D": {
        rank: "D",
        atk_dp: 30,      // æ”»æ“Šéª°æ± 
        dmg_cap: 17,     // å‚·å®³ä¸Šé™
        def: 16,         // é˜²ç¦¦å€¼
        save: 14,        // å¹³å‡è±å…
        burst: 20,       // çˆ†ç™¼å‚·å®³/å›åˆ
        desc: "è£å‚™ 1-2 å€‹ D ç´šå¼·åŒ–çš„è¼ªè¿´è€…"
    },
    "C": {
        rank: "C",
        atk_dp: 54,
        dmg_cap: 27,
        def: 36,
        save: 25,
        burst: 35,
        desc: "è£å‚™ 1-2 å€‹ C ç´šå¼·åŒ–æˆ–åŒç­‰æ•¸å€¼"
    },
    "B": {
        rank: "B",
        atk_dp: 78,
        dmg_cap: 38,
        def: 56,
        save: 36,
        burst: 55,
        desc: "è³‡æ·±è¼ªè¿´éšŠæˆå“¡æ°´å¹³"
    },
    "A": {
        rank: "A",
        atk_dp: 104,
        dmg_cap: 49,
        def: 76,
        save: 56,
        burst: 80,
        desc: "åŠç¥/åŸºå› é–å››éšæ°´å¹³"
    },
    "S": {
        rank: "S",
        atk_dp: 130,
        dmg_cap: 60,
        def: 96,
        save: 56,
        burst: 120,
        desc: "ç¥ç´šå­˜åœ¨"
    }
};

// ===== ç‹€æ…‹ =====
let state = {
    sheetsData: null,
    selectedSheets: new Set(),
    rulesData: [],
    charText: '',
    lastAnalysis: null,
    radarChart: null,
    history: [],
};

// ===== å®‰å…¨å·¥å…· =====
function escapeHtml(t) {
    if (typeof t !== 'string') return '';
    return t.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]);
}

function sanitize(t, max = CONFIG.MAX_INPUT) {
    if (typeof t !== 'string') return '';
    return t.trim().substring(0, max).replace(/[\x00-\x1F\x7F]/g, '');
}

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    loadApiKeys();
    setupAutoSave();
    loadRules();
    loadHistory();
    renderHistory();
});

// ===== é é¢åˆ‡æ› =====
function switchPage(name) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === name));
    document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + name));
}

function switchTab(name) {
    document.querySelectorAll('#page-analyze .tab-btn').forEach((b, i) => b.classList.toggle('active', (name === 'sheets' ? i === 0 : i === 1)));
    document.getElementById('tab-sheets').classList.toggle('active', name === 'sheets');
    document.getElementById('tab-text').classList.toggle('active', name === 'text');
}

// ===== API Key =====
function loadApiKeys() {
    const sk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'sheets_key');
    const gk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'gemini_key');
    if (sk) document.getElementById('sheetsApiKey').value = sk;
    if (gk) document.getElementById('geminiApiKey').value = gk;
}

function setupAutoSave() {
    const si = document.getElementById('sheetsApiKey');
    const gi = document.getElementById('geminiApiKey');
    const ind = document.getElementById('saveIndicator');
    const save = () => {
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'sheets_key', si.value);
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'gemini_key', gi.value);
        ind.classList.add('show');
        setTimeout(() => ind.classList.remove('show'), 2000);
    };
    si.addEventListener('change', save);
    gi.addEventListener('change', save);
}

function getKey(type) {
    const k = document.getElementById(type + 'ApiKey')?.value?.trim();
    if (!k) throw new Error('è«‹å…ˆåœ¨è¨­å®šé å¡«å…¥ ' + (type === 'sheets' ? 'Google Sheets' : 'Gemini') + ' API Key');
    return k;
}

// ===== è¦å‰‡æ›¸ =====
async function loadRules() {
    const el = document.getElementById('rulesStatus');
    try {
        const res = await fetch(CONFIG.RULES_URL);
        if (!res.ok) throw new Error();
        const txt = await res.text();
        parseRules(txt);
        el.innerHTML = '<p style="color:var(--success)">âœ… è¼‰å…¥æˆåŠŸï¼Œå…± ' + state.rulesData.length + ' æ¢</p>';
    } catch (e) {
        el.innerHTML = '<p style="color:var(--warning)">âš ï¸ è¦å‰‡æ›¸è¼‰å…¥å¤±æ•—ï¼ŒAIåŠŸèƒ½ä»å¯ç”¨</p>';
    }
}

function parseRules(content) {
    const lines = content.split('\n');
    let cur = null;
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const parts = line.split('\t');
        if (parts.length >= 4 && parts[2]?.includes('http')) {
            if (cur?.content?.length > 20) state.rulesData.push(cur);
            cur = { category: (parts[0] || '').trim(), filename: (parts[1] || '').trim(), content: parts.slice(3).join(' ').trim() };
        } else if (cur) {
            cur.content += ' ' + line.trim();
        }
    }
    if (cur?.content?.length > 20) state.rulesData.push(cur);
    state.rulesData.forEach((e, i) => { e.id = i; e.search = (e.category + ' ' + e.filename + ' ' + e.content).toLowerCase(); });
}

function searchRules(keywords) {
    if (!keywords?.length) return [];
    const terms = keywords.map(k => k.toLowerCase());
    const res = [];
    state.rulesData.forEach(e => {
        const score = terms.filter(t => e.search.includes(t)).length;
        if (score > 0) res.push({ ...e, score });
    });
    res.sort((a, b) => b.score - a.score);
    return res.slice(0, 12);
}

function extractKeywords(text) {
    const kw = new Set();
    const patterns = [/ã€([^ã€‘]+)ã€‘/g, /ã€Œ([^ã€]+)ã€/g, /ã€([^ã€]+)ã€/g, /ç‰¹æ®Šèƒ½åŠ›[ï¼š:]\s*(\S+)/g, /å°ˆé•·[ï¼š:]\s*(\S+)/g];
    patterns.forEach(p => { let m; while ((m = p.exec(text)) !== null) if (m[1]?.length > 1 && m[1].length < 20) kw.add(m[1]); });
    ['å‚³å¥‡å±¬æ€§', 'åŸºå› é–', 'é™„åŠ æˆåŠŸ', 'ç ´ç”²', 'ç ´é­”'].forEach(t => { if (text.includes(t)) kw.add(t); });
    return Array.from(kw);
}

// ===== Google Sheets =====
async function fetchSheets() {
    const key = getKey('sheets');
    const url = sanitize(document.getElementById('sheetsUrl').value, 500);
    if (!url) { showError('analyzeError', 'è«‹è²¼ä¸Šé€£çµ'); return; }
    const id = extractSheetId(url);
    if (!id) { showError('analyzeError', 'ç„¡æ•ˆé€£çµ'); return; }
    showLoading('è®€å–è©¦ç®—è¡¨...');
    hideError('analyzeError');
    try {
        const meta = await (await fetch(CONFIG.SHEETS_API + '/' + id + '?key=' + key)).json();
        if (meta.error) throw new Error(meta.error.message);
        const sheets = meta.sheets || [];
        if (!sheets.length) throw new Error('ç„¡åˆ†é ');
        displaySheetTabs(sheets);
        state.sheetsData = {};
        for (const s of sheets) {
            const title = s.properties.title;
            showLoading('è®€å–ï¼š' + title);
            const [dataRes, notesRes] = await Promise.all([
                fetch(CONFIG.SHEETS_API + '/' + id + '/values/' + encodeURIComponent(title) + '?key=' + key),
                fetch(CONFIG.SHEETS_API + '/' + id + '?ranges=' + encodeURIComponent(title) + '&fields=sheets(data(rowData(values(note))))&key=' + key)
            ]);
            if (dataRes.ok) {
                const data = await dataRes.json();
                const notes = notesRes.ok ? extractNotes(await notesRes.json()) : {};
                state.sheetsData[title] = { values: data.values || [], notes };
            }
        }
        updatePreview();
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('analyzeError', 'è®€å–å¤±æ•—ï¼š' + e.message);
    }
}

function extractSheetId(url) {
    const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/) || url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : null;
}

function extractNotes(data) {
    const notes = {};
    const rows = data?.sheets?.[0]?.data?.[0]?.rowData;
    if (!rows) return notes;
    rows.forEach((r, ri) => r.values?.forEach((c, ci) => { if (c.note) notes[ri + '-' + ci] = c.note; }));
    return notes;
}

function displaySheetTabs(sheets) {
    const el = document.getElementById('sheetTabs');
    el.innerHTML = sheets.map(s => '<button class="tag selected" onclick="toggleSheet(this,\'' + escapeHtml(s.properties.title) + '\')">' + escapeHtml(s.properties.title) + '</button>').join('');
    document.getElementById('sheetSelector').style.display = 'block';
    state.selectedSheets = new Set(sheets.map(s => s.properties.title));
}

function toggleSheet(btn, name) {
    btn.classList.toggle('selected');
    state.selectedSheets.has(name) ? state.selectedSheets.delete(name) : state.selectedSheets.add(name);
    updatePreview();
}

function updatePreview() {
    const box = document.getElementById('previewBox');
    const content = document.getElementById('previewContent');
    const stats = document.getElementById('previewStats');
    if (!state.sheetsData || !state.selectedSheets.size) { box.style.display = 'none'; state.charText = ''; return; }
    let html = '', cells = 0, notes = 0;
    state.selectedSheets.forEach(name => {
        const s = state.sheetsData[name];
        if (!s) return;
        cells += s.values.flat().filter(v => v).length;
        notes += Object.keys(s.notes).length;
        html += '<div class="char-card"><h4>ğŸ“‹ ' + escapeHtml(name) + '</h4><div style="font-size:0.8rem; color:var(--text-secondary); max-height:80px; overflow:hidden;">' + s.values.slice(0, 8).map(r => escapeHtml(r.filter(c => c).join(' | ').substring(0, 120))).join('<br>') + '</div>' + (Object.keys(s.notes).length ? '<div class="notes">' + Object.values(s.notes).slice(0, 2).map(n => escapeHtml(n.substring(0, 60))).join(' / ') + '</div>' : '') + '</div>';
    });
    content.innerHTML = html;
    stats.textContent = state.selectedSheets.size + ' è§’è‰² Â· ' + cells + ' æ ¼ Â· ' + notes + ' å‚™è¨»';
    box.style.display = 'block';
    state.charText = buildCharText();
}

function buildCharText() {
    if (!state.sheetsData) return '';
    let t = '';
    state.selectedSheets.forEach(name => {
        const s = state.sheetsData[name];
        if (!s) return;
        t += '\n\n===== è§’è‰²ï¼š' + name + ' =====\n\n';
        s.values.forEach((row, ri) => {
            const rt = row.map((c, ci) => { let x = c || ''; const n = s.notes[ri + '-' + ci]; if (n) x += 'ã€å‚™è¨»ï¼š' + n + 'ã€‘'; return x; }).filter(c => c).join('\t');
            if (rt.trim()) t += rt + '\n';
        });
    });
    return t;
}

// ===== è§’å¡åˆ†æ =====
window.analyzeCharacters = async function() {
    try {
        const key = getKey('gemini');
        const text = document.getElementById('textInput').value || state.charText;
        if (!text) {
            showError('analyzeError', 'è«‹å…ˆè¼¸å…¥è§’å¡è³‡æ–™');
            return;
        }

        showLoading('æ­£åœ¨é€²è¡Œè¦å‰‡æ›¸ç´šæ•¸æ“šåˆ†æ...');
        hideError('analyzeError');

        // æå–é—œéµå­—æœå°‹ç›¸é—œè¦å‰‡
        const keywords = extractKeywords(text);
        const relatedRules = searchRules(keywords);
        let ruleContext = "";
        if (relatedRules.length > 0) {
            ruleContext = "\n\nã€åƒè€ƒè¦å‰‡æ¢ç›®ã€‘\n" + relatedRules.map(r =>
                `[${r.filename}] ${r.content.substring(0, 300)}`
            ).join('\n');
        }

        // è¨ˆç®—è§’è‰²æ•¸é‡ï¼ˆç”¨æ–¼æç¤º AIï¼‰
        const charCount = (text.match(/===== è§’è‰²ï¼š/g) || []).length ||
                          (text.match(/è§’è‰²å/g) || []).length || 1;

        const prompt = `ä½ æ˜¯ã€Šç„¡é™ææ€–ã€‹TRPG 2.35 ç‰ˆçš„ã€æ•¸æ“šæµè¦å‰‡å°ˆå®¶ STã€‘ã€‚
è«‹åš´æ ¼ä¾æ“šéŠæˆ²æ©Ÿåˆ¶ï¼ˆDPéª°æ± ã€é™„åŠ æˆåŠŸã€ä¸‰è±å…ï¼‰åˆ†æè§’è‰²å¡ï¼Œæ¡ç”¨ã€ç›¸å°åˆ†ææ¨¡å¼ã€‘ã€‚

âš ï¸ **é‡è¦**ï¼šé€™ä»½è³‡æ–™åŒ…å« ${charCount} å€‹è§’è‰²ï¼Œè«‹åˆ†æ**æ‰€æœ‰è§’è‰²**ï¼Œä¸è¦éºæ¼ä»»ä½•ä¸€å€‹ï¼

ã€ç©å®¶æˆ°åŠ›æ¨™æº–è¡¨ã€‘ï¼ˆç”¨æ–¼åƒè€ƒï¼Œä½†ä¸æ˜¯è©•ç´šä¾æ“šï¼‰
${JSON.stringify(PLAYER_STANDARDS, null, 2)}

ã€åˆ†ææ¨¡å¼ï¼šç›¸å°åˆ†æã€‘
æœ¬æ¬¡åˆ†ææ¡ç”¨ã€ŒéšŠä¼å…§éƒ¨æ¯”è¼ƒã€æ¨¡å¼ï¼Œè€Œéçµ•å°è©•ç´šï¼š

1. **æˆ°é¬¥æ•¸æ“šæå–**ï¼ˆæ‰€æœ‰è§’è‰²ï¼‰ï¼š
   - æ”»æ“Š DPï¼ˆéª°æ± ï¼‰= å±¬æ€§ + æŠ€èƒ½ + è£å‚™åŠ æˆ
   - é™„åŠ æˆåŠŸæ•¸ï¼ˆæ¯ 1 é»é™„åŠ æˆåŠŸ â‰ˆ 3 DPï¼Œéœ€æ›ç®—ï¼‰
   - å‚·å®³ä¸Šé™ = æ­¦å™¨å‚·å®³ + å‚·å®³åŠ æˆ
   - é˜²ç¦¦å€¼ = åŸºç¤é˜²ç¦¦ + è­·ç”² + æ¸›å‚·
   - ä¸‰è±å…ï¼šå¼·éŸŒï¼ˆFortitudeï¼‰ã€åå°„ï¼ˆReflexï¼‰ã€æ„å¿—ï¼ˆWillï¼‰
   - HPã€å…ˆæ”»

2. **éšŠä¼å…§éƒ¨æ¯”è¼ƒ**ï¼š
   - è¨ˆç®—æ¯é …æ•¸æ“šçš„éšŠä¼å¹³å‡å€¼
   - æ‰¾å‡ºæ¯å€‹è§’è‰²çš„ç›¸å°å¼·é …ï¼ˆé«˜æ–¼å¹³å‡ 20% ä»¥ä¸Šï¼‰
   - æ‰¾å‡ºæ¯å€‹è§’è‰²çš„ç›¸å°å¼±é …ï¼ˆä½æ–¼å¹³å‡ 20% ä»¥ä¸Šï¼‰
   - çµ¦å‡ºç›¸å°è©•ç´šï¼š
     * "éšŠä¼ç¬¬ä¸€æ¢¯éšŠ" = å¤šé …æŒ‡æ¨™é ˜å…ˆ
     * "éšŠä¼æ ¸å¿ƒ" = å‡è¡¡ç™¼å±•
     * "éšŠä¼æ”¯æ´" = ç‰¹å®šé ˜åŸŸçªå‡º
     * "éœ€è¦è£œå¼·" = å¤šé …æŒ‡æ¨™è½å¾Œ

3. **å¿…æ®ºæŠ€èˆ‡é…åˆ**ï¼š
   - æ‰¾å‡ºè¡€çµ±æŠ€èƒ½ã€å‚³å¥‡æ­¦å™¨æ•ˆæœ
   - åˆ†æè§’è‰²é–“çš„é…åˆæ½›åŠ›

4. **éšŠä¼ BOSS æˆ°æ¨¡æ“¬**ï¼š
   - è¨ˆç®—å…¨éšŠç¸½ DPS
   - å°ç…§æ€ªç‰©è¡€é‡è¡¨ï¼Œæ¨ç®—èƒ½æ“Šæ®ºçš„æœ€é«˜ BOSS ç­‰ç´š

ã€è§’è‰²è³‡æ–™ã€‘ï¼ˆå…± ${charCount} å€‹è§’è‰²ï¼‰
${text.substring(0, 18000)}
${ruleContext}

ã€è¼¸å‡º JSON æ ¼å¼ã€‘
âš ï¸ å¿…é ˆè¼¸å‡º**æ‰€æœ‰ ${charCount} å€‹è§’è‰²**çš„åˆ†æçµæœï¼

\`\`\`json
{
  "teamStats": {
    "avgAttackDP": "éšŠä¼å¹³å‡æ”»æ“ŠDP",
    "avgDefense": "éšŠä¼å¹³å‡é˜²ç¦¦",
    "avgDamageCap": "éšŠä¼å¹³å‡å‚·å®³ä¸Šé™",
    "avgHP": "éšŠä¼å¹³å‡HP",
    "avgSaves": "éšŠä¼å¹³å‡è±å…"
  },
  "characters": [
    {
      "name": "è§’è‰²å",
      "relativeRank": "éšŠä¼ç¬¬ä¸€æ¢¯éšŠ/éšŠä¼æ ¸å¿ƒ/éšŠä¼æ”¯æ´/éœ€è¦è£œå¼·",
      "combatStats": {
        "attackDP": "æ•¸å€¼",
        "autoSuccess": "é™„åŠ æˆåŠŸæ•¸",
        "effectiveAttack": "æ›ç®—å¾Œç¸½æ”»æ“ŠåŠ›",
        "damageCap": "å‚·å®³ä¸Šé™",
        "defense": "é˜²ç¦¦å€¼",
        "damageReduction": "æ¸›å‚·å€¼",
        "saves": {
          "fortitude": "å¼·éŸŒè±å…",
          "reflex": "åå°„è±å…",
          "will": "æ„å¿—è±å…"
        },
        "hp": "ç”Ÿå‘½å€¼",
        "initiative": "å…ˆæ”»"
      },
      "relativeStrengths": [
        {"stat": "æ”»æ“ŠåŠ›", "value": "æ•¸å€¼", "vsAvg": "+X% é«˜æ–¼å¹³å‡"}
      ],
      "relativeWeaknesses": [
        {"stat": "é˜²ç¦¦", "value": "æ•¸å€¼", "vsAvg": "-X% ä½æ–¼å¹³å‡"}
      ],
      "killerMoves": [
        {"name": "æŠ€èƒ½å", "damage": "å‚·å®³æè¿°", "condition": "ä½¿ç”¨æ¢ä»¶"}
      ],
      "roleAnalysis": "åœ¨éšŠä¼ä¸­çš„å®šä½èˆ‡å»ºè­°",
      "synergiesWithTeam": ["èˆ‡èª°é…åˆæ•ˆæœæœ€å¥½"]
    }
  ],
  "teamAnalysis": {
    "totalDPS": "å…¨éšŠæ¯å›åˆç¸½å‚·å®³",
    "burstDamage": "å…¨éšŠçˆ†ç™¼å‚·å®³",
    "maxBeatableBossRank": "å¯æ“Šæ•—çš„æœ€é«˜ BOSS ç­‰ç´š",
    "estimatedKillRounds": {
      "D": "X å›åˆ",
      "C": "X å›åˆ",
      "B": "X å›åˆ"
    },
    "tankSurvival": "å¦å…‹ç”Ÿå­˜è©•ä¼°",
    "teamBalance": "éšŠä¼å¹³è¡¡æ€§è©•ä¼°ï¼ˆæ˜¯å¦åç§‘ï¼‰",
    "criticalWeakness": "éšŠä¼è‡´å‘½å¼±é»",
    "composition": "éšŠä¼çµ„æˆåˆ†æ",
    "recommendedStrategy": "æ¨è–¦æˆ°è¡“"
  }
}
\`\`\`

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œæ•¸å€¼ç›¡é‡çµ¦å‡ºå…·é«”æ•¸å­—ã€‚**å‹™å¿…åˆ†ææ‰€æœ‰ ${charCount} å€‹è§’è‰²ï¼**`;

        const res = await fetch(`${CONFIG.GEMINI_API}?key=${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!raw) throw new Error('AI ç„¡å›æ‡‰');

        // è§£æ JSON
        const jsonMatch = raw.match(/```json\s*([\s\S]*?)\s*```/);
        let result;
        try {
            result = JSON.parse(jsonMatch ? jsonMatch[1] : raw);
        } catch {
            // JSON è§£æå¤±æ•—ï¼Œé¡¯ç¤ºåŸå§‹æ–‡å­—
            document.getElementById('resultsContainer').innerHTML = `
                <div style="white-space: pre-wrap; background: var(--bg-deep); padding: 20px; border-radius: var(--radius-sm);">
                    ${escapeHtml(raw)}
                </div>
            `;
            document.getElementById('analyzeResults').style.display = 'block';
            hideLoading();
            return;
        }

        state.lastAnalysis = result;
        saveHistory(result);

        // æ¸²æŸ“é›·é”åœ–ï¼ˆç›¸å°ç‰ˆæœ¬ï¼‰
        renderRelativeRadar(result.characters, result.teamStats);

        // æ¸²æŸ“è§’è‰²å¡ç‰‡ï¼ˆç›¸å°ç‰ˆæœ¬ï¼‰
        let html = '';
        result.characters?.forEach(char => {
            html += renderRelativeCharCard(char, result.teamStats);
        });

        // æ¸²æŸ“éšŠä¼åˆ†æ
        if (result.teamAnalysis) {
            html += renderTeamCombatAnalysis(result.teamAnalysis);
        }

        document.getElementById('resultsContainer').innerHTML = html;
        document.getElementById('analyzeResults').style.display = 'block';
        document.getElementById('analyzeResults').scrollIntoView({ behavior: 'smooth' });
        hideLoading();

    } catch(e) {
        hideLoading();
        console.error('åˆ†æéŒ¯èª¤:', e);
        showError('analyzeError', 'åˆ†æå¤±æ•—: ' + e.message);
    }
};

function buildPrompt(charData, rules) {
    let rc = '';
    if (rules.length) {
        rc = '\n\n## ç›¸é—œè¦å‰‡\n';
        let len = 0;
        for (const r of rules) {
            const t = 'ã€' + (r.filename || r.category) + 'ã€‘\n' + r.content.substring(0, 500) + '\n\n';
            if (len + t.length > CONFIG.MAX_RULES) break;
            rc += t;
            len += t.length;
        }
    }
    return 'ä½ æ˜¯ç„¡é™ææ€– TRPG è³‡æ·± STï¼Œè«‹åˆ†æè§’è‰²å¡ã€‚\n\n## è§’è‰²è³‡æ–™\n' + charData.substring(0, 20000) + rc + '\n\nè«‹ç”¨ JSON å›è¦†ï¼š\n```json\n{"characters":[{"name":"è§’è‰²å","powerLevel":"S/A/B/C/D","summary":"å®šä½","stats":{"offense":1-10,"defense":1-10,"mobility":1-10,"control":1-10,"sustain":1-10,"utility":1-10},"coreAbilities":["èƒ½åŠ›"],"warnings":["âš ï¸è­¦å‘Š"],"weaknesses":["å¼±é»"],"suggestions":["å»ºè­°"],"relatedRules":["é—œéµå­—"]}],"teamSummary":{"overallPower":"è©•ä¼°","composition":"çµ„æˆ","synergies":["combo"],"gaps":["ç¼ºå¤±"]}}\n```\nè©•ç´šï¼šS=ç§’æ®ºBOSS, A=é«˜å„ªåŒ–, B=æœ‰å¼·é …, C=å‡è¡¡, D=æ–°æ‰‹\nç”¨ç¹é«”ä¸­æ–‡ï¼Œæ³¨æ„å‚™è¨»ä¸­çš„éš±è—èƒ½åŠ›ã€‚';
}

// çµ±ä¸€çš„ Gemini API å‘¼å«å‡½å¼ï¼ˆå…¼å®¹èˆŠç‰ˆç°½åï¼‰
async function callGemini(prompt, keyOrOptions) {
    // å…¼å®¹èˆŠçš„ç°½å callGemini(prompt, key) å’Œæ–°çš„ç°½å callGemini(prompt, options)
    let key;
    let options = {};

    if (typeof keyOrOptions === 'string') {
        // èˆŠçš„èª¿ç”¨æ–¹å¼ï¼šcallGemini(prompt, key)
        key = keyOrOptions;
    } else {
        // æ–°çš„èª¿ç”¨æ–¹å¼ï¼šcallGemini(prompt, options)
        options = keyOrOptions || {};
        key = getKey('gemini');
    }

    const response = await fetch(`${CONFIG.GEMINI_API}?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: options.temperature || 0.7,
                maxOutputTokens: options.maxTokens || 8192
            }
        })
    });

    if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'API å‘¼å«å¤±æ•—');
    }

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!text) throw new Error('AI ç„¡å›æ‡‰');

    // å¦‚æœæœŸæœ› JSONï¼Œå˜—è©¦è§£æ
    if (options.expectJson) {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
            try {
                return JSON.parse(jsonMatch[1]);
            } catch (e) {
                return { _raw: text };
            }
        }
        try {
            return JSON.parse(text);
        } catch {
            return { _raw: text };
        }
    }

    // èˆŠçš„è¡Œç‚ºï¼šç¸½æ˜¯å˜—è©¦è§£æ JSON
    const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
        try {
            return JSON.parse(jsonMatch[1]);
        } catch (e) {
            return { raw: text };
        }
    }
    try {
        return JSON.parse(text);
    } catch {
        return { raw: text };
    }
}

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    const section = document.getElementById('analyzeResults');
    if (data.raw) { container.innerHTML = '<div style="white-space:pre-wrap;">' + escapeHtml(data.raw) + '</div>'; section.style.display = 'block'; return; }
    if (data.characters?.length) renderRadar(data.characters);
    let html = '';
    data.characters?.forEach(c => { html += renderChar(c); });
    if (data.teamSummary) html += renderTeam(data.teamSummary);
    container.innerHTML = html;
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
    updateTrackSelect(data.characters);
}

function renderChar(c) {
    const lv = c.powerLevel?.charAt(0) || 'C';
    return '<div class="result-card"><div class="result-header"><span class="result-name">' + escapeHtml(c.name || '?') + '</span><span class="power-level ' + lv + '">' + escapeHtml(c.powerLevel || '?') + '</span></div><div class="result-body"><p style="color:var(--text-secondary); margin-bottom:12px;">' + escapeHtml(c.summary || '') + '</p>' + (c.coreAbilities?.length ? '<div class="result-section"><h4>âš”ï¸ æ ¸å¿ƒèƒ½åŠ›</h4><ul>' + c.coreAbilities.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul></div>' : '') + (c.warnings?.length ? '<div class="result-section"><h4>âš ï¸ STè­¦å‘Š</h4><ul>' + c.warnings.map(w => '<li class="warning">' + escapeHtml(w) + '</li>').join('') + '</ul></div>' : '') + (c.weaknesses?.length ? '<div class="result-section"><h4>ğŸ¯ å¼±é»</h4><ul>' + c.weaknesses.map(w => '<li class="weakness">' + escapeHtml(w) + '</li>').join('') + '</ul></div>' : '') + (c.suggestions?.length ? '<div class="result-section"><h4>ğŸ’¡ å»ºè­°</h4><ul>' + c.suggestions.map(s => '<li class="success">' + escapeHtml(s) + '</li>').join('') + '</ul></div>' : '') + (c.relatedRules?.length ? '<div class="rule-tags">' + c.relatedRules.map(r => '<button class="rule-tag" onclick="window.open(\'index.html?q=' + encodeURIComponent(r) + '\',\'_blank\')">' + escapeHtml(r) + '</button>').join('') + '</div>' : '') + '</div></div>';
}

function renderTeam(s) {
    return '<div class="result-card" style="border-top:3px solid var(--accent-gold);"><div class="result-header" style="background:linear-gradient(135deg,rgba(212,160,32,0.15),var(--bg-card));"><span class="result-name">ğŸ“Š éšŠä¼ç¸½è©•</span></div><div class="result-body"><p style="margin-bottom:8px;"><strong>æ•´é«”ï¼š</strong>' + escapeHtml(s.overallPower || '') + '</p><p style="margin-bottom:12px;"><strong>çµ„æˆï¼š</strong>' + escapeHtml(s.composition || '') + '</p>' + (s.synergies?.length ? '<div class="result-section"><h4>ğŸ”— Combo</h4><ul>' + s.synergies.map(x => '<li>' + escapeHtml(x) + '</li>').join('') + '</ul></div>' : '') + (s.gaps?.length ? '<div class="result-section"><h4>âš¡ è£œå¼·</h4><ul>' + s.gaps.map(x => '<li class="weakness">' + escapeHtml(x) + '</li>').join('') + '</ul></div>' : '') + '</div></div>';
}

function renderRadar(chars) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    if (state.radarChart) state.radarChart.destroy();
    const colors = ['rgba(196,30,58,0.7)', 'rgba(212,160,32,0.7)', 'rgba(155,89,182,0.7)', 'rgba(52,152,219,0.7)', 'rgba(46,213,115,0.7)', 'rgba(255,107,53,0.7)'];
    const datasets = chars.slice(0, 6).map((c, i) => ({
        label: c.name || 'è§’è‰²' + (i + 1),
        data: [c.stats?.offense || 5, c.stats?.defense || 5, c.stats?.mobility || 5, c.stats?.control || 5, c.stats?.sustain || 5, c.stats?.utility || 5],
        borderColor: colors[i],
        backgroundColor: colors[i].replace('0.7', '0.2'),
        borderWidth: 2,
        pointRadius: 3,
    }));
    state.radarChart = new Chart(ctx, {
        type: 'radar',
        data: { labels: ['è¼¸å‡º', 'é˜²ç¦¦', 'æ©Ÿå‹•', 'æ§åˆ¶', 'çºŒèˆª', 'åŠŸèƒ½'], datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { min: 0, max: 10, ticks: { stepSize: 2, color: '#606070' }, grid: { color: '#333340' }, pointLabels: { color: '#a0a0b0', font: { size: 11 } } } },
            plugins: { legend: { position: 'bottom', labels: { color: '#e8e8f0', padding: 12, font: { size: 11 } } } }
        }
    });
}

// ===== æ–°ç‰ˆæˆ°é¬¥æ•¸æ“šæ¸²æŸ“å‡½å¼ =====

// æ¸²æŸ“æˆ°é¬¥æ•¸æ“šé›·é”åœ–
function renderCombatRadar(chars) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    if (state.radarChart) state.radarChart.destroy();

    const colors = [
        'rgba(196, 30, 58, 0.6)',
        'rgba(212, 160, 32, 0.6)',
        'rgba(52, 152, 219, 0.6)',
        'rgba(46, 213, 115, 0.6)',
        'rgba(155, 89, 182, 0.6)'
    ];

    // å°‡æ•¸æ“šæ­£è¦åŒ–åˆ° 0-10 åˆ†æ•¸
    function normalize(value, max) {
        const num = parseInt(value) || 0;
        return Math.min(10, Math.round((num / max) * 10));
    }

    const datasets = chars.slice(0, 5).map((c, i) => {
        const cs = c.combatStats || {};
        const saves = cs.saves || {};

        return {
            label: c.name,
            data: [
                normalize(cs.effectiveAttack || cs.attackDP, 130),  // æ”»æ“Š
                normalize(cs.defense, 96),                          // é˜²ç¦¦
                normalize(cs.damageCap, 60),                        // çˆ†ç™¼
                normalize(saves.will || saves.fortitude, 56),       // è±å…
                normalize(cs.hp, 5000),                             // ç”Ÿå­˜
                5  // åŠŸèƒ½æ€§ï¼ˆå›ºå®šå€¼ï¼Œå¯æ ¹æ“šæŠ€èƒ½èª¿æ•´ï¼‰
            ],
            backgroundColor: colors[i % colors.length],
            borderColor: colors[i % colors.length].replace('0.6', '1'),
            borderWidth: 2
        };
    });

    state.radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['æ”»æ“ŠDP', 'é˜²ç¦¦', 'çˆ†ç™¼å‚·å®³', 'è±å…', 'ç”Ÿå­˜åŠ›', 'åŠŸèƒ½æ€§'],
            datasets
        },
        options: {
            scales: {
                r: {
                    min: 0,
                    max: 10,
                    ticks: { display: false },
                    grid: { color: '#333' },
                    pointLabels: { color: '#aaa', font: { size: 11 } }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#ccc', padding: 15 }
                }
            }
        }
    });
}

// æ¸²æŸ“è§’è‰²æˆ°é¬¥å¡ç‰‡
function renderCombatCharCard(char) {
    const cs = char.combatStats || {};
    const saves = cs.saves || {};
    const rank = char.assessedRank || 'C';

    // è©•ç´šé¡è‰²
    const rankColors = {
        'S': 'linear-gradient(135deg, #ffd700, #ff8c00)',
        'A': 'linear-gradient(135deg, #c41e3a, #8b1528)',
        'B': 'linear-gradient(135deg, #9b59b6, #6c3483)',
        'C': 'linear-gradient(135deg, #3498db, #2471a3)',
        'D': 'linear-gradient(135deg, #27ae60, #1e8449)'
    };

    let html = `
        <div class="result-card" style="margin-bottom: 20px;">
            <div class="result-header">
                <span class="result-name">${escapeHtml(char.name)}</span>
                <span style="padding: 6px 16px; border-radius: 20px; font-weight: 900; font-family: 'Orbitron', sans-serif; background: ${rankColors[rank] || rankColors['C']}; color: ${rank === 'S' ? '#000' : '#fff'};">
                    ${rank}ç´š
                </span>
            </div>
            <div class="result-body">

                <!-- æˆ°é¬¥æ•¸æ“šå€ -->
                <div style="background: var(--bg-elevated); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <h4 style="color: var(--accent-ember); margin-bottom: 12px;">âš”ï¸ æˆ°é¬¥æ•¸æ“š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center;">
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">æ”»æ“ŠDP</div>
                            <div style="font-weight: bold; color: var(--accent-gold); font-size: 1.1rem;">${cs.attackDP || '?'}</div>
                            ${cs.autoSuccess ? `<div style="font-size: 0.7rem; color: var(--accent-ember);">+${cs.autoSuccess} é™„åŠ </div>` : ''}
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">æœ‰æ•ˆæ”»æ“Š</div>
                            <div style="font-weight: bold; color: var(--danger); font-size: 1.1rem;">${cs.effectiveAttack || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å‚·å®³ä¸Šé™</div>
                            <div style="font-weight: bold; color: var(--accent-ember);">${cs.damageCap || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">é˜²ç¦¦</div>
                            <div style="font-weight: bold; color: var(--accent-cyan);">${cs.defense || '?'}</div>
                            ${cs.damageReduction ? `<div style="font-size: 0.7rem; color: var(--text-dim);">æ¸›å‚· ${cs.damageReduction}</div>` : ''}
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">HP</div>
                            <div style="font-weight: bold; color: var(--success);">${cs.hp || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å…ˆæ”»</div>
                            <div style="font-weight: bold; color: var(--text-primary);">${cs.initiative || '?'}</div>
                        </div>
                    </div>

                    <!-- ä¸‰è±å… -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 8px;">ä¸‰è±å…</div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <span style="color: var(--accent-ember);">å¼·éŸŒ ${saves.fortitude || '?'}</span>
                            <span style="color: var(--accent-cyan);">åå°„ ${saves.reflex || '?'}</span>
                            <span style="color: var(--accent-purple);">æ„å¿— ${saves.will || '?'}</span>
                        </div>
                    </div>
                </div>
    `;

    // å¿…æ®ºæŠ€
    if (char.killerMoves && char.killerMoves.length) {
        html += `
            <div class="result-section">
                <h4>ğŸ”¥ å¿…æ®ºæŠ€</h4>
                <ul>
        `;
        char.killerMoves.forEach(move => {
            html += `
                <li style="border-left-color: var(--danger); background: rgba(255, 71, 87, 0.1);">
                    <strong style="color: var(--accent-ember);">${escapeHtml(move.name)}</strong>
                    <div style="font-size: 0.9rem; margin-top: 4px;">${escapeHtml(move.damage)}</div>
                    ${move.condition ? `<div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 4px;">ğŸ“‹ ${escapeHtml(move.condition)}</div>` : ''}
                </li>
            `;
        });
        html += `</ul></div>`;
    }

    // å¼±é»
    if (char.weaknesses && char.weaknesses.length) {
        html += `
            <div class="result-section">
                <h4>ğŸ¯ å¼±é»</h4>
                <ul>${char.weaknesses.map(w => `<li class="weakness">${escapeHtml(w)}</li>`).join('')}</ul>
            </div>
        `;
    }

    // ST è­¦å‘Š
    if (char.warnings && char.warnings.length) {
        html += `
            <div class="result-section">
                <h4>âš ï¸ ST è­¦å‘Š</h4>
                <ul>${char.warnings.map(w => `<li class="warning">${escapeHtml(w)}</li>`).join('')}</ul>
            </div>
        `;
    }

    // æˆ°è¡“åˆ†æ
    if (char.roleAnalysis) {
        html += `
            <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm); margin-top: 15px;">
                <strong style="color: var(--accent-gold);">ğŸ’¡ æˆ°è¡“å®šä½ï¼š</strong>
                <span style="color: var(--text-secondary);">${escapeHtml(char.roleAnalysis)}</span>
            </div>
        `;
    }

    html += `</div></div>`;
    return html;
}

// æ¸²æŸ“éšŠä¼æˆ°é¬¥åˆ†æ
function renderTeamCombatAnalysis(team) {
    const maxRank = team.maxBeatableBossRank || 'C';
    const rankColors = { 'S': '#ffd700', 'A': '#c41e3a', 'B': '#9b59b6', 'C': '#3498db', 'D': '#27ae60' };

    let html = `
        <div class="result-card" style="border-top: 3px solid var(--accent-gold);">
            <div class="result-header" style="background: linear-gradient(135deg, rgba(212, 160, 32, 0.15), var(--bg-card));">
                <span class="result-name">ğŸ“Š éšŠä¼æˆ°é¬¥åˆ†æ</span>
            </div>
            <div class="result-body">

                <!-- BOSS æˆ°æ¨¡æ“¬ -->
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-sm); margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 8px;">å¯æ“Šæ•—æœ€é«˜ BOSS ç­‰ç´š</div>
                    <div style="font-size: 2.5rem; font-weight: 900; font-family: 'Orbitron', sans-serif; color: ${rankColors[maxRank] || '#3498db'};">
                        ${maxRank}ç´š
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.8rem;">æ¯å›åˆ DPS</div>
                            <div style="font-weight: bold; color: var(--accent-ember);">${team.totalDPS || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.8rem;">çˆ†ç™¼å‚·å®³</div>
                            <div style="font-weight: bold; color: var(--danger);">${team.burstDamage || '?'}</div>
                        </div>
                    </div>
                </div>

                <!-- æ“Šæ®ºå›åˆé ä¼° -->
                ${team.estimatedKillRounds ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--accent-gold); margin-bottom: 10px;">â±ï¸ æ“Šæ®ºå›åˆé ä¼°</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${Object.entries(team.estimatedKillRounds).map(([rank, rounds]) => `
                            <div style="background: var(--bg-deep); padding: 10px 15px; border-radius: var(--radius-sm); text-align: center; flex: 1; min-width: 80px;">
                                <div style="color: ${rankColors[rank]}; font-weight: bold;">${rank}ç´š BOSS</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">${rounds}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- å¦å…‹ç”Ÿå­˜è©•ä¼° -->
                ${team.tankSurvival ? `
                <div style="background: rgba(0, 212, 170, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border-left: 3px solid var(--accent-cyan);">
                    <strong style="color: var(--accent-cyan);">ğŸ›¡ï¸ å¦å…‹ç”Ÿå­˜è©•ä¼°ï¼š</strong>
                    <span style="color: var(--text-secondary);">${escapeHtml(team.tankSurvival)}</span>
                </div>
                ` : ''}

                <!-- è‡´å‘½å¼±é» -->
                ${team.criticalWeakness ? `
                <div style="background: rgba(255, 71, 87, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border-left: 3px solid var(--danger);">
                    <strong style="color: var(--danger);">âš ï¸ éšŠä¼è‡´å‘½å¼±é»ï¼š</strong>
                    <span style="color: var(--text-secondary);">${escapeHtml(team.criticalWeakness)}</span>
                </div>
                ` : ''}

                <!-- éšŠä¼çµ„æˆ -->
                ${team.composition ? `
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--accent-gold);">ğŸ‘¥ éšŠä¼çµ„æˆï¼š</strong>
                    <span style="color: var(--text-secondary);">${escapeHtml(team.composition)}</span>
                </div>
                ` : ''}

                <!-- éšŠä¼å¹³è¡¡æ€§ -->
                ${team.teamBalance ? `
                <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border-left: 3px solid var(--accent-blue);">
                    <strong style="color: var(--accent-blue);">âš–ï¸ éšŠä¼å¹³è¡¡æ€§ï¼š</strong>
                    <span style="color: var(--text-secondary);">${escapeHtml(team.teamBalance)}</span>
                </div>
                ` : ''}

                <!-- é…åˆæŠ€ -->
                ${team.synergies && team.synergies.length ? `
                <div>
                    <h4 style="color: var(--accent-purple); margin-bottom: 10px;">ğŸ”— éšŠä¼é…åˆæŠ€</h4>
                    <ul style="list-style: none;">
                        ${team.synergies.map(s => `
                            <li style="padding: 8px 12px; background: var(--bg-deep); border-radius: var(--radius-sm); margin-bottom: 6px; border-left: 3px solid var(--accent-purple);">
                                ${escapeHtml(s)}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                <!-- æ¨è–¦æˆ°è¡“ -->
                ${team.recommendedStrategy ? `
                <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm); margin-top: 15px;">
                    <strong style="color: var(--accent-gold);">ğŸ¯ æ¨è–¦æˆ°è¡“ï¼š</strong>
                    <div style="color: var(--text-secondary); margin-top: 8px; line-height: 1.6;">${escapeHtml(team.recommendedStrategy)}</div>
                </div>
                ` : ''}

            </div>
        </div>
    `;

    return html;
}

// ===== ç›¸å°åˆ†ææ¸²æŸ“å‡½å¼ =====

// æ¸²æŸ“ç›¸å°åˆ†æé›·é”åœ–
function renderRelativeRadar(chars, teamStats) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    if (state.radarChart) state.radarChart.destroy();

    const colors = [
        'rgba(196, 30, 58, 0.6)',
        'rgba(212, 160, 32, 0.6)',
        'rgba(52, 152, 219, 0.6)',
        'rgba(46, 213, 115, 0.6)',
        'rgba(155, 89, 182, 0.6)',
        'rgba(255, 107, 53, 0.6)'
    ];

    // å°‡æ•¸æ“šæ­£è¦åŒ–åˆ° 0-10 åˆ†æ•¸ï¼ˆç›¸å°æ–¼éšŠä¼å¹³å‡ï¼‰
    function normalizeRelative(value, avg) {
        if (!avg || avg === 0) return 5;
        const num = parseInt(value) || 0;
        const ratio = num / avg;
        // å¹³å‡å€¼ç‚º 5ï¼Œæ¯åé›¢ 20% å¢æ¸› 1 åˆ†
        return Math.max(0, Math.min(10, 5 + (ratio - 1) * 10));
    }

    // è§£æå¹³å‡å€¼
    const avgAtk = parseInt(teamStats?.avgAttackDP) || 50;
    const avgDef = parseInt(teamStats?.avgDefense) || 30;
    const avgDmg = parseInt(teamStats?.avgDamageCap) || 20;
    const avgHP = parseInt(teamStats?.avgHP) || 1000;
    const avgSave = parseInt(teamStats?.avgSaves) || 20;

    const datasets = chars.slice(0, 6).map((c, i) => {
        const cs = c.combatStats || {};
        const saves = cs.saves || {};
        const avgCharSave = Math.round(
            ((parseInt(saves.fortitude) || 0) +
             (parseInt(saves.reflex) || 0) +
             (parseInt(saves.will) || 0)) / 3
        );

        return {
            label: c.name,
            data: [
                normalizeRelative(cs.effectiveAttack || cs.attackDP, avgAtk),
                normalizeRelative(cs.defense, avgDef),
                normalizeRelative(cs.damageCap, avgDmg),
                normalizeRelative(avgCharSave, avgSave),
                normalizeRelative(cs.hp, avgHP),
                5  // åŠŸèƒ½æ€§ï¼ˆå›ºå®šå€¼ï¼‰
            ],
            backgroundColor: colors[i % colors.length],
            borderColor: colors[i % colors.length].replace('0.6', '1'),
            borderWidth: 2
        };
    });

    state.radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['æ”»æ“ŠåŠ›', 'é˜²ç¦¦', 'çˆ†ç™¼å‚·å®³', 'è±å…', 'ç”Ÿå­˜åŠ›', 'åŠŸèƒ½æ€§'],
            datasets
        },
        options: {
            scales: {
                r: {
                    min: 0,
                    max: 10,
                    ticks: {
                        stepSize: 2,
                        callback: function(value) {
                            if (value === 5) return 'å¹³å‡';
                            if (value === 10) return 'é ‚å°–';
                            if (value === 0) return 'å¼±å‹¢';
                            return '';
                        },
                        color: '#606070'
                    },
                    grid: { color: '#333' },
                    pointLabels: { color: '#aaa', font: { size: 11 } }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#ccc', padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const labels = ['é ä½æ–¼å¹³å‡', 'ä½æ–¼å¹³å‡', 'ç•¥ä½æ–¼å¹³å‡', 'æ¥è¿‘å¹³å‡', 'ç•¥é«˜æ–¼å¹³å‡', 'é«˜æ–¼å¹³å‡', 'é é«˜æ–¼å¹³å‡'];
                            const val = Math.round(context.parsed.r);
                            const idx = Math.min(6, Math.max(0, Math.floor((val / 10) * 6)));
                            return context.dataset.label + ': ' + labels[idx];
                        }
                    }
                }
            }
        }
    });
}

// æ¸²æŸ“ç›¸å°åˆ†æè§’è‰²å¡ç‰‡
function renderRelativeCharCard(char, teamStats) {
    const cs = char.combatStats || {};
    const saves = cs.saves || {};
    const rank = char.relativeRank || 'éšŠä¼æ ¸å¿ƒ';

    // ç›¸å°è©•ç´šé¡è‰²
    const rankColors = {
        'éšŠä¼ç¬¬ä¸€æ¢¯éšŠ': 'linear-gradient(135deg, #ffd700, #ff8c00)',
        'éšŠä¼æ ¸å¿ƒ': 'linear-gradient(135deg, #3498db, #2471a3)',
        'éšŠä¼æ”¯æ´': 'linear-gradient(135deg, #9b59b6, #6c3483)',
        'éœ€è¦è£œå¼·': 'linear-gradient(135deg, #95a5a6, #7f8c8d)'
    };

    let html = `
        <div class="result-card" style="margin-bottom: 20px;">
            <div class="result-header">
                <span class="result-name">${escapeHtml(char.name)}</span>
                <span style="padding: 6px 16px; border-radius: 20px; font-weight: 700; font-family: 'Noto Sans TC', sans-serif; background: ${rankColors[rank] || rankColors['éšŠä¼æ ¸å¿ƒ']}; color: #fff; font-size: 0.85rem;">
                    ${rank}
                </span>
            </div>
            <div class="result-body">

                <!-- æˆ°é¬¥æ•¸æ“šå€ -->
                <div style="background: var(--bg-elevated); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <h4 style="color: var(--accent-ember); margin-bottom: 12px;">âš”ï¸ æˆ°é¬¥æ•¸æ“š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center;">
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">æ”»æ“ŠDP</div>
                            <div style="font-weight: bold; color: var(--accent-gold); font-size: 1.1rem;">${cs.attackDP || '?'}</div>
                            ${cs.autoSuccess ? `<div style="font-size: 0.7rem; color: var(--accent-ember);">+${cs.autoSuccess} é™„åŠ </div>` : ''}
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">æœ‰æ•ˆæ”»æ“Š</div>
                            <div style="font-weight: bold; color: var(--danger); font-size: 1.1rem;">${cs.effectiveAttack || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å‚·å®³ä¸Šé™</div>
                            <div style="font-weight: bold; color: var(--accent-ember);">${cs.damageCap || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">é˜²ç¦¦</div>
                            <div style="font-weight: bold; color: var(--accent-cyan);">${cs.defense || '?'}</div>
                            ${cs.damageReduction ? `<div style="font-size: 0.7rem; color: var(--text-dim);">æ¸›å‚· ${cs.damageReduction}</div>` : ''}
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">HP</div>
                            <div style="font-weight: bold; color: var(--success);">${cs.hp || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å…ˆæ”»</div>
                            <div style="font-weight: bold; color: var(--text-primary);">${cs.initiative || '?'}</div>
                        </div>
                    </div>

                    <!-- ä¸‰è±å… -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 8px;">ä¸‰è±å…</div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <span style="color: var(--accent-ember);">å¼·éŸŒ ${saves.fortitude || '?'}</span>
                            <span style="color: var(--accent-cyan);">åå°„ ${saves.reflex || '?'}</span>
                            <span style="color: var(--accent-purple);">æ„å¿— ${saves.will || '?'}</span>
                        </div>
                    </div>
                </div>
    `;

    // ç›¸å°å¼·é …
    if (char.relativeStrengths && char.relativeStrengths.length) {
        html += `
            <div style="background: rgba(46, 213, 115, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border-left: 3px solid var(--success);">
                <h4 style="color: var(--success); margin-bottom: 10px;">ğŸ’ª éšŠä¼å…§å¼·é …</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        `;
        char.relativeStrengths.forEach(s => {
            html += `
                <div style="background: var(--bg-deep); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.85rem;">
                    <strong style="color: var(--success);">${escapeHtml(s.stat)}</strong>
                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 2px;">${escapeHtml(s.vsAvg)}</div>
                </div>
            `;
        });
        html += `</div></div>`;
    }

    // ç›¸å°å¼±é …
    if (char.relativeWeaknesses && char.relativeWeaknesses.length) {
        html += `
            <div style="background: rgba(255, 165, 2, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border-left: 3px solid var(--warning);">
                <h4 style="color: var(--warning); margin-bottom: 10px;">âš ï¸ éœ€è¦æ³¨æ„</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        `;
        char.relativeWeaknesses.forEach(w => {
            html += `
                <div style="background: var(--bg-deep); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.85rem;">
                    <strong style="color: var(--warning);">${escapeHtml(w.stat)}</strong>
                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 2px;">${escapeHtml(w.vsAvg)}</div>
                </div>
            `;
        });
        html += `</div></div>`;
    }

    // å¿…æ®ºæŠ€
    if (char.killerMoves && char.killerMoves.length) {
        html += `
            <div class="result-section">
                <h4>ğŸ”¥ å¿…æ®ºæŠ€</h4>
                <ul>
        `;
        char.killerMoves.forEach(move => {
            html += `
                <li style="border-left-color: var(--danger); background: rgba(255, 71, 87, 0.1);">
                    <strong style="color: var(--accent-ember);">${escapeHtml(move.name)}</strong>
                    <div style="font-size: 0.9rem; margin-top: 4px;">${escapeHtml(move.damage)}</div>
                    ${move.condition ? `<div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 4px;">ğŸ“‹ ${escapeHtml(move.condition)}</div>` : ''}
                </li>
            `;
        });
        html += `</ul></div>`;
    }

    // éšŠä¼é…åˆ
    if (char.synergiesWithTeam && char.synergiesWithTeam.length) {
        html += `
            <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                <h4 style="color: var(--accent-purple); margin-bottom: 8px;">ğŸ”— é…åˆå»ºè­°</h4>
                <ul style="list-style: none; padding: 0;">
        `;
        char.synergiesWithTeam.forEach(s => {
            html += `<li style="padding: 4px 0; color: var(--text-secondary); font-size: 0.9rem;">â€¢ ${escapeHtml(s)}</li>`;
        });
        html += `</ul></div>`;
    }

    // æˆ°è¡“åˆ†æ
    if (char.roleAnalysis) {
        html += `
            <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-sm); margin-top: 15px;">
                <strong style="color: var(--accent-gold);">ğŸ’¡ å®šä½èˆ‡å»ºè­°ï¼š</strong>
                <span style="color: var(--text-secondary);">${escapeHtml(char.roleAnalysis)}</span>
            </div>
        `;
    }

    html += `</div></div>`;
    return html;
}

// ===== BOSS æ¨¡æ“¬ =====
async function simulateBoss() {
    if (!state.lastAnalysis?.data?.characters?.length) { showError('bossError', 'è«‹å…ˆå®Œæˆè§’å¡åˆ†æ'); return; }
    const key = getKey('gemini');
    const boss = {
        hp: parseInt(document.getElementById('bossHp').value) || 50,
        def: parseInt(document.getElementById('bossDef').value) || 20,
        atk: parseInt(document.getElementById('bossAtk').value) || 15,
        dmg: parseInt(document.getElementById('bossDmg').value) || 10,
        init: parseInt(document.getElementById('bossInit').value) || 10,
        resist: parseInt(document.getElementById('bossResist').value) || 0,
        abilities: sanitize(document.getElementById('bossAbilities').value, 800)
    };
    showLoading('æ¨¡æ“¬æˆ°é¬¥...');
    hideError('bossError');
    try {
        const charSum = state.lastAnalysis.data.characters.map(c => c.name + ':' + c.powerLevel + ',' + c.summary).join('\n');
        const prompt = 'ä½œç‚ºç„¡é™ææ€–STï¼Œåˆ†æä»¥ä¸‹BOSSæˆ°ï¼š\n\nBOSS: HP=' + boss.hp + ', é˜²ç¦¦=' + boss.def + ', æ”»æ“Š=' + boss.atk + ', å‚·å®³=' + boss.dmg + ', å…ˆæ”»=' + boss.init + (boss.abilities ? ', èƒ½åŠ›=' + boss.abilities : '') + '\n\nç©å®¶:\n' + charSum + '\n\nåŸå§‹æ•¸æ“š:\n' + (state.charText?.substring(0, 8000) || '') + '\n\nç”¨JSONå›è¦†ï¼š\n```json\n{"predictions":[{"name":"è§’è‰²","rounds":"å›åˆæ•¸","threat":"danger/warning/safe","reason":"åŸå› "}],"bossAdjustments":{"recommendedHp":æ•¸å€¼,"recommendedDef":æ•¸å€¼,"mechanics":["æ©Ÿåˆ¶"],"warnings":["æ³¨æ„"]},"tips":["å»ºè­°"]}\n```\nthreat: danger=1-2å›åˆç§’, warning=3-5å›åˆ, safe=è¼ƒä¹…ã€‚ç¹ä¸­å›ç­”ã€‚';
        const result = await callGemini(prompt, key);
        displayBossResult(result);
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('bossError', 'æ¨¡æ“¬å¤±æ•—ï¼š' + e.message);
    }
}

function displayBossResult(data) {
    const content = document.getElementById('bossResultContent');
    const tips = document.getElementById('bossTips');
    const box = document.getElementById('bossResult');
    if (data.raw) { content.innerHTML = '<div style="white-space:pre-wrap;">' + escapeHtml(data.raw) + '</div>'; box.style.display = 'block'; return; }
    let html = '';
    data.predictions?.forEach(p => {
        html += '<div class="sim-row"><span style="font-weight:600;">' + escapeHtml(p.name) + '</span><span class="sim-badge ' + p.threat + '">' + escapeHtml(p.rounds) + ' å›åˆ</span></div><div style="font-size:0.8rem; color:var(--text-dim); padding:4px 0 12px; border-bottom:1px solid var(--border);">' + escapeHtml(p.reason) + '</div>';
    });
    content.innerHTML = html;
    box.style.display = 'block';
    let th = '';
    if (data.bossAdjustments) {
        const a = data.bossAdjustments;
        th += '<p style="margin-bottom:8px;"><strong>å»ºè­°HP:</strong> <span style="color:var(--accent-ember);">' + (a.recommendedHp || 'â€”') + '</span> | <strong>å»ºè­°é˜²ç¦¦:</strong> <span style="color:var(--accent-ember);">' + (a.recommendedDef || 'â€”') + '</span></p>';
        if (a.mechanics?.length) th += '<p style="margin-bottom:8px;"><strong>å»ºè­°æ©Ÿåˆ¶:</strong> ' + a.mechanics.map(m => escapeHtml(m)).join('ã€') + '</p>';
        if (a.warnings?.length) th += '<p style="color:var(--danger);"><strong>âš ï¸ æ³¨æ„:</strong> ' + a.warnings.map(w => escapeHtml(w)).join('ã€') + '</p>';
    }
    if (data.tips?.length) th += '<div style="margin-top:12px;"><strong>ğŸ’¡ è¨­è¨ˆå»ºè­°:</strong><ul style="margin-top:6px; padding-left:18px;">' + data.tips.map(t => '<li style="margin-bottom:4px;">' + escapeHtml(t) + '</li>').join('') + '</ul></div>';
    tips.innerHTML = th || '<p style="color:var(--text-dim);">ç„¡é¡å¤–å»ºè­°</p>';
}

// BOSS æ•¸å€¼æ¨™æº–æª¢æŸ¥
window.checkBossStandards = function() {
    const hp = parseInt(document.getElementById('bossHp').value) || 0;
    const atk = parseInt(document.getElementById('bossAtk').value) || 0;
    const def = parseInt(document.getElementById('bossDef').value) || 0;
    const dmg = parseInt(document.getElementById('bossDmg').value) || 0;

    // æ ¹æ“šæ”»æ“ŠåŠ›åæ¨ç­‰ç´š
    let estimatedRank = 'D';
    if (atk >= 130) estimatedRank = 'S';
    else if (atk >= 104) estimatedRank = 'A';
    else if (atk >= 78) estimatedRank = 'B';
    else if (atk >= 54) estimatedRank = 'C';

    const std = NPC_RULES.combatBenchmarks[estimatedRank];
    const immunity = NPC_RULES.bossImmunities[estimatedRank];

    // è¨ˆç®—åå·®
    const atkDiff = atk - std.atk;
    const defDiff = def - std.def;
    const dmgDiff = dmg - std.dmgCap;

    let warnings = [];
    if (def < std.def * 0.7) warnings.push('âš ï¸ é˜²ç¦¦åä½ï¼Œå®¹æ˜“è¢«ç§’æ®º');
    if (def > std.def * 1.5) warnings.push('âš ï¸ é˜²ç¦¦éé«˜ï¼Œç©å®¶å¯èƒ½æ‰“ä¸å‹•');
    if (dmg > std.dmgCap * 1.5) warnings.push('âš ï¸ å‚·å®³éé«˜ï¼Œå¯èƒ½ç§’æ®ºç©å®¶');
    if (dmg < std.dmgCap * 0.5) warnings.push('âš ï¸ å‚·å®³åä½ï¼Œç¼ºä¹å¨è„…æ€§');
    if (hp < parseInt(std.hpNum) * 0.5) warnings.push('âš ï¸ HP åä½ï¼Œå¯èƒ½è¢«é€Ÿæ®º');

    let html = `
        <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-sm);">
            <h4 style="color: var(--accent-gold); margin-bottom: 15px;">
                ğŸ“Š æ ¹æ“šæ”»æ“ŠåŠ›æ¨ç®—ï¼Œé€™æ˜¯ä¸€éš» <span style="color: var(--accent-ember); font-size: 1.3em;">${estimatedRank}ç´š</span> æ€ªç‰©
            </h4>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                <tr style="border-bottom: 1px solid var(--border);">
                    <th style="text-align: left; padding: 8px; color: var(--text-dim);">æ•¸å€¼</th>
                    <th style="text-align: center; padding: 8px; color: var(--text-dim);">ä½ çš„è¨­å®š</th>
                    <th style="text-align: center; padding: 8px; color: var(--text-dim);">${estimatedRank}ç´šæ¨™æº–</th>
                    <th style="text-align: center; padding: 8px; color: var(--text-dim);">åå·®</th>
                </tr>
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px;">æ”»æ“Š DP</td>
                    <td style="text-align: center; padding: 8px; color: var(--accent-gold);">${atk}</td>
                    <td style="text-align: center; padding: 8px;">${std.atk}</td>
                    <td style="text-align: center; padding: 8px; color: ${atkDiff >= 0 ? 'var(--success)' : 'var(--danger)'};">${atkDiff >= 0 ? '+' : ''}${atkDiff}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px;">å‚·å®³ä¸Šé™</td>
                    <td style="text-align: center; padding: 8px; color: var(--accent-ember);">${dmg}</td>
                    <td style="text-align: center; padding: 8px;">${std.dmgCap}</td>
                    <td style="text-align: center; padding: 8px; color: ${dmgDiff >= 0 ? 'var(--success)' : 'var(--danger)'};">${dmgDiff >= 0 ? '+' : ''}${dmgDiff}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px;">é˜²ç¦¦åŠ›</td>
                    <td style="text-align: center; padding: 8px; color: var(--accent-cyan);">${def}</td>
                    <td style="text-align: center; padding: 8px;">${std.def}</td>
                    <td style="text-align: center; padding: 8px; color: ${defDiff >= 0 ? 'var(--success)' : 'var(--danger)'};">${defDiff >= 0 ? '+' : ''}${defDiff}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">å»ºè­° HP</td>
                    <td style="text-align: center; padding: 8px; color: var(--success);">${hp}</td>
                    <td style="text-align: center; padding: 8px;">${std.hp}</td>
                    <td style="text-align: center; padding: 8px;">-</td>
                </tr>
            </table>

            ${warnings.length ? `
                <div style="background: rgba(255, 71, 87, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <strong style="color: var(--danger);">è­¦å‘Š</strong>
                    <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                        ${warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>
            ` : `
                <div style="background: rgba(46, 213, 115, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <span style="color: var(--success);">âœ… æ•¸å€¼ç¬¦åˆ ${estimatedRank} ç´šæ¨™æº–</span>
                </div>
            `}

            <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm);">
                <strong style="color: var(--accent-purple);">ğŸ›¡ï¸ ${estimatedRank}ç´š BOSS æ¨™æº–å…ç–«ï¼š</strong>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;">${immunity}</p>
            </div>
        </div>
    `;

    document.getElementById('bossTips').innerHTML = html;
};

// ===== è¦å‰‡å•ç­” =====
async function sendChat() {
    const input = document.getElementById('chatInput');
    const q = sanitize(input.value, 500);
    if (!q) return;
    input.value = '';
    const msgs = document.getElementById('chatMessages');
    msgs.innerHTML += '<div class="chat-msg user"><div class="chat-avatar">ğŸ‘¤</div><div class="chat-bubble">' + escapeHtml(q) + '</div></div>';
    msgs.scrollTop = msgs.scrollHeight;
    try {
        const key = getKey('gemini');
        const rules = searchRules(q.split(/\s+/));
        let rc = '';
        if (rules.length) {
            rc = '\n\nç›¸é—œè¦å‰‡ï¼š\n';
            rules.slice(0, 8).forEach(r => { rc += 'ã€' + r.filename + 'ã€‘' + r.content.substring(0, 400) + '\n'; });
        }
        const prompt = 'ä½ æ˜¯ç„¡é™ææ€–TRPGè¦å‰‡å°ˆå®¶ã€‚å›ç­”ä»¥ä¸‹å•é¡Œï¼Œç”¨ç¹é«”ä¸­æ–‡ï¼Œç°¡æ½”æ˜ç­ã€‚\n\nå•é¡Œï¼š' + q + rc;
        const result = await callGemini(prompt, key);
        const ans = result.raw || (typeof result === 'string' ? result : JSON.stringify(result));
        msgs.innerHTML += '<div class="chat-msg ai"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble">' + escapeHtml(ans).replace(/\n/g, '<br>') + '</div></div>';
    } catch (e) {
        msgs.innerHTML += '<div class="chat-msg ai"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble" style="color:var(--danger);">éŒ¯èª¤ï¼š' + escapeHtml(e.message) + '</div></div>';
    }
    msgs.scrollTop = msgs.scrollHeight;
}

// ===== NPC ç”Ÿæˆ =====
window.generateNPC = async function() {
    try {
        showLoading('æ­£åœ¨ä¾ç…§æ€ªç‰©åœ–é‘‘ç¸½ç¶±æ§‹å»ºæ•¸æ“š...');
        hideError('npcError');

        // ç²å–ä½¿ç”¨è€…è¼¸å…¥
        const diffKey = document.getElementById('npcDiff').value;
        const type = document.getElementById('npcType').value;
        const desc = document.getElementById('npcDesc').value || "ç„¡ç‰¹æ®Šæè¿°";

        // æ˜ å°„ UI é¸é …åˆ°è¦å‰‡æ›¸ç­‰ç´š
        const rankMap = {
            'minion': 'D',
            'standard': 'C',
            'elite': 'B',
            'boss': 'A'
        };
        const rank = rankMap[diffKey] || 'C';

        // å–å¾—å°æ‡‰è¦å‰‡
        const rules = NPC_RULES.statStructure[rank];
        const combat = NPC_RULES.combatBenchmarks[rank];
        const immunity = NPC_RULES.bossImmunities[rank];
        const reward = NPC_RULES.rewards[rank];
        const typeAttrs = NPC_RULES.typeAttributes[type] || NPC_RULES.typeAttributes['melee'];

        const prompt = `ä½ æ˜¯ã€Šç„¡é™ææ€–ã€‹TRPG 2.35 ç‰ˆçš„è³‡æ·± STã€‚è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ã€æ€ªç‰©åœ–é‘‘ç¸½ç¶±ã€‘è¦å‰‡ï¼Œç¾å ´æ§‹å»ºä¸€å¼µæ€ªç‰©å¡ã€‚

ã€æ§‹å»ºè¦å‰‡ - ${rank} ç´š ${rules.desc}ã€‘

1. **å…­åœå±¬æ€§åˆ†é…**ï¼ˆè‚Œè‚‰ã€æ•æ·ã€ç´°èƒã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€ç²¾ç¥ï¼‰ï¼š
   - 2 å€‹ä¸»å±¬æ€§ï¼Œæ•¸å€¼ï¼š${rules.attr.pri}
   - 3 å€‹å‰¯å±¬æ€§ï¼Œæ•¸å€¼ï¼š${rules.attr.sec}
   - 1 å€‹é€šå¸¸å±¬æ€§ï¼Œæ•¸å€¼ï¼š${rules.attr.norm}

   *æ ¹æ“šæˆ°é¬¥é¡å‹ã€Œ${type}ã€ï¼Œå»ºè­°ä¸»å±¬æ€§ç‚ºï¼š${typeAttrs.primary.join('ã€')}*

2. **æŠ€èƒ½ç­‰ç´šåˆ†é…**ï¼š
   - 3 å€‹ä¸»æŠ€èƒ½ï¼Œç­‰ç´šï¼š${rules.skill.pri}
   - 4 å€‹å‰¯æŠ€èƒ½ï¼Œç­‰ç´šï¼š${rules.skill.sec}
   - 5 å€‹æ¬¡æŠ€èƒ½ï¼Œç­‰ç´šï¼š${rules.skill.norm}

   *æŠ€èƒ½å¿…é ˆç¬¦åˆç„¡é™ææ€–é¢¨æ ¼ï¼ˆå¦‚ï¼šè¿‘æˆ°æ ¼é¬¥ã€æ§æ¢°å°„æ“Šã€å†¥æƒ³ã€é­”æ³•å°ˆæ³¨ã€é–ƒé¿ã€å¨åš‡ï¼‰*

3. **æˆ°é¬¥æ•¸å€¼åƒè€ƒ**ï¼ˆ${rank}ç´šæ™®é€šæ¨™æº–ï¼‰ï¼š
   - æ”»æ“Š DPï¼šç´„ ${combat.atk}
   - å‚·å®³ä¸Šé™ï¼šç´„ ${combat.dmgCap}
   - é˜²ç¦¦åŠ›ï¼šç´„ ${combat.def}
   - å»ºè­° HPï¼š${combat.hp}

4. **ç‰¹æ®Šèƒ½åŠ›è¨­è¨ˆ**ï¼š
   - è«‹è¨­è¨ˆ 3-4 å€‹ç¬¦åˆ ${rank} ç´šçš„ç‰¹æ€§/ä¸»å‹•æŠ€èƒ½
   - æ¯å€‹èƒ½åŠ›éœ€åŒ…å«ï¼šåç¨±ã€æ•ˆæœã€å†·å»æˆ–é™åˆ¶
   ${diffKey === 'boss' || diffKey === 'elite' ? `
   - âš ï¸ å¿…é ˆåŠ å…¥ BOSS å…ç–«æ¨¡æ¿ï¼š${immunity}` : ''}

5. **çå‹µ**ï¼šåŸºç¤æ“Šæ®ºçå‹µç‚º ${reward}

ã€ç”¨æˆ¶éœ€æ±‚ã€‘
- æˆ°é¬¥é¡å‹ï¼š${type}
- é¢¨æ ¼æè¿°ï¼š${desc}

è«‹è¼¸å‡º JSON æ ¼å¼ï¼š
\`\`\`json
{
  "name": "æ€ªç‰©åç¨±",
  "rank": "${rank}",
  "description": "å¤–è§€èˆ‡èƒŒæ™¯æè¿°ï¼ˆ2-3å¥ï¼‰",
  "attributes": {
    "è‚Œè‚‰": æ•¸å€¼,
    "æ•æ·": æ•¸å€¼,
    "ç´°èƒ": æ•¸å€¼,
    "æ™ºåŠ›": æ•¸å€¼,
    "æ„ŸçŸ¥": æ•¸å€¼,
    "ç²¾ç¥": æ•¸å€¼
  },
  "combatStats": {
    "hp": æ•¸å€¼,
    "attack_dp": æ•¸å€¼,
    "damage_cap": æ•¸å€¼,
    "defense": æ•¸å€¼,
    "initiative": æ•¸å€¼
  },
  "skills": [
    {"name": "æŠ€èƒ½å", "level": æ•¸å€¼, "type": "ä¸»/å‰¯/æ¬¡"}
  ],
  "abilities": [
    {"name": "èƒ½åŠ›å", "effect": "æ•ˆæœæè¿°", "cooldown": "é™åˆ¶èªªæ˜"}
  ],
  "immunities": "å…ç–«åˆ—è¡¨ï¼ˆè‹¥ç‚ºBOSSï¼‰",
  "tactics": "ST æˆ°è¡“å»ºè­°",
  "rewards": "${reward}"
}
\`\`\`

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;

        const result = await callGemini(prompt, { expectJson: true });

        // å¦‚æœè¿”å› _rawï¼Œé¡¯ç¤ºåŸå§‹æ–‡å­—
        if (result._raw) {
            document.getElementById('npcOutput').textContent = result._raw;
            document.getElementById('npcOutput').style.display = 'block';
            hideLoading();
            return;
        }

        // æ ¼å¼åŒ–è¼¸å‡ºçµæœ
        let html = `
            <div style="border-bottom: 2px solid var(--accent-gold); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: var(--accent-gold); margin: 0;">
                    ${escapeHtml(result.name || 'æœªå‘½åæ€ªç‰©')}
                    <span class="power-level ${rank}" style="font-size: 0.7em; padding: 4px 12px;">${rank}ç´š</span>
                </h3>
                <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                    ${escapeHtml(result.description || '')}
                </p>
            </div>
        `;

        // æˆ°é¬¥æ•¸æ“šå€å¡Š
        if (result.combatStats) {
            const cs = result.combatStats;
            html += `
                <div style="background: var(--bg-elevated); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <h4 style="color: var(--accent-ember); margin-bottom: 10px;">âš”ï¸ æˆ°é¬¥æ•¸æ“š</h4>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">HP</div>
                            <div style="font-weight: bold; color: var(--danger); font-size: 1.1rem;">${cs.hp || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">æ”»æ“ŠDP</div>
                            <div style="font-weight: bold; color: var(--accent-gold);">${cs.attack_dp || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å‚·å®³ä¸Šé™</div>
                            <div style="font-weight: bold; color: var(--accent-ember);">${cs.damage_cap || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">é˜²ç¦¦</div>
                            <div style="font-weight: bold; color: var(--accent-cyan);">${cs.defense || '?'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-dim); font-size: 0.75rem;">å…ˆæ”»</div>
                            <div style="font-weight: bold; color: var(--text-primary);">${cs.initiative || '?'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // å…­åœå±¬æ€§
        if (result.attributes) {
            html += `
                <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <h4 style="color: var(--accent-cyan); margin-bottom: 10px;">ğŸ“Š å…­åœå±¬æ€§</h4>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; text-align: center;">
            `;
            for (const [key, val] of Object.entries(result.attributes)) {
                const isPrimary = val >= rules.attr.pri;
                const color = isPrimary ? 'var(--accent-gold)' : 'var(--text-secondary)';
                html += `
                    <div>
                        <div style="color: var(--text-dim); font-size: 0.7rem;">${escapeHtml(key)}</div>
                        <div style="font-weight: bold; color: ${color};">${val}</div>
                    </div>
                `;
            }
            html += `</div></div>`;
        }

        // æŠ€èƒ½åˆ—è¡¨
        if (result.skills && result.skills.length) {
            html += `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: var(--accent-purple); margin-bottom: 10px;">ğŸ¯ æŠ€èƒ½</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            result.skills.forEach(s => {
                const typeColor = s.type === 'ä¸»' ? 'var(--accent-gold)' :
                                  s.type === 'å‰¯' ? 'var(--accent-cyan)' : 'var(--text-dim)';
                html += `
                    <span style="background: var(--bg-elevated); padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; border-left: 3px solid ${typeColor};">
                        ${escapeHtml(s.name)} <span style="color: var(--text-dim);">Lv.${s.level}</span>
                    </span>
                `;
            });
            html += `</div></div>`;
        }

        // ç‰¹æ®Šèƒ½åŠ›
        if (result.abilities && result.abilities.length) {
            html += `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: var(--danger); margin-bottom: 10px;">ğŸ”¥ ç‰¹æ®Šèƒ½åŠ›</h4>
            `;
            result.abilities.forEach(a => {
                html += `
                    <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid var(--danger);">
                        <div style="font-weight: bold; color: var(--accent-ember);">${escapeHtml(a.name)}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(a.effect)}</div>
                        ${a.cooldown ? `<div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 4px;">â±ï¸ ${escapeHtml(a.cooldown)}</div>` : ''}
                    </div>
                `;
            });
            html += `</div>`;
        }

        // å…ç–«ï¼ˆBOSSï¼‰
        if (result.immunities) {
            html += `
                <div style="background: rgba(155, 89, 182, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border: 1px solid var(--accent-purple);">
                    <h4 style="color: var(--accent-purple); margin-bottom: 8px;">ğŸ›¡ï¸ BOSS å…ç–«</h4>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">${escapeHtml(result.immunities)}</div>
                </div>
            `;
        }

        // æˆ°è¡“å»ºè­°
        if (result.tactics) {
            html += `
                <div style="background: var(--bg-deep); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                    <h4 style="color: var(--accent-gold); margin-bottom: 8px;">ğŸ’¡ ST æˆ°è¡“å»ºè­°</h4>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">${escapeHtml(result.tactics)}</div>
                </div>
            `;
        }

        // çå‹µ
        html += `
            <div style="text-align: center; padding: 10px; background: linear-gradient(135deg, var(--accent-gold), var(--accent-ember)); border-radius: var(--radius-sm); color: #000; font-weight: bold;">
                ğŸ† æ“Šæ®ºçå‹µï¼š${escapeHtml(result.rewards || reward)}
            </div>
        `;

        const output = document.getElementById('npcOutput');
        output.innerHTML = html;
        output.style.display = 'block';
        hideLoading();

    } catch(e) {
        hideLoading();
        console.error('NPC ç”ŸæˆéŒ¯èª¤:', e);
        showError('npcError', 'ç”Ÿæˆå¤±æ•—: ' + e.message);
    }
};

// ===== è¨­è¨ˆæª¢æŸ¥ =====
function toggleCheck(li) {
    li.classList.toggle('checked');
    li.querySelector('.check-icon').textContent = li.classList.contains('checked') ? 'â˜‘' : 'â˜';
}

function resetChecklist() {
    document.querySelectorAll('#checklistItems li').forEach(li => {
        li.classList.remove('checked');
        li.querySelector('.check-icon').textContent = 'â˜';
    });
}

async function getEncounterTips() {
    const desc = sanitize(document.getElementById('encounterDesc').value, 1000);
    if (!desc) { showError('encounterError', 'è«‹æè¿°é­é‡'); return; }
    const key = getKey('gemini');
    showLoading('åˆ†æä¸­...');
    hideError('encounterError');
    try {
        let charInfo = '';
        if (state.lastAnalysis?.data?.characters) {
            charInfo = '\n\nç©å®¶éšŠä¼ï¼š\n' + state.lastAnalysis.data.characters.map(c => c.name + '(' + c.powerLevel + '): ' + c.summary).join('\n');
        }
        const prompt = 'ä½œç‚ºç„¡é™ææ€–STï¼Œç‚ºä»¥ä¸‹é­é‡æä¾›è¨­è¨ˆå»ºè­°ï¼š\n\n' + desc + charInfo + '\n\nè«‹æä¾›ï¼š\n1. é­é‡å¹³è¡¡å»ºè­°\n2. æ•µäººé…ç½®å»ºè­°\n3. ç‰¹æ®Šæ©Ÿåˆ¶å»ºè­°\n4. å¯èƒ½çš„å•é¡Œå’Œå°ç­–\n5. æˆ²åŠ‡æ€§å¢å¼·å»ºè­°\n\nç”¨ç¹é«”ä¸­æ–‡ã€‚';
        const result = await callGemini(prompt, key);
        const text = result.raw || (typeof result === 'string' ? result : JSON.stringify(result));
        document.getElementById('encounterTips').style.display = 'block';
        document.getElementById('encounterTips').innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('encounterError', 'å¤±æ•—ï¼š' + e.message);
    }
}

// ===== æ­·å²ç´€éŒ„ =====
function loadHistory() {
    try {
        const h = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'history');
        if (h) state.history = JSON.parse(h);
    } catch (e) { state.history = []; }
}

function saveHistory(data) {
    if (!data?.characters?.length) return;
    const item = {
        id: Date.now(),
        time: new Date().toLocaleString('zh-TW'),
        chars: data.characters.map(c => ({ name: c.name, level: c.powerLevel })),
        data
    };
    state.history.unshift(item);
    if (state.history.length > CONFIG.MAX_HISTORY) state.history = state.history.slice(0, CONFIG.MAX_HISTORY);
    localStorage.setItem(CONFIG.STORAGE_PREFIX + 'history', JSON.stringify(state.history));
    renderHistory();
}

function renderHistory() {
    const el = document.getElementById('historyList');
    if (!state.history.length) { el.innerHTML = '<p style="color:var(--text-dim); text-align:center; padding:30px;">å°šç„¡ç´€éŒ„</p>'; return; }
    el.innerHTML = state.history.map(h => '<div class="history-item" onclick="loadHistoryItem(' + h.id + ')"><div class="history-header"><span class="history-title">' + h.chars.map(c => escapeHtml(c.name) + '(' + c.level + ')').join(', ') + '</span><span class="history-date">' + escapeHtml(h.time) + '</span></div></div>').join('');
}

function loadHistoryItem(id) {
    const item = state.history.find(h => h.id === id);
    if (item?.data) {
        state.lastAnalysis = { data: item.data, time: item.id };
        displayResults(item.data);
        switchPage('analyze');
    }
}

function clearHistory() {
    if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Ÿ')) {
        state.history = [];
        localStorage.removeItem(CONFIG.STORAGE_PREFIX + 'history');
        renderHistory();
    }
}

function updateTrackSelect(chars) {
    const sel = document.getElementById('trackSelect');
    if (!chars?.length) return;
    sel.innerHTML = '<option value="">-- é¸æ“‡è§’è‰² --</option>' + chars.map(c => '<option value="' + escapeHtml(c.name) + '">' + escapeHtml(c.name) + '</option>').join('');
}

// ===== åŒ¯å‡º =====
function exportResults(format) {
    if (!state.lastAnalysis?.data) return;
    const data = state.lastAnalysis.data;
    if (format === 'discord') {
        let text = '**ğŸ“Š è§’å¡åˆ†æçµæœ**\n\n';
        data.characters?.forEach(c => {
            text += '**' + c.name + '** [' + c.powerLevel + ']\n' + c.summary + '\n';
            if (c.warnings?.length) text += 'âš ï¸ ' + c.warnings.join('\nâš ï¸ ') + '\n';
            text += '\n';
        });
        if (data.teamSummary) text += '**éšŠä¼ç¸½è©•:** ' + data.teamSummary.overallPower + '\n';
        navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'));
    } else {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analysis_' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }
}

// ===== å·¥å…· =====
function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.classList.add('show'); }
function hideError(id) { document.getElementById(id).classList.remove('show'); }
</script>
</body>
</html>

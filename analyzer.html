<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- å®‰å…¨æ¨™é ­ -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self' https://sheets.googleapis.com https://generativelanguage.googleapis.com https://raw.githubusercontent.com;
        frame-ancestors 'none';
        form-action 'self';
        base-uri 'self';
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <title>ç„¡é™ææ€– ST åŠ©æ‰‹ v2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-abyss: #0a0a0c;
            --bg-deep: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #222230;
            --bg-hover: #2a2a3a;
            --accent-blood: #c41e3a;
            --accent-blood-dim: #8b1528;
            --accent-gold: #d4a020;
            --accent-ember: #ff6b35;
            --accent-purple: #9b59b6;
            --accent-blue: #3498db;
            --accent-cyan: #00d4aa;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-dim: #606070;
            --border: #333340;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            --info: #70a1ff;
            --radius: 16px;
            --radius-sm: 10px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg-abyss);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-abyss); }
        ::-webkit-scrollbar-thumb { background: var(--accent-blood-dim); border-radius: 4px; }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--accent-blood-dim) 0%, var(--bg-deep) 40%, var(--bg-abyss) 100%);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-blood);
            position: relative;
        }
        header::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            animation: scan 3s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(196, 30, 58, 0.5);
        }
        h1 .highlight { color: var(--accent-gold); }
        .subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .version { display: inline-block; padding: 2px 8px; background: var(--accent-gold); color: #000; font-size: 0.7rem; font-weight: 700; border-radius: 8px; margin-left: 8px; }

        /* Navigation */
        .main-nav {
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 5px;
            padding: 10px 15px;
        }
        .nav-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-btn.active { background: var(--accent-blood-dim); color: var(--accent-gold); }

        /* Container */
        .container { max-width: 1300px; margin: 0 auto; padding: 20px 15px; }

        /* Pages */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 22px;
            margin-bottom: 22px;
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--accent-blood), var(--accent-gold));
        }
        .card.gold::before { background: linear-gradient(90deg, var(--accent-gold), var(--accent-ember)); }
        .card.purple::before { background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue)); }
        .card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)); }
        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 0.85rem; color: var(--text-secondary); }
        .input-group input, .input-group select, .input-group textarea {
            padding: 12px 15px;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--accent-gold); }
        .input-group input::placeholder, .input-group textarea::placeholder { color: var(--text-dim); }
        .input-hint { font-size: 0.75rem; color: var(--text-dim); }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blood), var(--accent-blood-dim)); color: #fff; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(196,30,58,0.4); }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold), var(--accent-ember)); color: #000; }
        .btn-gold:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-secondary { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--accent-gold); color: var(--text-primary); }
        .action-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 18px; }

        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 18px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover { border-color: var(--accent-gold); }
        .tab-btn.active { background: var(--accent-blood-dim); border-color: var(--accent-blood); color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tags */
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            padding: 6px 14px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 18px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag:hover { border-color: var(--accent-gold); }
        .tag.selected { background: var(--accent-blood-dim); border-color: var(--accent-blood); color: #fff; }

        /* Textarea */
        .text-area {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.8;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-primary);
            outline: none;
            resize: vertical;
            font-family: inherit;
        }
        .text-area:focus { border-color: var(--accent-gold); }

        /* Preview */
        .preview-box {
            margin-top: 18px;
            padding: 18px;
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            max-height: 350px;
            overflow-y: auto;
        }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .preview-title { font-weight: 600; color: var(--accent-gold); font-size: 0.9rem; }
        .preview-stats { font-size: 0.8rem; color: var(--text-dim); }
        .char-card { background: var(--bg-card); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--accent-blood); }
        .char-card h4 { color: var(--accent-gold); margin-bottom: 6px; font-size: 0.95rem; }
        .char-card .notes { font-size: 0.8rem; color: var(--accent-ember); background: rgba(255,107,53,0.1); padding: 6px 10px; border-radius: 5px; margin-top: 8px; }

        /* Results */
        .result-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 18px; overflow: hidden; }
        .result-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 22px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
        .result-name { font-size: 1.1rem; font-weight: 700; }
        .power-level { padding: 6px 16px; font-size: 0.95rem; font-weight: 900; border-radius: 20px; font-family: 'Orbitron', sans-serif; }
        .power-level.S { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
        .power-level.A { background: linear-gradient(135deg, #c41e3a, #8b1528); color: #fff; }
        .power-level.B { background: linear-gradient(135deg, #9b59b6, #6c3483); color: #fff; }
        .power-level.C { background: linear-gradient(135deg, #3498db, #2471a3); color: #fff; }
        .power-level.D { background: linear-gradient(135deg, #27ae60, #1e8449); color: #fff; }
        .result-body { padding: 22px; }
        .result-section { margin-bottom: 18px; }
        .result-section h4 { font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 10px; }
        .result-section ul { list-style: none; }
        .result-section li { padding: 10px 14px; margin-bottom: 6px; background: var(--bg-deep); border-radius: var(--radius-sm); border-left: 3px solid var(--accent-blood-dim); font-size: 0.9rem; }
        .result-section li.warning { border-left-color: var(--danger); background: rgba(255,71,87,0.1); }
        .result-section li.weakness { border-left-color: var(--info); }
        .result-section li.success { border-left-color: var(--success); }
        .rule-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .rule-tag { padding: 5px 12px; font-size: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 15px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .rule-tag:hover { background: var(--accent-blood-dim); color: #fff; }

        /* Chart */
        .chart-container { position: relative; height: 320px; margin: 15px 0; }

        /* BOSS Simulator */
        .boss-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 18px; }
        .stat-input { text-align: center; }
        .stat-input label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 4px; }
        .stat-input input { width: 100%; padding: 10px; font-size: 1.1rem; font-weight: 700; text-align: center; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-deep); color: var(--accent-gold); }
        .sim-result { background: var(--bg-deep); border-radius: var(--radius-sm); padding: 18px; margin-top: 18px; }
        .sim-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .sim-row:last-child { border-bottom: none; }
        .sim-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .sim-badge.danger { background: rgba(255,71,87,0.2); color: var(--danger); }
        .sim-badge.warning { background: rgba(255,165,2,0.2); color: var(--warning); }
        .sim-badge.safe { background: rgba(46,213,115,0.2); color: var(--success); }

        /* Chat */
        .chat-box { display: flex; flex-direction: column; height: 450px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-deep); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .chat-msg { margin-bottom: 15px; display: flex; gap: 10px; }
        .chat-msg.user { flex-direction: row-reverse; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .chat-msg.user .chat-avatar { background: var(--accent-gold); }
        .chat-msg.ai .chat-avatar { background: var(--accent-blood); }
        .chat-bubble { max-width: 75%; padding: 10px 14px; border-radius: var(--radius-sm); font-size: 0.9rem; line-height: 1.6; }
        .chat-msg.user .chat-bubble { background: var(--accent-gold); color: #000; border-bottom-right-radius: 3px; }
        .chat-msg.ai .chat-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 3px; }
        .chat-input-row { display: flex; gap: 10px; }
        .chat-input-row input { flex: 1; }

        /* Checklist */
        .checklist { list-style: none; }
        .checklist li { padding: 12px 14px; margin-bottom: 6px; background: var(--bg-deep); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .checklist li:hover { background: var(--bg-hover); }
        .checklist li.checked { background: rgba(46,213,115,0.1); border-left: 3px solid var(--success); }
        .check-icon { font-size: 1.1rem; color: var(--text-dim); }
        .checklist li.checked .check-icon { color: var(--success); }

        /* History */
        .history-item { background: var(--bg-deep); border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; border-left: 3px solid var(--accent-gold); cursor: pointer; transition: all 0.2s; }
        .history-item:hover { background: var(--bg-hover); transform: translateX(4px); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .history-title { font-weight: 600; font-size: 0.95rem; }
        .history-date { font-size: 0.75rem; color: var(--text-dim); }
        .history-preview { font-size: 0.8rem; color: var(--text-secondary); }

        /* Messages */
        .msg { padding: 12px 16px; border-radius: var(--radius-sm); margin-bottom: 12px; display: none; font-size: 0.9rem; }
        .msg.show { display: block; }
        .msg.error { background: rgba(255,71,87,0.1); border: 1px solid var(--danger); color: var(--danger); }
        .msg.success { background: rgba(46,213,115,0.1); border: 1px solid var(--success); color: var(--success); }
        .msg.info { background: rgba(112,161,255,0.1); border: 1px solid var(--info); color: var(--info); }

        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,12,0.92); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; gap: 18px; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--border); border-top-color: var(--accent-blood); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 0.95rem; color: var(--text-secondary); }

        /* Footer */
        footer { text-align: center; padding: 22px 15px; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 25px; }
        footer a { color: var(--accent-gold); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Save indicator */
        .save-indicator { font-size: 0.75rem; color: var(--success); opacity: 0; transition: opacity 0.3s; margin-left: auto; }
        .save-indicator.show { opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-btn { padding: 8px 12px; font-size: 0.8rem; }
            .form-grid { grid-template-columns: 1fr; }
            .input-row { flex-direction: column; }
            .action-row { flex-direction: column; }
            .action-row .btn { width: 100%; }
            .result-header { flex-direction: column; text-align: center; }
            .boss-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-container { height: 260px; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸšŒ ç„¡é™ææ€– <span class="highlight">ST åŠ©æ‰‹</span> <span class="version">v2.0</span></h1>
    <p class="subtitle">è§’å¡åˆ†æ Â· BOSSæ¨¡æ“¬ Â· è¦å‰‡å•ç­” Â· NPCç”Ÿæˆ Â· é­é‡è¨­è¨ˆ</p>
</header>

<nav class="main-nav">
    <div class="nav-container">
        <button class="nav-btn active" onclick="switchPage('analyze')" data-page="analyze">âš”ï¸ è§’å¡åˆ†æ</button>
        <button class="nav-btn" onclick="switchPage('boss')" data-page="boss">ğŸ‘¹ BOSSæ¨¡æ“¬</button>
        <button class="nav-btn" onclick="switchPage('qa')" data-page="qa">ğŸ“š è¦å‰‡å•ç­”</button>
        <button class="nav-btn" onclick="switchPage('npc')" data-page="npc">ğŸ² NPCç”Ÿæˆ</button>
        <button class="nav-btn" onclick="switchPage('checklist')" data-page="checklist">âœ… è¨­è¨ˆæª¢æŸ¥</button>
        <button class="nav-btn" onclick="switchPage('history')" data-page="history">ğŸ“Š æ­·å²ç´€éŒ„</button>
        <button class="nav-btn" onclick="switchPage('settings')" data-page="settings">âš™ï¸ è¨­å®š</button>
    </div>
</nav>

<div class="container">

    <!-- ===== è§’å¡åˆ†æé  ===== -->
    <section class="page active" id="page-analyze">
        <div class="card">
            <div class="card-title">ğŸ“‹ è§’å¡è³‡æ–™è¼¸å…¥</div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('sheets')">ğŸ“Š Google Sheets</button>
                <button class="tab-btn" onclick="switchTab('text')">ğŸ“ è²¼ä¸Šæ–‡å­—</button>
            </div>
            <div class="tab-content active" id="tab-sheets">
                <div class="input-row" style="margin-bottom: 12px;">
                    <input type="text" id="sheetsUrl" placeholder="è²¼ä¸Š Google Sheets é€£çµ...">
                    <button class="btn btn-gold" onclick="fetchSheets()">ğŸ“¥ è®€å–</button>
                </div>
                <p class="input-hint">ğŸ’¡ è©¦ç®—è¡¨éœ€è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººéƒ½èƒ½æª¢è¦–ã€</p>
                <div id="sheetSelector" style="display:none; margin-top:15px;">
                    <label style="display:block; margin-bottom:8px; color:var(--text-secondary); font-size:0.85rem;">é¸æ“‡è¦åˆ†æçš„è§’è‰²ï¼š</label>
                    <div class="tag-list" id="sheetTabs"></div>
                </div>
            </div>
            <div class="tab-content" id="tab-text">
                <textarea class="text-area" id="textInput" placeholder="ç›´æ¥è²¼ä¸Šè§’å¡å…§å®¹...

ç¯„ä¾‹ï¼š
========== è§’è‰²ï¼šè«çˆ¾ç´¢ ==========
åŠ›é‡ï¼š6  æ•æ·ï¼š4  æ„å¿—å€¼ï¼š16
ç‰¹æ®Šèƒ½åŠ›ï¼šå¾·ç‘ªè¥¿äºæ­£ç¾©ã€å‚™è¨»ï¼šæ¥è§¸æ”»æ“Šç„¡è¦–è­·ç”²ã€‘"></textarea>
            </div>
            <div class="preview-box" id="previewBox" style="display:none;">
                <div class="preview-header">
                    <span class="preview-title">ğŸ“„ è³‡æ–™é è¦½</span>
                    <span class="preview-stats" id="previewStats"></span>
                </div>
                <div id="previewContent"></div>
            </div>
            <div class="msg error" id="analyzeError"></div>
            <div class="action-row">
                <button class="btn btn-primary" onclick="analyzeCharacters()" style="flex:2;">âš”ï¸ åˆ†æè§’å¡æˆ°åŠ›</button>
                <button class="btn btn-secondary" onclick="window.open('index.html','_blank')">ğŸ“š è¦å‰‡æŸ¥è©¢</button>
            </div>
        </div>
        <div id="analyzeResults" style="display:none;">
            <div class="card gold">
                <div class="card-title">
                    ğŸ“Š åˆ†æçµæœ
                    <div style="margin-left:auto; display:flex; gap:8px;">
                        <button class="btn btn-secondary" onclick="exportResults('discord')" style="padding:6px 12px; font-size:0.8rem;">ğŸ“‹ è¤‡è£½</button>
                        <button class="btn btn-secondary" onclick="exportResults('json')" style="padding:6px 12px; font-size:0.8rem;">ğŸ’¾ JSON</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="radarChart"></canvas></div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </section>

    <!-- ===== BOSS æ¨¡æ“¬é  ===== -->
    <section class="page" id="page-boss">
        <div class="card purple">
            <div class="card-title">ğŸ‘¹ BOSS å°æˆ°æ¨¡æ“¬å™¨</div>
            <p style="color:var(--text-secondary); margin-bottom:15px; font-size:0.9rem;">è¼¸å…¥ BOSS æ•¸å€¼ï¼Œé æ¸¬ç©å®¶æ“Šæ®ºå›åˆæ•¸</p>
            <div class="boss-grid">
                <div class="stat-input"><label>ç”Ÿå‘½å€¼</label><input type="number" id="bossHp" value="50"></div>
                <div class="stat-input"><label>é˜²ç¦¦</label><input type="number" id="bossDef" value="20"></div>
                <div class="stat-input"><label>æ”»æ“Š</label><input type="number" id="bossAtk" value="15"></div>
                <div class="stat-input"><label>å‚·å®³</label><input type="number" id="bossDmg" value="10"></div>
                <div class="stat-input"><label>å…ˆæ”»</label><input type="number" id="bossInit" value="10"></div>
                <div class="stat-input"><label>æŠ—æ€§</label><input type="number" id="bossResist" value="0"></div>
            </div>
            <div class="input-group">
                <label>BOSS ç‰¹æ®Šèƒ½åŠ›ï¼ˆé¸å¡«ï¼‰</label>
                <textarea class="text-area" id="bossAbilities" style="min-height:80px;" placeholder="å¦‚ï¼šå…ç–«ç²¾ç¥æ”»æ“Šã€æ¯3å›åˆæ¢å¾©10HP..."></textarea>
            </div>
            <div class="msg error" id="bossError"></div>
            <button class="btn btn-primary" onclick="simulateBoss()" style="width:100%; margin-top:15px;">âš”ï¸ é–‹å§‹æ¨¡æ“¬</button>
            <div class="sim-result" id="bossResult" style="display:none;">
                <h4 style="color:var(--accent-gold); margin-bottom:12px;">ğŸ“Š æ¨¡æ“¬çµæœ</h4>
                <div id="bossResultContent"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ’¡ è¨­è¨ˆå»ºè­°</div>
            <div id="bossTips"><p style="color:var(--text-dim);">å®Œæˆæ¨¡æ“¬å¾Œé¡¯ç¤ºå»ºè­°</p></div>
        </div>
    </section>

    <!-- ===== è¦å‰‡å•ç­”é  ===== -->
    <section class="page" id="page-qa">
        <div class="card cyan">
            <div class="card-title">ğŸ“š è¦å‰‡æ›¸ AI å•ç­”</div>
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-msg ai">
                        <div class="chat-avatar">ğŸ¤–</div>
                        <div class="chat-bubble">ä½ å¥½ï¼æˆ‘å¯ä»¥å›ç­”ç„¡é™ææ€–è¦å‰‡å•é¡Œã€‚<br><br>è©¦è©¦å•ï¼šã€Œæ“’æŠ±è¦å‰‡ï¼Ÿã€ã€ŒåŸºå› é–æ•ˆæœï¼Ÿã€ã€Œç ´ç”²æ€éº¼ç®—ï¼Ÿã€</div>
                    </div>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-gold" onclick="sendChat()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== NPC ç”Ÿæˆé  ===== -->
    <section class="page" id="page-npc">
        <div class="card">
            <div class="card-title">ğŸ² å¿«é€Ÿ NPC ç”Ÿæˆå™¨</div>
            <div class="form-grid">
                <div class="input-group">
                    <label>é›£åº¦</label>
                    <select id="npcDiff">
                        <option value="minion">é›œå…µ</option>
                        <option value="standard" selected>æ¨™æº–</option>
                        <option value="elite">ç²¾è‹±</option>
                        <option value="boss">é ­ç›®</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>é¡å‹</label>
                    <select id="npcType">
                        <option value="melee">è¿‘æˆ°</option>
                        <option value="ranged">é ç¨‹</option>
                        <option value="mage">æ³•å¸«</option>
                        <option value="tank">å¦å…‹</option>
                        <option value="assassin">åˆºå®¢</option>
                    </select>
                </div>
            </div>
            <div class="input-group" style="margin-top:15px;">
                <label>é¡å¤–æè¿°</label>
                <input type="text" id="npcDesc" placeholder="å¦‚ï¼šç•°å½¢é¢¨æ ¼ã€æ“…é•·æ½›è¡Œ...">
            </div>
            <div class="msg error" id="npcError"></div>
            <button class="btn btn-primary" onclick="generateNPC()" style="width:100%; margin-top:15px;">ğŸ² ç”Ÿæˆ NPC</button>
            <div id="npcOutput" style="display:none; margin-top:18px; padding:18px; background:var(--bg-deep); border-radius:var(--radius-sm); white-space:pre-wrap; font-size:0.9rem; line-height:1.8;"></div>
        </div>
    </section>

    <!-- ===== è¨­è¨ˆæª¢æŸ¥é  ===== -->
    <section class="page" id="page-checklist">
        <div class="card">
            <div class="card-title">âœ… å‰¯æœ¬è¨­è¨ˆæª¢æŸ¥æ¸…å–®</div>
            <ul class="checklist" id="checklistItems">
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>BOSS HP æ˜¯å¦è¶³å¤ æ‰¿å—éšŠä¼æœ€é«˜è¼¸å‡ºï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰æ²’æœ‰é‡å°é«˜æ©Ÿå‹•è§’è‰²çš„é™åˆ¶ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰æ²’æœ‰åç§’æ®ºæ©Ÿåˆ¶ï¼Ÿï¼ˆåˆ†éšæ®µ/ç„¡æ•µæ™‚é–“ï¼‰</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>ä½æˆ°åŠ›è§’è‰²æœ‰ç™¼æ®ç©ºé–“å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>BOSS èƒ½çªç ´é«˜é˜²è§’è‰²å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>ç²¾ç¥æ”»æ“Šå°é«˜æ„å¿—è§’è‰²æœ‰æ•ˆå—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æˆ°å ´æœ‰åˆ©ç”¨åƒ¹å€¼å—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>æœ‰å‚™æ¡ˆæ–¹æ¡ˆå—ï¼Ÿ</li>
                <li onclick="toggleCheck(this)"><span class="check-icon">â˜</span>è€ƒæ…®éç©å®¶çš„éš±è—åº•ç‰Œå—ï¼Ÿ</li>
            </ul>
            <div class="action-row">
                <button class="btn btn-secondary" onclick="resetChecklist()">ğŸ”„ é‡ç½®</button>
            </div>
        </div>
        <div class="card gold">
            <div class="card-title">ğŸ’¡ AI é­é‡å»ºè­°</div>
            <div class="input-group">
                <label>æè¿°ä½ æƒ³è¨­è¨ˆçš„é­é‡</label>
                <textarea class="text-area" id="encounterDesc" style="min-height:100px;" placeholder="å¦‚ï¼šå»¢æ£„é†«é™¢çš„è®Šç•°è­·å£«æˆ°é¬¥..."></textarea>
            </div>
            <div class="msg error" id="encounterError"></div>
            <button class="btn btn-gold" onclick="getEncounterTips()" style="width:100%; margin-top:12px;">ğŸ§  ç²å–å»ºè­°</button>
            <div id="encounterTips" style="display:none; margin-top:15px; padding:15px; background:var(--bg-deep); border-radius:var(--radius-sm);"></div>
        </div>
    </section>

    <!-- ===== æ­·å²ç´€éŒ„é  ===== -->
    <section class="page" id="page-history">
        <div class="card">
            <div class="card-title">
                ğŸ“Š åˆ†ææ­·å²
                <button class="btn btn-secondary" onclick="clearHistory()" style="margin-left:auto; padding:6px 12px; font-size:0.8rem;">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="historyList"><p style="color:var(--text-dim); text-align:center; padding:30px;">å°šç„¡ç´€éŒ„</p></div>
        </div>
        <div class="card purple">
            <div class="card-title">ğŸ“ˆ è§’è‰²æˆé•·è¿½è¹¤</div>
            <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:12px;">æ¯”è¼ƒåŒä¸€è§’è‰²ä¸åŒæ™‚é–“çš„è®ŠåŒ–</p>
            <select id="trackSelect" style="width:100%; padding:10px; background:var(--bg-deep); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary);">
                <option value="">-- å®Œæˆåˆ†æå¾Œå¯é¸æ“‡ --</option>
            </select>
            <div id="trackResult" style="display:none; margin-top:15px;"></div>
        </div>
    </section>

    <!-- ===== è¨­å®šé  ===== -->
    <section class="page" id="page-settings">
        <div class="card">
            <div class="card-title">ğŸ”‘ API è¨­å®š <span class="save-indicator" id="saveIndicator">âœ“ å·²å„²å­˜</span></div>
            <div class="form-grid">
                <div class="input-group">
                    <label>Google Sheets API Key</label>
                    <input type="password" id="sheetsApiKey" placeholder="AIzaSy...">
                    <span class="input-hint">è®€å–è©¦ç®—è¡¨ç”¨</span>
                </div>
                <div class="input-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
                    <span class="input-hint">AI åˆ†æç”¨</span>
                </div>
            </div>
            <div class="msg info" style="display:block; margin-top:15px;">ğŸ”’ API Key åƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ“– è¦å‰‡æ›¸ç‹€æ…‹</div>
            <div id="rulesStatus"><p style="color:var(--text-dim);">è¼‰å…¥ä¸­...</p></div>
        </div>
    </section>

</div>

<footer>
    <a href="index.html">ğŸ“– è¦å‰‡æŸ¥è©¢</a> | 
    <a href="https://www.hktrpg.com/INF/2.35Christmas.html" target="_blank">è¦å‰‡æ›¸ä¾†æº</a>
    <p style="margin-top:6px;">åƒ…ä¾›å­¸ç¿’ä½¿ç”¨ Â· v2.0</p>
</footer>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è™•ç†ä¸­...</div>
</div>

<script>
'use strict';

// ===== é…ç½® =====
const CONFIG = Object.freeze({
    STORAGE_PREFIX: 'inf_st_',
    SHEETS_API: 'https://sheets.googleapis.com/v4/spreadsheets',
    GEMINI_API: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
    RULES_URL: './rules-2.35.txt',
    MAX_INPUT: 50000,
    MAX_RULES: 12000,
    MAX_HISTORY: 30,
});

// ===== ç‹€æ…‹ =====
let state = {
    sheetsData: null,
    selectedSheets: new Set(),
    rulesData: [],
    charText: '',
    lastAnalysis: null,
    radarChart: null,
    history: [],
};

// ===== å®‰å…¨å·¥å…· =====
function escapeHtml(t) {
    if (typeof t !== 'string') return '';
    return t.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]);
}

function sanitize(t, max = CONFIG.MAX_INPUT) {
    if (typeof t !== 'string') return '';
    return t.trim().substring(0, max).replace(/[\x00-\x1F\x7F]/g, '');
}

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    loadApiKeys();
    setupAutoSave();
    loadRules();
    loadHistory();
    renderHistory();
});

// ===== é é¢åˆ‡æ› =====
function switchPage(name) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === name));
    document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + name));
}

function switchTab(name) {
    document.querySelectorAll('#page-analyze .tab-btn').forEach((b, i) => b.classList.toggle('active', (name === 'sheets' ? i === 0 : i === 1)));
    document.getElementById('tab-sheets').classList.toggle('active', name === 'sheets');
    document.getElementById('tab-text').classList.toggle('active', name === 'text');
}

// ===== API Key =====
function loadApiKeys() {
    const sk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'sheets_key');
    const gk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'gemini_key');
    if (sk) document.getElementById('sheetsApiKey').value = sk;
    if (gk) document.getElementById('geminiApiKey').value = gk;
}

function setupAutoSave() {
    const si = document.getElementById('sheetsApiKey');
    const gi = document.getElementById('geminiApiKey');
    const ind = document.getElementById('saveIndicator');
    const save = () => {
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'sheets_key', si.value);
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'gemini_key', gi.value);
        ind.classList.add('show');
        setTimeout(() => ind.classList.remove('show'), 2000);
    };
    si.addEventListener('change', save);
    gi.addEventListener('change', save);
}

function getKey(type) {
    const k = document.getElementById(type + 'ApiKey')?.value?.trim();
    if (!k) throw new Error('è«‹å…ˆåœ¨è¨­å®šé å¡«å…¥ ' + (type === 'sheets' ? 'Google Sheets' : 'Gemini') + ' API Key');
    return k;
}

// ===== è¦å‰‡æ›¸ =====
async function loadRules() {
    const el = document.getElementById('rulesStatus');
    try {
        const res = await fetch(CONFIG.RULES_URL);
        if (!res.ok) throw new Error();
        const txt = await res.text();
        parseRules(txt);
        el.innerHTML = '<p style="color:var(--success)">âœ… è¼‰å…¥æˆåŠŸï¼Œå…± ' + state.rulesData.length + ' æ¢</p>';
    } catch (e) {
        el.innerHTML = '<p style="color:var(--warning)">âš ï¸ è¦å‰‡æ›¸è¼‰å…¥å¤±æ•—ï¼ŒAIåŠŸèƒ½ä»å¯ç”¨</p>';
    }
}

function parseRules(content) {
    const lines = content.split('\n');
    let cur = null;
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const parts = line.split('\t');
        if (parts.length >= 4 && parts[2]?.includes('http')) {
            if (cur?.content?.length > 20) state.rulesData.push(cur);
            cur = { category: (parts[0] || '').trim(), filename: (parts[1] || '').trim(), content: parts.slice(3).join(' ').trim() };
        } else if (cur) {
            cur.content += ' ' + line.trim();
        }
    }
    if (cur?.content?.length > 20) state.rulesData.push(cur);
    state.rulesData.forEach((e, i) => { e.id = i; e.search = (e.category + ' ' + e.filename + ' ' + e.content).toLowerCase(); });
}

function searchRules(keywords) {
    if (!keywords?.length) return [];
    const terms = keywords.map(k => k.toLowerCase());
    const res = [];
    state.rulesData.forEach(e => {
        const score = terms.filter(t => e.search.includes(t)).length;
        if (score > 0) res.push({ ...e, score });
    });
    res.sort((a, b) => b.score - a.score);
    return res.slice(0, 12);
}

function extractKeywords(text) {
    const kw = new Set();
    const patterns = [/ã€([^ã€‘]+)ã€‘/g, /ã€Œ([^ã€]+)ã€/g, /ã€([^ã€]+)ã€/g, /ç‰¹æ®Šèƒ½åŠ›[ï¼š:]\s*(\S+)/g, /å°ˆé•·[ï¼š:]\s*(\S+)/g];
    patterns.forEach(p => { let m; while ((m = p.exec(text)) !== null) if (m[1]?.length > 1 && m[1].length < 20) kw.add(m[1]); });
    ['å‚³å¥‡å±¬æ€§', 'åŸºå› é–', 'é™„åŠ æˆåŠŸ', 'ç ´ç”²', 'ç ´é­”'].forEach(t => { if (text.includes(t)) kw.add(t); });
    return Array.from(kw);
}

// ===== Google Sheets =====
async function fetchSheets() {
    const key = getKey('sheets');
    const url = sanitize(document.getElementById('sheetsUrl').value, 500);
    if (!url) { showError('analyzeError', 'è«‹è²¼ä¸Šé€£çµ'); return; }
    const id = extractSheetId(url);
    if (!id) { showError('analyzeError', 'ç„¡æ•ˆé€£çµ'); return; }
    showLoading('è®€å–è©¦ç®—è¡¨...');
    hideError('analyzeError');
    try {
        const meta = await (await fetch(CONFIG.SHEETS_API + '/' + id + '?key=' + key)).json();
        if (meta.error) throw new Error(meta.error.message);
        const sheets = meta.sheets || [];
        if (!sheets.length) throw new Error('ç„¡åˆ†é ');
        displaySheetTabs(sheets);
        state.sheetsData = {};
        for (const s of sheets) {
            const title = s.properties.title;
            showLoading('è®€å–ï¼š' + title);
            const [dataRes, notesRes] = await Promise.all([
                fetch(CONFIG.SHEETS_API + '/' + id + '/values/' + encodeURIComponent(title) + '?key=' + key),
                fetch(CONFIG.SHEETS_API + '/' + id + '?ranges=' + encodeURIComponent(title) + '&fields=sheets(data(rowData(values(note))))&key=' + key)
            ]);
            if (dataRes.ok) {
                const data = await dataRes.json();
                const notes = notesRes.ok ? extractNotes(await notesRes.json()) : {};
                state.sheetsData[title] = { values: data.values || [], notes };
            }
        }
        updatePreview();
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('analyzeError', 'è®€å–å¤±æ•—ï¼š' + e.message);
    }
}

function extractSheetId(url) {
    const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/) || url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : null;
}

function extractNotes(data) {
    const notes = {};
    const rows = data?.sheets?.[0]?.data?.[0]?.rowData;
    if (!rows) return notes;
    rows.forEach((r, ri) => r.values?.forEach((c, ci) => { if (c.note) notes[ri + '-' + ci] = c.note; }));
    return notes;
}

function displaySheetTabs(sheets) {
    const el = document.getElementById('sheetTabs');
    el.innerHTML = sheets.map(s => '<button class="tag selected" onclick="toggleSheet(this,\'' + escapeHtml(s.properties.title) + '\')">' + escapeHtml(s.properties.title) + '</button>').join('');
    document.getElementById('sheetSelector').style.display = 'block';
    state.selectedSheets = new Set(sheets.map(s => s.properties.title));
}

function toggleSheet(btn, name) {
    btn.classList.toggle('selected');
    state.selectedSheets.has(name) ? state.selectedSheets.delete(name) : state.selectedSheets.add(name);
    updatePreview();
}

function updatePreview() {
    const box = document.getElementById('previewBox');
    const content = document.getElementById('previewContent');
    const stats = document.getElementById('previewStats');
    if (!state.sheetsData || !state.selectedSheets.size) { box.style.display = 'none'; state.charText = ''; return; }
    let html = '', cells = 0, notes = 0;
    state.selectedSheets.forEach(name => {
        const s = state.sheetsData[name];
        if (!s) return;
        cells += s.values.flat().filter(v => v).length;
        notes += Object.keys(s.notes).length;
        html += '<div class="char-card"><h4>ğŸ“‹ ' + escapeHtml(name) + '</h4><div style="font-size:0.8rem; color:var(--text-secondary); max-height:80px; overflow:hidden;">' + s.values.slice(0, 8).map(r => escapeHtml(r.filter(c => c).join(' | ').substring(0, 120))).join('<br>') + '</div>' + (Object.keys(s.notes).length ? '<div class="notes">' + Object.values(s.notes).slice(0, 2).map(n => escapeHtml(n.substring(0, 60))).join(' / ') + '</div>' : '') + '</div>';
    });
    content.innerHTML = html;
    stats.textContent = state.selectedSheets.size + ' è§’è‰² Â· ' + cells + ' æ ¼ Â· ' + notes + ' å‚™è¨»';
    box.style.display = 'block';
    state.charText = buildCharText();
}

function buildCharText() {
    if (!state.sheetsData) return '';
    let t = '';
    state.selectedSheets.forEach(name => {
        const s = state.sheetsData[name];
        if (!s) return;
        t += '\n\n===== è§’è‰²ï¼š' + name + ' =====\n\n';
        s.values.forEach((row, ri) => {
            const rt = row.map((c, ci) => { let x = c || ''; const n = s.notes[ri + '-' + ci]; if (n) x += 'ã€å‚™è¨»ï¼š' + n + 'ã€‘'; return x; }).filter(c => c).join('\t');
            if (rt.trim()) t += rt + '\n';
        });
    });
    return t;
}

// ===== è§’å¡åˆ†æ =====
async function analyzeCharacters() {
    const key = getKey('gemini');
    const textInput = sanitize(document.getElementById('textInput').value);
    const finalText = state.charText || textInput;
    if (!finalText) { showError('analyzeError', 'è«‹å…ˆè¼¸å…¥è§’å¡è³‡æ–™'); return; }
    showLoading('AI åˆ†æä¸­...');
    hideError('analyzeError');
    try {
        const kw = extractKeywords(finalText);
        const rules = searchRules(kw);
        const prompt = buildPrompt(finalText, rules);
        const result = await callGemini(prompt, key);
        state.lastAnalysis = { data: result, time: Date.now(), kw };
        saveHistory(result);
        displayResults(result);
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('analyzeError', 'åˆ†æå¤±æ•—ï¼š' + e.message);
    }
}

function buildPrompt(charData, rules) {
    let rc = '';
    if (rules.length) {
        rc = '\n\n## ç›¸é—œè¦å‰‡\n';
        let len = 0;
        for (const r of rules) {
            const t = 'ã€' + (r.filename || r.category) + 'ã€‘\n' + r.content.substring(0, 500) + '\n\n';
            if (len + t.length > CONFIG.MAX_RULES) break;
            rc += t;
            len += t.length;
        }
    }
    return 'ä½ æ˜¯ç„¡é™ææ€– TRPG è³‡æ·± STï¼Œè«‹åˆ†æè§’è‰²å¡ã€‚\n\n## è§’è‰²è³‡æ–™\n' + charData.substring(0, 20000) + rc + '\n\nè«‹ç”¨ JSON å›è¦†ï¼š\n```json\n{"characters":[{"name":"è§’è‰²å","powerLevel":"S/A/B/C/D","summary":"å®šä½","stats":{"offense":1-10,"defense":1-10,"mobility":1-10,"control":1-10,"sustain":1-10,"utility":1-10},"coreAbilities":["èƒ½åŠ›"],"warnings":["âš ï¸è­¦å‘Š"],"weaknesses":["å¼±é»"],"suggestions":["å»ºè­°"],"relatedRules":["é—œéµå­—"]}],"teamSummary":{"overallPower":"è©•ä¼°","composition":"çµ„æˆ","synergies":["combo"],"gaps":["ç¼ºå¤±"]}}\n```\nè©•ç´šï¼šS=ç§’æ®ºBOSS, A=é«˜å„ªåŒ–, B=æœ‰å¼·é …, C=å‡è¡¡, D=æ–°æ‰‹\nç”¨ç¹é«”ä¸­æ–‡ï¼Œæ³¨æ„å‚™è¨»ä¸­çš„éš±è—èƒ½åŠ›ã€‚';
}

async function callGemini(prompt, key) {
    const res = await fetch(CONFIG.GEMINI_API + '?key=' + key, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 8192 } })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || 'APIå¤±æ•—'); }
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('ç„¡å›æ‡‰');
    const m = text.match(/```json\s*([\s\S]*?)\s*```/);
    if (m) return JSON.parse(m[1]);
    try { return JSON.parse(text); } catch { return { raw: text }; }
}

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    const section = document.getElementById('analyzeResults');
    if (data.raw) { container.innerHTML = '<div style="white-space:pre-wrap;">' + escapeHtml(data.raw) + '</div>'; section.style.display = 'block'; return; }
    if (data.characters?.length) renderRadar(data.characters);
    let html = '';
    data.characters?.forEach(c => { html += renderChar(c); });
    if (data.teamSummary) html += renderTeam(data.teamSummary);
    container.innerHTML = html;
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
    updateTrackSelect(data.characters);
}

function renderChar(c) {
    const lv = c.powerLevel?.charAt(0) || 'C';
    return '<div class="result-card"><div class="result-header"><span class="result-name">' + escapeHtml(c.name || '?') + '</span><span class="power-level ' + lv + '">' + escapeHtml(c.powerLevel || '?') + '</span></div><div class="result-body"><p style="color:var(--text-secondary); margin-bottom:12px;">' + escapeHtml(c.summary || '') + '</p>' + (c.coreAbilities?.length ? '<div class="result-section"><h4>âš”ï¸ æ ¸å¿ƒèƒ½åŠ›</h4><ul>' + c.coreAbilities.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul></div>' : '') + (c.warnings?.length ? '<div class="result-section"><h4>âš ï¸ STè­¦å‘Š</h4><ul>' + c.warnings.map(w => '<li class="warning">' + escapeHtml(w) + '</li>').join('') + '</ul></div>' : '') + (c.weaknesses?.length ? '<div class="result-section"><h4>ğŸ¯ å¼±é»</h4><ul>' + c.weaknesses.map(w => '<li class="weakness">' + escapeHtml(w) + '</li>').join('') + '</ul></div>' : '') + (c.suggestions?.length ? '<div class="result-section"><h4>ğŸ’¡ å»ºè­°</h4><ul>' + c.suggestions.map(s => '<li class="success">' + escapeHtml(s) + '</li>').join('') + '</ul></div>' : '') + (c.relatedRules?.length ? '<div class="rule-tags">' + c.relatedRules.map(r => '<button class="rule-tag" onclick="window.open(\'index.html?q=' + encodeURIComponent(r) + '\',\'_blank\')">' + escapeHtml(r) + '</button>').join('') + '</div>' : '') + '</div></div>';
}

function renderTeam(s) {
    return '<div class="result-card" style="border-top:3px solid var(--accent-gold);"><div class="result-header" style="background:linear-gradient(135deg,rgba(212,160,32,0.15),var(--bg-card));"><span class="result-name">ğŸ“Š éšŠä¼ç¸½è©•</span></div><div class="result-body"><p style="margin-bottom:8px;"><strong>æ•´é«”ï¼š</strong>' + escapeHtml(s.overallPower || '') + '</p><p style="margin-bottom:12px;"><strong>çµ„æˆï¼š</strong>' + escapeHtml(s.composition || '') + '</p>' + (s.synergies?.length ? '<div class="result-section"><h4>ğŸ”— Combo</h4><ul>' + s.synergies.map(x => '<li>' + escapeHtml(x) + '</li>').join('') + '</ul></div>' : '') + (s.gaps?.length ? '<div class="result-section"><h4>âš¡ è£œå¼·</h4><ul>' + s.gaps.map(x => '<li class="weakness">' + escapeHtml(x) + '</li>').join('') + '</ul></div>' : '') + '</div></div>';
}

function renderRadar(chars) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    if (state.radarChart) state.radarChart.destroy();
    const colors = ['rgba(196,30,58,0.7)', 'rgba(212,160,32,0.7)', 'rgba(155,89,182,0.7)', 'rgba(52,152,219,0.7)', 'rgba(46,213,115,0.7)', 'rgba(255,107,53,0.7)'];
    const datasets = chars.slice(0, 6).map((c, i) => ({
        label: c.name || 'è§’è‰²' + (i + 1),
        data: [c.stats?.offense || 5, c.stats?.defense || 5, c.stats?.mobility || 5, c.stats?.control || 5, c.stats?.sustain || 5, c.stats?.utility || 5],
        borderColor: colors[i],
        backgroundColor: colors[i].replace('0.7', '0.2'),
        borderWidth: 2,
        pointRadius: 3,
    }));
    state.radarChart = new Chart(ctx, {
        type: 'radar',
        data: { labels: ['è¼¸å‡º', 'é˜²ç¦¦', 'æ©Ÿå‹•', 'æ§åˆ¶', 'çºŒèˆª', 'åŠŸèƒ½'], datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { min: 0, max: 10, ticks: { stepSize: 2, color: '#606070' }, grid: { color: '#333340' }, pointLabels: { color: '#a0a0b0', font: { size: 11 } } } },
            plugins: { legend: { position: 'bottom', labels: { color: '#e8e8f0', padding: 12, font: { size: 11 } } } }
        }
    });
}

// ===== BOSS æ¨¡æ“¬ =====
async function simulateBoss() {
    if (!state.lastAnalysis?.data?.characters?.length) { showError('bossError', 'è«‹å…ˆå®Œæˆè§’å¡åˆ†æ'); return; }
    const key = getKey('gemini');
    const boss = {
        hp: parseInt(document.getElementById('bossHp').value) || 50,
        def: parseInt(document.getElementById('bossDef').value) || 20,
        atk: parseInt(document.getElementById('bossAtk').value) || 15,
        dmg: parseInt(document.getElementById('bossDmg').value) || 10,
        init: parseInt(document.getElementById('bossInit').value) || 10,
        resist: parseInt(document.getElementById('bossResist').value) || 0,
        abilities: sanitize(document.getElementById('bossAbilities').value, 800)
    };
    showLoading('æ¨¡æ“¬æˆ°é¬¥...');
    hideError('bossError');
    try {
        const charSum = state.lastAnalysis.data.characters.map(c => c.name + ':' + c.powerLevel + ',' + c.summary).join('\n');
        const prompt = 'ä½œç‚ºç„¡é™ææ€–STï¼Œåˆ†æä»¥ä¸‹BOSSæˆ°ï¼š\n\nBOSS: HP=' + boss.hp + ', é˜²ç¦¦=' + boss.def + ', æ”»æ“Š=' + boss.atk + ', å‚·å®³=' + boss.dmg + ', å…ˆæ”»=' + boss.init + (boss.abilities ? ', èƒ½åŠ›=' + boss.abilities : '') + '\n\nç©å®¶:\n' + charSum + '\n\nåŸå§‹æ•¸æ“š:\n' + (state.charText?.substring(0, 8000) || '') + '\n\nç”¨JSONå›è¦†ï¼š\n```json\n{"predictions":[{"name":"è§’è‰²","rounds":"å›åˆæ•¸","threat":"danger/warning/safe","reason":"åŸå› "}],"bossAdjustments":{"recommendedHp":æ•¸å€¼,"recommendedDef":æ•¸å€¼,"mechanics":["æ©Ÿåˆ¶"],"warnings":["æ³¨æ„"]},"tips":["å»ºè­°"]}\n```\nthreat: danger=1-2å›åˆç§’, warning=3-5å›åˆ, safe=è¼ƒä¹…ã€‚ç¹ä¸­å›ç­”ã€‚';
        const result = await callGemini(prompt, key);
        displayBossResult(result);
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('bossError', 'æ¨¡æ“¬å¤±æ•—ï¼š' + e.message);
    }
}

function displayBossResult(data) {
    const content = document.getElementById('bossResultContent');
    const tips = document.getElementById('bossTips');
    const box = document.getElementById('bossResult');
    if (data.raw) { content.innerHTML = '<div style="white-space:pre-wrap;">' + escapeHtml(data.raw) + '</div>'; box.style.display = 'block'; return; }
    let html = '';
    data.predictions?.forEach(p => {
        html += '<div class="sim-row"><span style="font-weight:600;">' + escapeHtml(p.name) + '</span><span class="sim-badge ' + p.threat + '">' + escapeHtml(p.rounds) + ' å›åˆ</span></div><div style="font-size:0.8rem; color:var(--text-dim); padding:4px 0 12px; border-bottom:1px solid var(--border);">' + escapeHtml(p.reason) + '</div>';
    });
    content.innerHTML = html;
    box.style.display = 'block';
    let th = '';
    if (data.bossAdjustments) {
        const a = data.bossAdjustments;
        th += '<p style="margin-bottom:8px;"><strong>å»ºè­°HP:</strong> <span style="color:var(--accent-ember);">' + (a.recommendedHp || 'â€”') + '</span> | <strong>å»ºè­°é˜²ç¦¦:</strong> <span style="color:var(--accent-ember);">' + (a.recommendedDef || 'â€”') + '</span></p>';
        if (a.mechanics?.length) th += '<p style="margin-bottom:8px;"><strong>å»ºè­°æ©Ÿåˆ¶:</strong> ' + a.mechanics.map(m => escapeHtml(m)).join('ã€') + '</p>';
        if (a.warnings?.length) th += '<p style="color:var(--danger);"><strong>âš ï¸ æ³¨æ„:</strong> ' + a.warnings.map(w => escapeHtml(w)).join('ã€') + '</p>';
    }
    if (data.tips?.length) th += '<div style="margin-top:12px;"><strong>ğŸ’¡ è¨­è¨ˆå»ºè­°:</strong><ul style="margin-top:6px; padding-left:18px;">' + data.tips.map(t => '<li style="margin-bottom:4px;">' + escapeHtml(t) + '</li>').join('') + '</ul></div>';
    tips.innerHTML = th || '<p style="color:var(--text-dim);">ç„¡é¡å¤–å»ºè­°</p>';
}

// ===== è¦å‰‡å•ç­” =====
async function sendChat() {
    const input = document.getElementById('chatInput');
    const q = sanitize(input.value, 500);
    if (!q) return;
    input.value = '';
    const msgs = document.getElementById('chatMessages');
    msgs.innerHTML += '<div class="chat-msg user"><div class="chat-avatar">ğŸ‘¤</div><div class="chat-bubble">' + escapeHtml(q) + '</div></div>';
    msgs.scrollTop = msgs.scrollHeight;
    try {
        const key = getKey('gemini');
        const rules = searchRules(q.split(/\s+/));
        let rc = '';
        if (rules.length) {
            rc = '\n\nç›¸é—œè¦å‰‡ï¼š\n';
            rules.slice(0, 8).forEach(r => { rc += 'ã€' + r.filename + 'ã€‘' + r.content.substring(0, 400) + '\n'; });
        }
        const prompt = 'ä½ æ˜¯ç„¡é™ææ€–TRPGè¦å‰‡å°ˆå®¶ã€‚å›ç­”ä»¥ä¸‹å•é¡Œï¼Œç”¨ç¹é«”ä¸­æ–‡ï¼Œç°¡æ½”æ˜ç­ã€‚\n\nå•é¡Œï¼š' + q + rc;
        const result = await callGemini(prompt, key);
        const ans = result.raw || (typeof result === 'string' ? result : JSON.stringify(result));
        msgs.innerHTML += '<div class="chat-msg ai"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble">' + escapeHtml(ans).replace(/\n/g, '<br>') + '</div></div>';
    } catch (e) {
        msgs.innerHTML += '<div class="chat-msg ai"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble" style="color:var(--danger);">éŒ¯èª¤ï¼š' + escapeHtml(e.message) + '</div></div>';
    }
    msgs.scrollTop = msgs.scrollHeight;
}

// ===== NPC ç”Ÿæˆ =====
async function generateNPC() {
    const key = getKey('gemini');
    const diff = document.getElementById('npcDiff').value;
    const type = document.getElementById('npcType').value;
    const desc = sanitize(document.getElementById('npcDesc').value, 300);
    showLoading('ç”ŸæˆNPC...');
    hideError('npcError');
    try {
        const prompt = 'ç‚ºç„¡é™ææ€–TRPGç”Ÿæˆä¸€å€‹NPCæ•µäººã€‚\né›£åº¦ï¼š' + diff + '\né¡å‹ï¼š' + type + (desc ? '\næè¿°ï¼š' + desc : '') + '\n\nè«‹æä¾›ï¼š\n1. åç¨±å’Œæè¿°\n2. å±¬æ€§æ•¸å€¼ï¼ˆåŠ›é‡ã€æ•æ·ã€è€åŠ›ã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€æ±ºå¿ƒï¼‰\n3. ç”Ÿå‘½å€¼ã€é˜²ç¦¦ã€æ”»æ“Šæª¢å®šã€å‚·å®³ã€å…ˆæ”»\n4. ç‰¹æ®Šèƒ½åŠ›ï¼ˆ2-3å€‹ï¼‰\n5. æˆ°è¡“å»ºè­°\n\nç”¨ç¹é«”ä¸­æ–‡ï¼Œæ ¼å¼æ¸…æ™°ã€‚';
        const result = await callGemini(prompt, key);
        const text = result.raw || (typeof result === 'string' ? result : JSON.stringify(result, null, 2));
        document.getElementById('npcOutput').style.display = 'block';
        document.getElementById('npcOutput').textContent = text;
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('npcError', 'ç”Ÿæˆå¤±æ•—ï¼š' + e.message);
    }
}

// ===== è¨­è¨ˆæª¢æŸ¥ =====
function toggleCheck(li) {
    li.classList.toggle('checked');
    li.querySelector('.check-icon').textContent = li.classList.contains('checked') ? 'â˜‘' : 'â˜';
}

function resetChecklist() {
    document.querySelectorAll('#checklistItems li').forEach(li => {
        li.classList.remove('checked');
        li.querySelector('.check-icon').textContent = 'â˜';
    });
}

async function getEncounterTips() {
    const desc = sanitize(document.getElementById('encounterDesc').value, 1000);
    if (!desc) { showError('encounterError', 'è«‹æè¿°é­é‡'); return; }
    const key = getKey('gemini');
    showLoading('åˆ†æä¸­...');
    hideError('encounterError');
    try {
        let charInfo = '';
        if (state.lastAnalysis?.data?.characters) {
            charInfo = '\n\nç©å®¶éšŠä¼ï¼š\n' + state.lastAnalysis.data.characters.map(c => c.name + '(' + c.powerLevel + '): ' + c.summary).join('\n');
        }
        const prompt = 'ä½œç‚ºç„¡é™ææ€–STï¼Œç‚ºä»¥ä¸‹é­é‡æä¾›è¨­è¨ˆå»ºè­°ï¼š\n\n' + desc + charInfo + '\n\nè«‹æä¾›ï¼š\n1. é­é‡å¹³è¡¡å»ºè­°\n2. æ•µäººé…ç½®å»ºè­°\n3. ç‰¹æ®Šæ©Ÿåˆ¶å»ºè­°\n4. å¯èƒ½çš„å•é¡Œå’Œå°ç­–\n5. æˆ²åŠ‡æ€§å¢å¼·å»ºè­°\n\nç”¨ç¹é«”ä¸­æ–‡ã€‚';
        const result = await callGemini(prompt, key);
        const text = result.raw || (typeof result === 'string' ? result : JSON.stringify(result));
        document.getElementById('encounterTips').style.display = 'block';
        document.getElementById('encounterTips').innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
        hideLoading();
    } catch (e) {
        hideLoading();
        showError('encounterError', 'å¤±æ•—ï¼š' + e.message);
    }
}

// ===== æ­·å²ç´€éŒ„ =====
function loadHistory() {
    try {
        const h = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'history');
        if (h) state.history = JSON.parse(h);
    } catch (e) { state.history = []; }
}

function saveHistory(data) {
    if (!data?.characters?.length) return;
    const item = {
        id: Date.now(),
        time: new Date().toLocaleString('zh-TW'),
        chars: data.characters.map(c => ({ name: c.name, level: c.powerLevel })),
        data
    };
    state.history.unshift(item);
    if (state.history.length > CONFIG.MAX_HISTORY) state.history = state.history.slice(0, CONFIG.MAX_HISTORY);
    localStorage.setItem(CONFIG.STORAGE_PREFIX + 'history', JSON.stringify(state.history));
    renderHistory();
}

function renderHistory() {
    const el = document.getElementById('historyList');
    if (!state.history.length) { el.innerHTML = '<p style="color:var(--text-dim); text-align:center; padding:30px;">å°šç„¡ç´€éŒ„</p>'; return; }
    el.innerHTML = state.history.map(h => '<div class="history-item" onclick="loadHistoryItem(' + h.id + ')"><div class="history-header"><span class="history-title">' + h.chars.map(c => escapeHtml(c.name) + '(' + c.level + ')').join(', ') + '</span><span class="history-date">' + escapeHtml(h.time) + '</span></div></div>').join('');
}

function loadHistoryItem(id) {
    const item = state.history.find(h => h.id === id);
    if (item?.data) {
        state.lastAnalysis = { data: item.data, time: item.id };
        displayResults(item.data);
        switchPage('analyze');
    }
}

function clearHistory() {
    if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Ÿ')) {
        state.history = [];
        localStorage.removeItem(CONFIG.STORAGE_PREFIX + 'history');
        renderHistory();
    }
}

function updateTrackSelect(chars) {
    const sel = document.getElementById('trackSelect');
    if (!chars?.length) return;
    sel.innerHTML = '<option value="">-- é¸æ“‡è§’è‰² --</option>' + chars.map(c => '<option value="' + escapeHtml(c.name) + '">' + escapeHtml(c.name) + '</option>').join('');
}

// ===== åŒ¯å‡º =====
function exportResults(format) {
    if (!state.lastAnalysis?.data) return;
    const data = state.lastAnalysis.data;
    if (format === 'discord') {
        let text = '**ğŸ“Š è§’å¡åˆ†æçµæœ**\n\n';
        data.characters?.forEach(c => {
            text += '**' + c.name + '** [' + c.powerLevel + ']\n' + c.summary + '\n';
            if (c.warnings?.length) text += 'âš ï¸ ' + c.warnings.join('\nâš ï¸ ') + '\n';
            text += '\n';
        });
        if (data.teamSummary) text += '**éšŠä¼ç¸½è©•:** ' + data.teamSummary.overallPower + '\n';
        navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'));
    } else {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analysis_' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }
}

// ===== å·¥å…· =====
function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.classList.add('show'); }
function hideError(id) { document.getElementById(id).classList.remove('show'); }
</script>
</body>
</html>

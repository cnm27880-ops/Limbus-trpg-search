<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ===== å®‰å…¨æ¨™é ­ (é€é meta tag å¯¦ç¾) ===== -->
    <!-- Content Security Policy: é™åˆ¶è³‡æºè¼‰å…¥ä¾†æº -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' https://raw.githubusercontent.com;
        frame-ancestors 'none';
        form-action 'self';
        base-uri 'self';
    ">
    <!-- é˜²æ­¢ MIME é¡å‹å—…æ¢æ”»æ“Š -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- é˜²æ­¢è¢«åµŒå…¥ iframe (é»æ“ŠåŠ«æŒ) -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <!-- å¼·åˆ¶ HTTPS -->
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <!-- XSS éæ¿¾å™¨ -->
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <!-- Referrer æ”¿ç­– -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <title>ç„¡é™ææ€– TRPG è¦å‰‡æ›¸æœå°‹å™¨</title>
    
    <style>
        :root {
            /* Limbus Company é¢¨æ ¼é…è‰² - è­·çœ¼ç‰ˆ */
            --bg-base: #121214;
            --bg-elevated: #1a1a1e;
            --bg-card: #222228;
            --bg-hover: #2a2a32;
            --accent-orange: #e07030;
            --accent-orange-dim: #a05020;
            --accent-red: #c02030;
            --accent-red-dim: #801520;
            --accent-gold: #d4a020;
            --text-primary: #e8e8ec;
            --text-secondary: #a0a0a8;
            --text-dim: #606068;
            --border: #353540;
            --border-light: #454550;
            --highlight: #ffd060;
            --success: #40a060;
            --error: #e04040;
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-orange-dim); }
        
        /* ===== é ‚éƒ¨æ¨™é¡Œ ===== */
        header {
            background: linear-gradient(135deg, var(--accent-red-dim) 0%, #1a1015 50%, var(--bg-elevated) 100%);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 2px solid var(--accent-red);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px, transparent 100px,
                rgba(192, 32, 48, 0.03) 100px, rgba(192, 32, 48, 0.03) 101px
            );
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--text-primary);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        /* æ·±ç´…è‰²å·´å£«åœ–æ¨™ (SVG) */
        .bus-icon {
            width: 48px;
            height: 48px;
            filter: drop-shadow(0 0 8px rgba(192, 32, 48, 0.6));
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 8px;
            letter-spacing: 1px;
        }
        
        /* ===== ä¸»å®¹å™¨ ===== */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 25px 20px;
        }
        
        /* ===== è¼‰å…¥ç‹€æ…‹å€ ===== */
        .load-status-bar {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-dim);
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.loading { background: var(--accent-orange); }
        .status-indicator.success { background: var(--success); animation: none; }
        .status-indicator.error { background: var(--error); animation: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .status-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        .status-text.success { color: var(--success); }
        .status-text.error { color: var(--error); }
        
        .retry-btn {
            padding: 8px 18px;
            background: var(--accent-orange-dim);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }
        
        .retry-btn:hover { background: var(--accent-orange); }
        .retry-btn.show { display: inline-block; }
        
        /* æ‰‹å‹•è¼‰å…¥å‚™ç”¨ */
        .fallback-upload {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
            display: none;
        }
        
        .fallback-upload.show { display: block; }
        
        .fallback-hint {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0; top: 0;
            opacity: 0;
            width: 100%; height: 100%;
            cursor: pointer;
        }
        
        .file-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-btn:hover {
            background: var(--accent-orange-dim);
            border-color: var(--accent-orange-dim);
            color: white;
        }
        
        /* ===== æœå°‹å€ ===== */
        .search-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .search-section.enabled {
            opacity: 1;
            pointer-events: auto;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-title {
            font-size: 1.1rem;
            color: var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bookmark-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--accent-gold);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bookmark-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }
        
        .bookmark-btn .count {
            background: var(--accent-gold);
            color: var(--bg-base);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 16px 20px;
            font-size: 1.05rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(224, 112, 48, 0.15);
        }
        
        .search-input::placeholder { color: var(--text-dim); }
        
        .search-btn {
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-orange-dim) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            filter: brightness(1.15);
            transform: translateY(-2px);
        }
        
        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .search-tips {
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 12px 15px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent-orange-dim);
        }
        
        .search-tips code {
            background: var(--bg-hover);
            color: var(--accent-gold);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* å¿«æ·æ¨™ç±¤ */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid var(--border);
        }
        
        .quick-tags-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-right: 5px;
            display: flex;
            align-items: center;
        }
        
        .quick-tag {
            padding: 7px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-tag:hover {
            background: var(--accent-orange-dim);
            border-color: var(--accent-orange);
            color: white;
            transform: translateY(-2px);
        }
        
        /* ===== çµæœå€ ===== */
        .results-container { min-height: 200px; }
        
        .results-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .stats-count {
            font-size: 1.05rem;
            color: var(--text-secondary);
        }
        
        .stats-count strong {
            color: var(--accent-gold);
            font-size: 1.3rem;
            margin: 0 3px;
        }
        
        .stats-time {
            color: var(--text-dim);
            font-size: 0.85rem;
        }
        
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .result-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 22px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent-orange-dim);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .result-card:hover {
            border-left-color: var(--accent-orange);
            background: var(--bg-hover);
            transform: translateX(4px);
        }
        
        .result-card.bookmarked { border-left-color: var(--accent-gold); }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .result-title-area { flex: 1; }
        
        .result-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .result-category {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-elevated);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            color: var(--text-dim);
            border: 1px solid var(--border);
        }
        
        .result-actions { display: flex; gap: 8px; }
        
        .star-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .star-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }
        
        .star-btn.active {
            background: rgba(212, 160, 32, 0.15);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }
        
        .result-content {
            font-size: 0.95rem;
            line-height: 1.85;
            color: var(--text-secondary);
            max-height: 180px;
            overflow: hidden;
            position: relative;
            padding: 15px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .result-content.expanded { max-height: none; }
        
        .result-content::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: linear-gradient(transparent, var(--bg-elevated));
            pointer-events: none;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        }
        
        .result-content.expanded::after { display: none; }
        
        .result-content mark {
            background: linear-gradient(135deg, var(--highlight) 0%, #e0a020 100%);
            color: var(--bg-base);
            padding: 1px 5px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .expand-btn, .link-btn {
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.88rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .expand-btn {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }
        
        .expand-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-orange-dim);
            color: var(--text-primary);
        }
        
        .link-btn {
            background: var(--accent-orange-dim);
            border-color: var(--accent-orange-dim);
            color: white;
            text-decoration: none;
        }
        
        .link-btn:hover {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
        }
        
        /* ===== åˆ†é  ===== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .page-btn {
            min-width: 42px;
            height: 42px;
            padding: 0 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--accent-orange-dim);
            color: var(--text-primary);
        }
        
        .page-btn.active {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
            font-weight: 600;
        }
        
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* ===== ç„¡çµæœ ===== */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        
        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .no-results h3 {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        /* ===== æ›¸ç±¤é¢æ¿ ===== */
        .bookmark-panel {
            position: fixed;
            top: 0; right: -450px;
            width: 420px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-elevated);
            border-left: 2px solid var(--accent-gold);
            z-index: 1000;
            transition: right 0.35s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0,0,0,0.5);
        }
        
        .bookmark-panel.open { right: 0; }
        
        .bookmark-panel-header {
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bookmark-panel-title {
            font-size: 1.2rem;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-panel-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-panel-btn:hover {
            background: var(--accent-red-dim);
            border-color: var(--accent-red);
            color: white;
        }
        
        .bookmark-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .bookmark-item {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent-gold);
        }
        
        .bookmark-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .bookmark-item-title {
            font-weight: 600;
            color: var(--accent-orange);
            font-size: 0.95rem;
            flex: 1;
        }
        
        .remove-bookmark-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
            transition: color 0.2s;
        }
        
        .remove-bookmark-btn:hover { color: var(--accent-red); }
        
        .bookmark-item-preview {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.6;
            max-height: 60px;
            overflow: hidden;
        }
        
        .bookmark-item-link {
            display: inline-block;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--accent-orange-dim);
            text-decoration: none;
        }
        
        .bookmark-item-link:hover {
            color: var(--accent-orange);
            text-decoration: underline;
        }
        
        .bookmark-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }
        
        /* é®ç½© */
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .overlay.show { opacity: 1; visibility: visible; }
        
        /* ===== é å°¾ ===== */
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 0.8rem;
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }
        
        footer a {
            color: var(--accent-orange-dim);
            text-decoration: none;
        }
        
        footer a:hover { text-decoration: underline; }
        
        /* ===== RWD ===== */
        @media (max-width: 768px) {
            h1 { font-size: 1.4rem; letter-spacing: 1px; }
            .bus-icon { width: 36px; height: 36px; }
            .container { padding: 15px; }
            .search-box { flex-direction: column; }
            .search-btn { width: 100%; justify-content: center; }
            .result-header { flex-direction: column; }
            .result-actions { position: absolute; top: 15px; right: 15px; }
            .result-footer { flex-direction: column; }
            .result-footer > * { width: 100%; text-align: center; justify-content: center; }
            .results-stats { flex-direction: column; gap: 8px; text-align: center; }
            .search-header { flex-direction: column; align-items: stretch; }
            .bookmark-btn { justify-content: center; }
            .load-status-bar { flex-direction: column; text-align: center; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>
            <!-- æ·±ç´…è‰²å·´å£« SVG åœ–æ¨™ -->
            <svg class="bus-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <!-- è»Šèº«ä¸»é«” -->
                <rect x="4" y="18" width="56" height="28" rx="4" fill="#8B1E3F"/>
                <!-- è»Šé ‚ -->
                <rect x="8" y="14" width="48" height="6" rx="2" fill="#6B1830"/>
                <!-- çª—æˆ¶ -->
                <rect x="10" y="22" width="10" height="10" rx="2" fill="#1a1a2e"/>
                <rect x="24" y="22" width="10" height="10" rx="2" fill="#1a1a2e"/>
                <rect x="38" y="22" width="10" height="10" rx="2" fill="#1a1a2e"/>
                <!-- å‰æ“‹é¢¨ç»ç’ƒ -->
                <rect x="50" y="22" width="8" height="12" rx="2" fill="#2a2a3e"/>
                <!-- è»Šé–€ -->
                <rect x="10" y="34" width="8" height="10" rx="1" fill="#6B1830"/>
                <rect x="12" y="36" width="4" height="6" rx="1" fill="#1a1a2e"/>
                <!-- è»Šç‡ˆ -->
                <circle cx="56" cy="40" r="3" fill="#FFD060"/>
                <circle cx="8" cy="40" r="2" fill="#FF4040"/>
                <!-- è¼ªå­ -->
                <circle cx="16" cy="48" r="6" fill="#333"/>
                <circle cx="16" cy="48" r="3" fill="#555"/>
                <circle cx="48" cy="48" r="6" fill="#333"/>
                <circle cx="48" cy="48" r="3" fill="#555"/>
                <!-- è£é£¾ç·šæ¢ -->
                <line x1="4" y1="36" x2="60" y2="36" stroke="#FFD060" stroke-width="1"/>
                <!-- è»Šç‰Œ -->
                <rect x="26" y="40" width="12" height="4" rx="1" fill="#222"/>
                <text x="32" y="43.5" font-size="3" fill="#FFF" text-anchor="middle" font-family="monospace">INF</text>
            </svg>
            <span>ç„¡é™ææ€– TRPG è¦å‰‡æ›¸æœå°‹å™¨</span>
        </h1>
        <p class="subtitle">å…¨æ–‡æª¢ç´¢ Â· æ›¸ç±¤æ”¶è— Â· å¿«é€Ÿå®šä½</p>
    </div>
</header>

<div class="container">
    
    <!-- è¼‰å…¥ç‹€æ…‹ -->
    <div class="load-status-bar" id="loadStatusBar">
        <div class="status-left">
            <div class="status-indicator loading" id="statusIndicator"></div>
            <span class="status-text" id="statusText">æ­£åœ¨è¼‰å…¥è¦å‰‡æ›¸è³‡æ–™...</span>
        </div>
        <button class="retry-btn" id="retryBtn" onclick="loadData()">ğŸ”„ é‡è©¦</button>
        
        <div class="fallback-upload" id="fallbackUpload">
            <div class="fallback-hint">âš ï¸ è‡ªå‹•è¼‰å…¥å¤±æ•—ï¼Ÿå¯æ‰‹å‹•é¸æ“‡æª”æ¡ˆï¼š</div>
            <div class="file-input-wrapper">
                <div class="file-btn">ğŸ“„ é¸æ“‡ txt æª”æ¡ˆ</div>
                <input type="file" id="fileInput" accept=".txt">
            </div>
        </div>
    </div>
    
    <!-- æœå°‹å€ -->
    <div class="search-section" id="searchSection">
        <div class="search-header">
            <div class="search-title">
                <span>ğŸ”</span>
                <span>è¦å‰‡æœå°‹</span>
            </div>
            <button class="bookmark-btn" id="bookmarkBtn" onclick="toggleBookmarkPanel()">
                <span>â­</span>
                <span>æˆ‘çš„æ›¸ç±¤</span>
                <span class="count" id="bookmarkCount">0</span>
            </button>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" 
                   placeholder="è¼¸å…¥é—œéµå­—æœå°‹... (ä¾‹å¦‚: åˆ€åŠã€ç”Ÿå‘½å€¼ã€æ§æ¢°)"
                   maxlength="100"
                   autocomplete="off">
            <button class="search-btn" id="searchBtn" onclick="performSearch()" disabled>
                <span>ğŸ”</span>
                <span>æœå°‹</span>
            </button>
        </div>
        
        <div class="search-tips">
            ğŸ’¡ æœå°‹æŠ€å·§ï¼šç”¨ <code>ç©ºæ ¼</code> åŒæ™‚åŒ…å«å¤šå€‹è© | ç”¨ <code>|</code> ç¬¦è™Ÿè¡¨ç¤ºã€Œæˆ–ã€
        </div>
        
        <div class="quick-tags">
            <span class="quick-tags-label">âš¡ å¿«é€Ÿæœå°‹ï¼š</span>
            <button class="quick-tag" onclick="quickSearch('ç”Ÿå‘½å€¼')">ç”Ÿå‘½å€¼</button>
            <button class="quick-tag" onclick="quickSearch('å‚·å®³')">å‚·å®³</button>
            <button class="quick-tag" onclick="quickSearch('é˜²ç¦¦')">é˜²ç¦¦</button>
            <button class="quick-tag" onclick="quickSearch('åˆ€ åŠ')">åˆ€åŠ</button>
            <button class="quick-tag" onclick="quickSearch('æ§')">æ§æ¢°</button>
            <button class="quick-tag" onclick="quickSearch('å¼“')">å¼“ç®­</button>
            <button class="quick-tag" onclick="quickSearch('æ³•è¡“')">æ³•è¡“</button>
            <button class="quick-tag" onclick="quickSearch('è¡€çµ±')">è¡€çµ±</button>
            <button class="quick-tag" onclick="quickSearch('æŠ€èƒ½æ¨¹')">æŠ€èƒ½æ¨¹</button>
            <button class="quick-tag" onclick="quickSearch('é™„åŠ æˆåŠŸ')">é™„åŠ æˆåŠŸ</button>
            <button class="quick-tag" onclick="quickSearch('æª¢å®š')">æª¢å®š</button>
            <button class="quick-tag" onclick="quickSearch('è±å…')">è±å…</button>
        </div>
    </div>
    
    <!-- çµæœå€ -->
    <div class="results-container" id="resultsContainer"></div>
    
</div>

<footer>
    è³‡æ–™ä¾†æºï¼š<a href="https://www.hktrpg.com/INF/2.35Christmas.html" target="_blank" rel="noopener noreferrer">ç„¡é™ææ€– TRPG 2.35 è¦å‰‡æ›¸</a>
    | æœ¬å·¥å…·åƒ…ä¾›å€‹äººå­¸ç¿’ä½¿ç”¨
</footer>

<!-- æ›¸ç±¤é¢æ¿ -->
<div class="overlay" id="overlay" onclick="toggleBookmarkPanel()"></div>
<div class="bookmark-panel" id="bookmarkPanel">
    <div class="bookmark-panel-header">
        <div class="bookmark-panel-title">
            <span>â­</span>
            <span>æˆ‘çš„æ›¸ç±¤</span>
        </div>
        <button class="close-panel-btn" onclick="toggleBookmarkPanel()">âœ•</button>
    </div>
    <div class="bookmark-panel-content" id="bookmarkList"></div>
</div>

<script>
// ===============================================================
// å®‰å…¨æªæ–½èªªæ˜ï¼š
// 1. CSP (Content-Security-Policy) - åœ¨ <head> ä¸­è¨­å®šï¼Œé™åˆ¶è³‡æºä¾†æº
// 2. XSS é˜²è­· - æ‰€æœ‰ä½¿ç”¨è€…è¼¸å…¥éƒ½ç¶“é escapeHtml() è™•ç†
// 3. è¼¸å…¥é©—è­‰ - é™åˆ¶æœå°‹é•·åº¦ã€éæ¿¾ç‰¹æ®Šå­—å…ƒ
// 4. å®‰å…¨çš„ DOM æ“ä½œ - ä½¿ç”¨ textContent è€Œé innerHTML (é—œéµä½ç½®)
// 5. éŒ¯èª¤è™•ç† - ä¸æš´éœ²æŠ€è¡“ç´°ç¯€çµ¦ä½¿ç”¨è€…
// 6. URL é©—è­‰ - åªå…è¨±ç™½åå–®ç¶²åŸŸçš„é€£çµ
// ===============================================================

'use strict';

// ================= é…ç½® =================
const CONFIG = Object.freeze({
    // âš ï¸ è«‹å°‡æ­¤ URL æ”¹ç‚ºä½ çš„ GitHub Raw é€£çµ
    // æ ¼å¼ï¼šhttps://raw.githubusercontent.com/ä½ çš„å¸³è™Ÿ/repoåç¨±/main/è¦å‰‡ç´”æ–‡å­—.txt
    DATA_URL: 'https://cnm27880-ops.github.io/Limbus-trpg-search/',
    
    // å…è¨±çš„å¤–éƒ¨é€£çµç¶²åŸŸ (ç™½åå–®)
    ALLOWED_DOMAINS: ['www.hktrpg.com', 'hktrpg.com'],
    
    // æœå°‹è¨­å®š
    MAX_QUERY_LENGTH: 100,
    MIN_QUERY_LENGTH: 1,
    RESULTS_PER_PAGE: 15,
    DEBOUNCE_MS: 300,
    
    // localStorage key
    STORAGE_KEY: 'inf_trpg_bookmarks_v2'
});

// ================= å…¨å±€ç‹€æ…‹ =================
let allData = [];
let currentResults = [];
let currentPage = 1;
let searchTerms = [];
let bookmarks = {};
let debounceTimer = null;
let isDataLoaded = false;

// ================= å®‰å…¨å·¥å…·å‡½å¼ =================

/**
 * HTML å¯¦é«”ç·¨ç¢¼ - é˜²æ­¢ XSS æ”»æ“Š
 * @param {string} text - åŸå§‹æ–‡å­—
 * @returns {string} - ç·¨ç¢¼å¾Œçš„å®‰å…¨æ–‡å­—
 */
function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
        '/': '&#x2F;',
        '`': '&#x60;',
        '=': '&#x3D;'
    };
    return text.replace(/[&<>"'`=\/]/g, char => map[char]);
}

/**
 * æ­£å‰‡è¡¨é”å¼ç‰¹æ®Šå­—å…ƒè·³è„«
 * @param {string} string - åŸå§‹å­—ä¸²
 * @returns {string} - è·³è„«å¾Œçš„å­—ä¸²
 */
function escapeRegex(string) {
    if (typeof string !== 'string') return '';
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * é©—è­‰ä¸¦æ¸…ç†æœå°‹è¼¸å…¥
 * @param {string} input - ä½¿ç”¨è€…è¼¸å…¥
 * @returns {string} - æ¸…ç†å¾Œçš„è¼¸å…¥
 */
function sanitizeSearchInput(input) {
    if (typeof input !== 'string') return '';
    
    // 1. ç§»é™¤é¦–å°¾ç©ºç™½
    let cleaned = input.trim();
    
    // 2. é™åˆ¶é•·åº¦
    if (cleaned.length > CONFIG.MAX_QUERY_LENGTH) {
        cleaned = cleaned.substring(0, CONFIG.MAX_QUERY_LENGTH);
    }
    
    // 3. ç§»é™¤æ§åˆ¶å­—å…ƒå’Œé›¶å¯¬å­—å…ƒ
    cleaned = cleaned.replace(/[\x00-\x1F\x7F\u200B-\u200D\uFEFF]/g, '');
    
    // 4. æ¨™æº–åŒ–ç©ºç™½
    cleaned = cleaned.replace(/\s+/g, ' ');
    
    return cleaned;
}

/**
 * é©—è­‰ URL æ˜¯å¦åœ¨ç™½åå–®ä¸­
 * @param {string} url - è¦é©—è­‰çš„ URL
 * @returns {boolean} - æ˜¯å¦å®‰å…¨
 */
function isUrlSafe(url) {
    if (!url || typeof url !== 'string') return false;
    
    try {
        const urlObj = new URL(url);
        return CONFIG.ALLOWED_DOMAINS.includes(urlObj.hostname);
    } catch (e) {
        return false;
    }
}

/**
 * å®‰å…¨çš„éŒ¯èª¤æ—¥èªŒ (ä¸æš´éœ²æ•æ„Ÿè³‡è¨Š)
 * @param {string} context - éŒ¯èª¤ç™¼ç”Ÿçš„ä¸Šä¸‹æ–‡
 * @param {Error} error - éŒ¯èª¤ç‰©ä»¶
 */
function logError(context, error) {
    // ç”Ÿç”¢ç’°å¢ƒåªè¨˜éŒ„åŸºæœ¬è³‡è¨Š
    console.error(`[${context}] ç™¼ç”ŸéŒ¯èª¤`);
    // é–‹ç™¼æ™‚å¯ä»¥æ‰“é–‹ä¸‹é¢é€™è¡ŒæŸ¥çœ‹è©³ç´°éŒ¯èª¤
    // console.error(error);
}

// ================= åˆå§‹åŒ– =================
document.addEventListener('DOMContentLoaded', () => {
    loadBookmarks();
    updateBookmarkCount();
    setupEventListeners();
    loadData();
});

function setupEventListeners() {
    const input = document.getElementById('searchInput');
    
    // é˜²æŠ–æœå°‹
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const value = sanitizeSearchInput(input.value);
        
        if (value.length >= CONFIG.MIN_QUERY_LENGTH && isDataLoaded) {
            debounceTimer = setTimeout(() => performSearch(), CONFIG.DEBOUNCE_MS);
        }
    });
    
    // Enter æœå°‹
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            clearTimeout(debounceTimer);
            performSearch();
        }
    });
    
    // æ‰‹å‹•ä¸Šå‚³
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
}

// ================= è³‡æ–™è¼‰å…¥ =================

async function loadData() {
    updateLoadStatus('loading', 'æ­£åœ¨è¼‰å…¥è¦å‰‡æ›¸è³‡æ–™...');
    
    try {
        const response = await fetch(CONFIG.DATA_URL, {
            method: 'GET',
            mode: 'cors',
            cache: 'default'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const content = await response.text();
        
        if (!content || content.length < 1000) {
            throw new Error('è³‡æ–™å…§å®¹ç•°å¸¸');
        }
        
        parseData(content);
        onDataLoaded();
        
    } catch (error) {
        logError('loadData', error);
        updateLoadStatus('error', 'è‡ªå‹•è¼‰å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æª”æ¡ˆæˆ–é»æ“Šé‡è©¦');
        document.getElementById('retryBtn').classList.add('show');
        document.getElementById('fallbackUpload').classList.add('show');
    }
}

function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // é©—è­‰æª”æ¡ˆé¡å‹
    if (!file.name.toLowerCase().endsWith('.txt')) {
        updateLoadStatus('error', 'è«‹é¸æ“‡ .txt æª”æ¡ˆ');
        return;
    }
    
    // é©—è­‰æª”æ¡ˆå¤§å° (æœ€å¤§ 50MB)
    if (file.size > 50 * 1024 * 1024) {
        updateLoadStatus('error', 'æª”æ¡ˆéå¤§ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„è¦å‰‡æ›¸æª”æ¡ˆ');
        return;
    }
    
    updateLoadStatus('loading', 'æ­£åœ¨è®€å–æª”æ¡ˆ...');
    
    const reader = new FileReader();
    
    reader.onload = (e) => {
        try {
            parseData(e.target.result);
            onDataLoaded();
        } catch (error) {
            logError('handleFileUpload', error);
            updateLoadStatus('error', 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼');
        }
    };
    
    reader.onerror = () => {
        updateLoadStatus('error', 'æª”æ¡ˆè®€å–å¤±æ•—');
    };
    
    reader.readAsText(file, 'UTF-8');
}

function onDataLoaded() {
    isDataLoaded = true;
    updateLoadStatus('success', `âœ… è¼‰å…¥æˆåŠŸï¼å…± ${allData.length.toLocaleString()} å€‹æ¢ç›®`);
    document.getElementById('searchSection').classList.add('enabled');
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('searchInput').focus();
    document.getElementById('retryBtn').classList.remove('show');
    document.getElementById('fallbackUpload').classList.remove('show');
}

function updateLoadStatus(type, message) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    
    indicator.className = 'status-indicator ' + type;
    text.className = 'status-text ' + type;
    text.textContent = message;
}

// ================= è³‡æ–™è§£æ =================

function parseData(content) {
    allData = [];
    const lines = content.split('\n');
    let currentEntry = null;
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        const parts = line.split('\t');
        
        if (parts.length >= 4 && parts[2] && parts[2].includes('http')) {
            if (currentEntry && currentEntry.content.length > 20) {
                allData.push(currentEntry);
            }
            
            currentEntry = {
                category: (parts[0] || 'æœªåˆ†é¡').trim().substring(0, 100),
                filename: (parts[1] || '').trim().substring(0, 200),
                url: parts[2].trim(),
                content: cleanContent(parts.slice(3).join('\t'))
            };
        } else if (currentEntry) {
            currentEntry.content += '\n' + cleanContent(line);
        }
    }
    
    if (currentEntry && currentEntry.content.length > 20) {
        allData.push(currentEntry);
    }
    
    // å»ºç«‹ç´¢å¼•
    allData.forEach((entry, index) => {
        entry.id = index;
        entry.searchText = (entry.category + ' ' + entry.filename + ' ' + entry.content).toLowerCase();
    });
}

function cleanContent(text) {
    if (typeof text !== 'string') return '';
    return text
        .replace(/^["']|["']$/g, '')
        .replace(/\r\n|\r/g, '\n')
        .replace(/[ \t]+/g, ' ')
        .trim();
}

// ================= æœå°‹åŠŸèƒ½ =================

function performSearch() {
    if (!isDataLoaded) return;
    
    const rawQuery = document.getElementById('searchInput').value;
    const query = sanitizeSearchInput(rawQuery);
    
    if (query.length < CONFIG.MIN_QUERY_LENGTH) return;
    
    const startTime = performance.now();
    
    // è§£ææœå°‹è©
    let isOrSearch = false;
    if (query.includes('|')) {
        searchTerms = query.split('|').map(t => t.trim().toLowerCase()).filter(t => t.length > 0);
        isOrSearch = true;
    } else {
        searchTerms = query.split(/\s+/).map(t => t.toLowerCase()).filter(t => t.length > 0);
    }
    
    // é™åˆ¶æœå°‹è©æ•¸é‡
    if (searchTerms.length > 10) {
        searchTerms = searchTerms.slice(0, 10);
    }
    
    // åŸ·è¡Œæœå°‹
    currentResults = allData.filter(entry => {
        if (isOrSearch) {
            return searchTerms.some(term => entry.searchText.includes(term));
        } else {
            return searchTerms.every(term => entry.searchText.includes(term));
        }
    });
    
    const searchTime = (performance.now() - startTime).toFixed(1);
    currentPage = 1;
    renderResults(searchTime);
}

function quickSearch(query) {
    document.getElementById('searchInput').value = query;
    performSearch();
}

// ================= çµæœæ¸²æŸ“ =================

function renderResults(searchTime) {
    const container = document.getElementById('resultsContainer');
    
    if (currentResults.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">ğŸ”</div>
                <h3>æ‰¾ä¸åˆ°ç¬¦åˆçš„çµæœ</h3>
                <p>è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æ¸›å°‘æœå°‹æ¢ä»¶</p>
            </div>
        `;
        return;
    }
    
    const totalPages = Math.ceil(currentResults.length / CONFIG.RESULTS_PER_PAGE);
    const startIdx = (currentPage - 1) * CONFIG.RESULTS_PER_PAGE;
    const endIdx = Math.min(startIdx + CONFIG.RESULTS_PER_PAGE, currentResults.length);
    const pageResults = currentResults.slice(startIdx, endIdx);
    
    let html = `
        <div class="results-stats">
            <div class="stats-count">æ‰¾åˆ° <strong>${currentResults.length.toLocaleString()}</strong> å€‹çµæœ</div>
            <div class="stats-time">è€—æ™‚ ${escapeHtml(searchTime)} ms | ç¬¬ ${currentPage}/${totalPages} é </div>
        </div>
        <div class="results-list">
    `;
    
    pageResults.forEach((result) => {
        const isBookmarked = bookmarks[result.id] !== undefined;
        const snippet = getSnippet(result.content, searchTerms, 280);
        const highlightedSnippet = highlightText(snippet, searchTerms);
        
        // å®‰å…¨çš„ URL è™•ç†
        const safeUrl = isUrlSafe(result.url) ? escapeHtml(result.url) : '';
        
        html += `
            <div class="result-card ${isBookmarked ? 'bookmarked' : ''}" data-id="${result.id}">
                <div class="result-header">
                    <div class="result-title-area">
                        <div class="result-title">${escapeHtml(result.filename || result.category)}</div>
                        <div class="result-category">ğŸ“ ${escapeHtml(result.category)}</div>
                    </div>
                    <div class="result-actions">
                        <button class="star-btn ${isBookmarked ? 'active' : ''}" 
                                onclick="toggleBookmark(${result.id})" 
                                title="${isBookmarked ? 'ç§»é™¤æ›¸ç±¤' : 'åŠ å…¥æ›¸ç±¤'}"
                                aria-label="${isBookmarked ? 'ç§»é™¤æ›¸ç±¤' : 'åŠ å…¥æ›¸ç±¤'}">
                            ${isBookmarked ? 'â­' : 'â˜†'}
                        </button>
                    </div>
                </div>
                <div class="result-content" id="content-${result.id}">
                    ${highlightedSnippet}
                </div>
                <div class="result-footer">
                    <button class="expand-btn" onclick="toggleExpand(${result.id})">
                        <span>ğŸ“–</span>
                        <span>å±•é–‹å…¨æ–‡</span>
                    </button>
                    ${safeUrl ? `<a class="link-btn" href="${safeUrl}" target="_blank" rel="noopener noreferrer"><span>ğŸ”—</span><span>æŸ¥çœ‹åŸæ–‡</span></a>` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    if (totalPages > 1) {
        html += renderPagination(totalPages);
    }
    
    container.innerHTML = html;
    window.scrollTo({ top: document.getElementById('searchSection').offsetTop - 20, behavior: 'smooth' });
}

function renderPagination(totalPages) {
    let html = '<div class="pagination">';
    
    html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} aria-label="ä¸Šä¸€é ">â—€</button>`;
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) html += `<span style="color:var(--text-dim);padding:0 5px">...</span>`;
    }
    
    for (let p = startPage; p <= endPage; p++) {
        html += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span style="color:var(--text-dim);padding:0 5px">...</span>`;
        html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} aria-label="ä¸‹ä¸€é ">â–¶</button>`;
    html += '</div>';
    
    return html;
}

function goToPage(page) {
    if (page < 1 || page > Math.ceil(currentResults.length / CONFIG.RESULTS_PER_PAGE)) return;
    currentPage = page;
    renderResults('-');
}

function toggleExpand(id) {
    if (typeof id !== 'number' || id < 0 || id >= allData.length) return;
    
    const contentEl = document.getElementById('content-' + id);
    if (!contentEl) return;
    
    const btn = contentEl.closest('.result-card').querySelector('.expand-btn');
    const result = allData[id];
    
    if (contentEl.classList.contains('expanded')) {
        contentEl.classList.remove('expanded');
        const snippet = getSnippet(result.content, searchTerms, 280);
        contentEl.innerHTML = highlightText(snippet, searchTerms);
        btn.innerHTML = '<span>ğŸ“–</span><span>å±•é–‹å…¨æ–‡</span>';
    } else {
        contentEl.classList.add('expanded');
        contentEl.innerHTML = highlightText(result.content, searchTerms);
        btn.innerHTML = '<span>ğŸ“•</span><span>æ”¶åˆ</span>';
    }
}

// ================= æ›¸ç±¤åŠŸèƒ½ =================

function loadBookmarks() {
    try {
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            // é©—è­‰è³‡æ–™çµæ§‹
            if (typeof parsed === 'object' && parsed !== null) {
                bookmarks = parsed;
            }
        }
    } catch (e) {
        logError('loadBookmarks', e);
        bookmarks = {};
    }
}

function saveBookmarks() {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(bookmarks));
    } catch (e) {
        logError('saveBookmarks', e);
    }
}

function updateBookmarkCount() {
    const count = Object.keys(bookmarks).length;
    document.getElementById('bookmarkCount').textContent = count > 99 ? '99+' : count;
}

function toggleBookmark(id) {
    if (typeof id !== 'number' || id < 0 || !allData[id]) return;
    
    const result = allData[id];
    
    if (bookmarks[id]) {
        delete bookmarks[id];
    } else {
        bookmarks[id] = {
            id: id,
            filename: result.filename.substring(0, 100),
            category: result.category.substring(0, 50),
            url: isUrlSafe(result.url) ? result.url : '',
            preview: result.content.substring(0, 150) + '...',
            addedAt: Date.now()
        };
    }
    
    saveBookmarks();
    updateBookmarkCount();
    
    // æ›´æ–° UI
    const card = document.querySelector(`.result-card[data-id="${id}"]`);
    if (card) {
        const btn = card.querySelector('.star-btn');
        if (bookmarks[id]) {
            card.classList.add('bookmarked');
            btn.classList.add('active');
            btn.innerHTML = 'â­';
            btn.title = 'ç§»é™¤æ›¸ç±¤';
        } else {
            card.classList.remove('bookmarked');
            btn.classList.remove('active');
            btn.innerHTML = 'â˜†';
            btn.title = 'åŠ å…¥æ›¸ç±¤';
        }
    }
    
    renderBookmarkList();
}

function toggleBookmarkPanel() {
    const panel = document.getElementById('bookmarkPanel');
    const overlay = document.getElementById('overlay');
    
    panel.classList.toggle('open');
    overlay.classList.toggle('show');
    
    if (panel.classList.contains('open')) {
        renderBookmarkList();
    }
}

function renderBookmarkList() {
    const container = document.getElementById('bookmarkList');
    const ids = Object.keys(bookmarks);
    
    if (ids.length === 0) {
        container.innerHTML = `
            <div class="bookmark-empty">
                <p style="font-size:2rem;margin-bottom:10px">ğŸ“‘</p>
                <p>å°šæœªæ”¶è—ä»»ä½•è¦å‰‡</p>
                <p style="font-size:0.85rem;margin-top:10px">é»æ“Šæœå°‹çµæœçš„ â˜† æŒ‰éˆ•åŠ å…¥æ›¸ç±¤</p>
            </div>
        `;
        return;
    }
    
    // æŒ‰åŠ å…¥æ™‚é–“æ’åº (æ–°çš„åœ¨å‰)
    ids.sort((a, b) => (bookmarks[b].addedAt || 0) - (bookmarks[a].addedAt || 0));
    
    let html = '';
    ids.forEach(id => {
        const bm = bookmarks[id];
        const safeUrl = isUrlSafe(bm.url) ? escapeHtml(bm.url) : '';
        
        html += `
            <div class="bookmark-item">
                <div class="bookmark-item-header">
                    <div class="bookmark-item-title">${escapeHtml(bm.filename || bm.category)}</div>
                    <button class="remove-bookmark-btn" onclick="removeBookmark(${id})" title="ç§»é™¤æ›¸ç±¤" aria-label="ç§»é™¤æ›¸ç±¤">âœ•</button>
                </div>
                <div class="bookmark-item-preview">${escapeHtml(bm.preview)}</div>
                ${safeUrl ? `<a class="bookmark-item-link" href="${safeUrl}" target="_blank" rel="noopener noreferrer">ğŸ”— æŸ¥çœ‹åŸæ–‡</a>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function removeBookmark(id) {
    if (bookmarks[id]) {
        delete bookmarks[id];
        saveBookmarks();
        updateBookmarkCount();
        renderBookmarkList();
        
        // æ›´æ–°æœå°‹çµæœ
        const card = document.querySelector(`.result-card[data-id="${id}"]`);
        if (card) {
            card.classList.remove('bookmarked');
            const btn = card.querySelector('.star-btn');
            if (btn) {
                btn.classList.remove('active');
                btn.innerHTML = 'â˜†';
                btn.title = 'åŠ å…¥æ›¸ç±¤';
            }
        }
    }
}

// ================= æ–‡å­—è™•ç† =================

function highlightText(text, terms) {
    if (!terms || terms.length === 0) return escapeHtml(text);
    
    let result = escapeHtml(text);
    
    terms.forEach(term => {
        if (!term || term.length === 0) return;
        const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
        result = result.replace(regex, '<mark>$1</mark>');
    });
    
    return result;
}

function getSnippet(text, terms, maxLength) {
    if (typeof text !== 'string') return '';
    
    if (!terms || terms.length === 0) {
        return text.substring(0, maxLength) + (text.length > maxLength ? '...' : '');
    }
    
    let firstPos = text.length;
    terms.forEach(term => {
        if (!term) return;
        const pos = text.toLowerCase().indexOf(term.toLowerCase());
        if (pos !== -1 && pos < firstPos) firstPos = pos;
    });
    
    const start = Math.max(0, firstPos - 60);
    const end = Math.min(text.length, start + maxLength);
    
    let snippet = text.substring(start, end);
    if (start > 0) snippet = '...' + snippet;
    if (end < text.length) snippet = snippet + '...';
    
    return snippet;
}
</script>

</body>
</html>

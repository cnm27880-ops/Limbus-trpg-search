<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- å®‰å…¨æ¨™é ­ -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self' https://sheets.googleapis.com https://generativelanguage.googleapis.com https://raw.githubusercontent.com;
        frame-ancestors 'none';
        form-action 'self';
        base-uri 'self';
    ">
    
    <title>ç„¡é™ææ€– TRPG ç¶œåˆç³»çµ±</title>
    
    <!-- å¼•å…¥è³‡æº -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --bg-abyss: #0a0a0c;
            --bg-deep: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #222230;
            --bg-hover: #2a2a3a;
            --accent-blood: #c41e3a;
            --accent-blood-dim: #8b1528;
            --accent-gold: #d4a020;
            --accent-ember: #ff6b35;
            --accent-purple: #9b59b6;
            --accent-blue: #3498db;
            --accent-cyan: #00d4aa;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-dim: #606070;
            --border: #333340;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            --info: #70a1ff;
            --radius: 16px;
            --radius-sm: 10px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg-abyss);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-abyss); }
        ::-webkit-scrollbar-thumb { background: var(--accent-blood-dim); border-radius: 4px; }

        header {
            background: linear-gradient(135deg, var(--accent-blood-dim) 0%, var(--bg-deep) 40%, var(--bg-abyss) 100%);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-blood);
            position: relative;
        }
        header::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            animation: scan 3s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(196, 30, 58, 0.5);
        }
        h1 .highlight { color: var(--accent-gold); }
        .subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .version { display: inline-block; padding: 2px 8px; background: var(--accent-gold); color: #000; font-size: 0.7rem; font-weight: 700; border-radius: 8px; margin-left: 8px; }

        .main-nav {
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto; /* æ‰‹æ©Ÿç‰ˆå¯æ©«å‘æ»‘å‹• */
            white-space: nowrap;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 5px;
            padding: 10px 15px;
        }
        .nav-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-btn.active { background: var(--accent-blood-dim); color: var(--accent-gold); }

        .container { max-width: 1300px; margin: 0 auto; padding: 20px 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 22px;
            margin-bottom: 22px;
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--accent-blood), var(--accent-gold));
        }
        .card.gold::before { background: linear-gradient(90deg, var(--accent-gold), var(--accent-ember)); }
        .card.purple::before { background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue)); }
        .card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)); }
        
        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blood), var(--accent-blood-dim)); color: #fff; }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold), var(--accent-ember)); color: #000; }
        .btn-secondary { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--accent-gold); color: var(--text-primary); }

        .input-group label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; }
        input, select, textarea, .text-area {
            width: 100%;
            padding: 12px 15px;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--accent-gold); }

        .search-box-large {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .search-input-lg {
            flex: 1; padding: 16px; font-size: 1.1rem;
            background: var(--bg-elevated); border: 2px solid var(--border);
            color: var(--text-primary); border-radius: var(--radius-sm);
        }
        .search-input-lg:focus { border-color: var(--accent-gold); }
        
        .quick-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .quick-tag {
            padding: 6px 12px; font-size: 0.8rem;
            background: var(--bg-deep); border: 1px solid var(--border);
            color: var(--text-secondary); border-radius: 20px; cursor: pointer;
            transition: all 0.2s;
        }
        .quick-tag:hover { background: var(--accent-blood-dim); color: white; border-color: var(--accent-blood); }

        .result-list { display: flex; flex-direction: column; gap: 15px; }
        .search-result-card {
            background: var(--bg-card); border-radius: var(--radius);
            border: 1px solid var(--border); border-left: 4px solid var(--accent-blood);
            padding: 20px; transition: transform 0.2s;
        }
        .search-result-card:hover { transform: translateX(5px); background: var(--bg-hover); }
        .search-result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .search-result-title { font-size: 1.1rem; font-weight: 700; color: var(--accent-gold); }
        .search-result-meta { font-size: 0.8rem; color: var(--text-dim); background: var(--bg-deep); padding: 2px 8px; border-radius: 10px; }
        .search-result-content { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; max-height: 150px; overflow: hidden; position: relative; }
        .search-result-content.expanded { max-height: none; }
        .search-result-content:not(.expanded)::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(transparent, var(--bg-card)); pointer-events: none; }
        .search-result-footer { display: flex; gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .expand-btn { padding: 8px 14px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .expand-btn:hover { background: var(--bg-hover); border-color: var(--accent-gold); color: var(--text-primary); }
        mark { background: var(--accent-gold); color: black; border-radius: 2px; padding: 0 2px; }

        .bookmark-panel {
            position: fixed; top: 0; right: -400px; width: 380px; max-width: 90vw; height: 100vh;
            background: var(--bg-deep); border-left: 2px solid var(--accent-gold);
            z-index: 1000; transition: right 0.3s ease; display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
        }
        .bookmark-panel.open { right: 0; }
        .bookmark-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 999; display: none; 
        }
        .bookmark-overlay.show { display: block; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; }
        .tab-btn { padding: 10px 18px; border: 2px solid var(--border); background: var(--bg-deep); color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer; }
        .tab-btn.active { border-color: var(--accent-blood); background: var(--accent-blood-dim); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .boss-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-input { text-align: center; }
        .stat-input input { text-align: center; font-weight: bold; color: var(--accent-gold); }
        
        .chat-box { height: 400px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; background: var(--bg-deep); border-radius: var(--radius-sm); padding: 15px; margin-bottom: 10px; }
        .chat-msg { margin-bottom: 10px; display: flex; gap: 10px; }
        .chat-msg.user { flex-direction: row-reverse; }
        .chat-bubble { padding: 10px 14px; border-radius: 10px; font-size: 0.9rem; max-width: 80%; }
        .chat-msg.user .chat-bubble { background: var(--accent-gold); color: black; }
        .chat-msg.ai .chat-bubble { background: var(--bg-elevated); border: 1px solid var(--border); }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .history-item { background: var(--bg-deep); padding: 15px; border-radius: var(--radius-sm); border-left: 3px solid var(--accent-cyan); margin-bottom: 10px; cursor: pointer; transition: transform 0.2s; }
        .history-item:hover { transform: translateX(5px); background: var(--bg-hover); }

        .msg { padding: 12px 16px; border-radius: var(--radius-sm); margin: 10px 0; }
        .msg.error { background: rgba(255,71,87,0.1); border: 1px solid var(--danger); color: var(--danger); }
        .msg.success { background: rgba(46,213,115,0.1); border: 1px solid var(--success); color: var(--success); }

        .char-card { background: var(--bg-elevated); padding: 20px; margin: 15px 0; border-radius: var(--radius); border-left: 4px solid var(--accent-gold); }
        .power-badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; margin-left: 10px; }
        .power-S { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .power-A { background: var(--danger); color: #fff; }
        .power-B { background: var(--accent-purple); color: #fff; }
        .power-C { background: var(--accent-blue); color: #fff; }
        .power-D { background: var(--success); color: #fff; }
        .core-abilities { margin: 10px 0; }
        .core-abilities li { color: var(--text-secondary); margin: 5px 0; }
        .warnings { background: rgba(255,71,87,0.1); border: 1px solid var(--danger); padding: 10px; border-radius: 8px; margin: 10px 0; }
        .warnings li { color: var(--danger); margin: 5px 0; }
        .weaknesses { background: rgba(52,152,219,0.05); border: 1px solid var(--accent-blue); padding: 10px; border-radius: 8px; margin: 10px 0; }
        .weaknesses li { color: var(--accent-blue); margin: 5px 0; }
        .suggestions { background: rgba(46,213,115,0.05); border: 1px solid var(--success); padding: 10px; border-radius: 8px; margin: 10px 0; }
        .suggestions li { color: var(--success); margin: 5px 0; }
        .rule-tag { display: inline-block; padding: 4px 10px; margin: 3px; background: var(--bg-deep); border: 1px solid var(--accent-gold); color: var(--accent-gold); border-radius: 12px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .rule-tag:hover { background: var(--accent-gold); color: #000; }
        .team-summary-section { background: var(--bg-elevated); padding: 15px; border-radius: var(--radius); margin: 20px 0; }
        .synergies { color: var(--success); }
        .gaps { color: var(--warning); }

        footer { text-align: center; padding: 30px; color: var(--text-dim); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 40px; }
        footer a { color: var(--accent-gold); text-decoration: none; }
    </style>
</head>
<body>

<header>
    <h1>ğŸšŒ ç„¡é™ææ€– TRPG <span class="highlight"> ç¶œåˆç³»çµ±</span> <span class="version">v3.0</span></h1>
    <p class="subtitle">è¦å‰‡æª¢ç´¢ Â· æˆ°åŠ›åˆ†æ Â· æˆ°å½¹æ¨¡æ“¬ Â· è‡ªå‹•åŒ–è¼”åŠ©</p>
</header>

<nav class="main-nav">
    <div class="nav-container">
        <button class="nav-btn active" onclick="switchPage('search')" data-page="search">ğŸ” è¦å‰‡æœå°‹</button>
        <button class="nav-btn" onclick="switchPage('analyze')" data-page="analyze">âš”ï¸ è§’å¡åˆ†æ</button>
        <button class="nav-btn" onclick="switchPage('boss')" data-page="boss">ğŸ‘¹ BOSSæ¨¡æ“¬</button>
        <button class="nav-btn" onclick="switchPage('qa')" data-page="qa">ğŸ¤– è¦å‰‡å•ç­”</button>
        <button class="nav-btn" onclick="switchPage('npc')" data-page="npc">ğŸ² NPCç”Ÿæˆ</button>
        <button class="nav-btn" onclick="switchPage('checklist')" data-page="checklist">âœ… è¨­è¨ˆæª¢æŸ¥</button>
        <button class="nav-btn" onclick="switchPage('history')" data-page="history">ğŸ“Š æ­·å²ç´€éŒ„</button>
        <button class="nav-btn" onclick="switchPage('settings')" data-page="settings">âš™ï¸ è¨­å®š</button>
    </div>
</nav>

<div class="container">

    <section class="page active" id="page-search">
        <div class="card">
            <div class="card-title">
                <span>ğŸ“š è¦å‰‡æ›¸å…¨æ–‡æœ¬æª¢ç´¢</span>
                <button class="btn btn-secondary" onclick="toggleBookmarks()" style="margin-left:auto; padding:5px 10px; font-size:0.8rem;">
                    â­ æˆ‘çš„æ›¸ç±¤ <span id="bookmarkCount">(0)</span>
                </button>
            </div>
            
            <div id="rulesLoadStatus" style="margin-bottom:15px; font-size:0.9rem; color:var(--text-dim);">
                <span id="loadIndicator" style="color:var(--warning);">â—</span> <span id="loadText">æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...</span>
            </div>
            <div class="search-box-large">
                <input type="text" class="search-input-lg" id="searchInput" placeholder="è¼¸å…¥é—œéµå­—... (ä¾‹å¦‚: åŸºå› é–ã€Bç´šå¼·åŒ–ã€é«˜æ–¯æ‰‹æ§ã€ç”Ÿå‘½å€¼)">
                <button class="btn btn-primary" id="searchBtn" onclick="performSearch()" disabled style="min-width:100px;">æœå°‹</button>
            </div>

            <div class="input-hint" style="margin-bottom:15px;">
                ğŸ’¡ æ”¯æ´å¤šè©æœå°‹ (ç©ºæ ¼åˆ†éš”) | é»æ“Šæ¨™ç±¤å¿«é€Ÿæœå°‹
            </div>

            <div class="quick-tags">
                <span class="quick-tag" onclick="quickSearch('åŸºå› é–')">åŸºå› é–</span>
                <span class="quick-tag" onclick="quickSearch('å…§åŠ›')">å…§åŠ›</span>
                <span class="quick-tag" onclick="quickSearch('é­”åŠ›')">é­”åŠ›</span>
                <span class="quick-tag" onclick="quickSearch('ç²¾ç¥åŠ›')">ç²¾ç¥åŠ›</span>
                <span class="quick-tag" onclick="quickSearch('æ§æ¢°')">æ§æ¢°</span>
                <span class="quick-tag" onclick="quickSearch('å‚³èªªé­”æ³•é¡')">å‚³èªªé­”æ³•é¡</span>
                <span class="quick-tag" onclick="quickSearch('ç§‘å¹»ç§‘æŠ€é¡')">ç§‘å¹»ç§‘æŠ€é¡</span>
                <span class="quick-tag" onclick="quickSearch('è¼”åŠ©é¡')">è¼”åŠ©é¡</span>
            </div>
        </div>

        <div id="searchResults" class="result-list"></div>
        <div id="pagination" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
    </section>

    <section class="page" id="page-analyze">
        <div class="card">
            <div class="card-title">ğŸ“‹ è§’å¡è³‡æ–™è¼¸å…¥</div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('sheets')">ğŸ“Š Google Sheets</button>
                <button class="tab-btn" onclick="switchTab('text')">ğŸ“ è²¼ä¸Šæ–‡å­—</button>
            </div>
            
            <div class="tab-content active" id="tab-sheets">
                <div class="input-group">
                    <label>Google Sheets é€£çµ</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="sheetsUrl" placeholder="è²¼ä¸Šå…¬é–‹çš„è©¦ç®—è¡¨é€£çµ...">
                        <button class="btn btn-gold" onclick="fetchSheets()">è®€å–</button>
                    </div>
                </div>
                <div id="sheetSelector" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                    <label style="margin-bottom:10px; display:block;">é¸æ“‡è¦åˆ†æçš„è§’è‰²ï¼š</label>
                    <div class="tag-list" id="sheetTabs"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-text">
                <textarea class="text-area" id="textInput" style="height:200px;" placeholder="ç›´æ¥è²¼ä¸Šæ–‡å­—ç‰ˆè§’å¡å…§å®¹..."></textarea>
            </div>

            <div class="preview-box" id="previewBox" style="display:none; margin-top:15px;">
                <div class="preview-header">
                    <span class="preview-title">ğŸ“„ è³‡æ–™é è¦½</span>
                    <span class="preview-stats" id="previewStats"></span>
                </div>
                <div id="previewContent"></div>
            </div>

            <div class="msg error" id="analyzeError" style="display:none; margin-top:15px;"></div>
            
            <div class="action-row" style="margin-top:20px;">
                <button class="btn btn-primary" onclick="analyzeCharacters()" style="flex:1;">âš”ï¸ åˆ†æè§’å¡æˆ°åŠ›</button>
            </div>
        </div>

        <div id="analyzeResults" style="display:none;">
            <div class="card gold">
                <div class="card-title">
                    ğŸ“Š åˆ†æçµæœ
                    <div style="margin-left:auto; display:flex; gap:8px;">
                        <button class="btn btn-secondary" onclick="exportResults('discord')" style="font-size:0.8rem; padding:5px 10px;">ğŸ“‹ Discord</button>
                        <button class="btn btn-secondary" onclick="exportResults('markdown')" style="font-size:0.8rem; padding:5px 10px;">ğŸ“ MD</button>
                        <button class="btn btn-secondary" onclick="exportResults('json')" style="font-size:0.8rem; padding:5px 10px;">ğŸ’¾ JSON</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="radarChart"></canvas></div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </section>

    <section class="page" id="page-boss">
        <div class="card purple">
            <div class="card-title">ğŸ‘¹ BOSS å°æˆ°æ¨¡æ“¬å™¨</div>
            <div class="boss-grid">
                <div class="stat-input"><label>ç”Ÿå‘½å€¼</label><input type="number" id="bossHp" value="50"></div>
                <div class="stat-input"><label>é˜²ç¦¦</label><input type="number" id="bossDef" value="20"></div>
                <div class="stat-input"><label>æ”»æ“Š</label><input type="number" id="bossAtk" value="15"></div>
                <div class="stat-input"><label>å‚·å®³</label><input type="number" id="bossDmg" value="10"></div>
                <div class="stat-input"><label>å…ˆæ”»</label><input type="number" id="bossInit" value="10"></div>
                <div class="stat-input"><label>æŠ—æ€§</label><input type="number" id="bossResist" value="0"></div>
            </div>
            <div class="input-group">
                <label>ç‰¹æ®Šèƒ½åŠ›æè¿°</label>
                <textarea class="text-area" id="bossAbilities" style="height:80px;" placeholder="ä¾‹å¦‚ï¼šå…ç–«ç²¾ç¥æ§åˆ¶ï¼Œæ¯3å›åˆæ–½æ”¾å…¨é«”æ”»æ“Š..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="simulateBoss()" style="width:100%; margin-top:15px;">âš”ï¸ é–‹å§‹æ¨¡æ“¬</button>
            
            <div class="sim-result" id="bossResult" style="display:none; margin-top:20px; background:var(--bg-deep); padding:15px; border-radius:var(--radius-sm);">
                <h4 style="color:var(--accent-gold); margin-bottom:10px;">ğŸ“Š é æ¸¬çµæœ</h4>
                <div id="bossResultContent"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ’¡ è¨­è¨ˆå»ºè­°</div>
            <div id="bossTips"><p style="color:var(--text-dim);">å®Œæˆæ¨¡æ“¬å¾Œé¡¯ç¤ºå»ºè­°</p></div>
        </div>
    </section>

    <section class="page" id="page-qa">
        <div class="card cyan">
            <div class="card-title">ğŸ¤– è¦å‰‡æ›¸ AI åŠ©æ‰‹</div>
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-msg ai">
                        <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ç„¡é™ææ€–è¦å‰‡åŠ©æ‰‹ã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ<br>ä½ å¯ä»¥å•æˆ‘é—œæ–¼è¡€çµ±ã€æŠ€èƒ½ã€æˆ–æ˜¯å…·é«”çš„åˆ¤å®šè¦å‰‡ã€‚</div>
                    </div>
                </div>
                <div class="chat-input-row" style="margin-top:10px; display:flex; gap:10px;">
                    <input type="text" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-gold" onclick="sendChat()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </section>

    <section class="page" id="page-npc">
        <div class="card">
            <div class="card-title">ğŸ² å¿«é€Ÿ NPC ç”Ÿæˆå™¨</div>
            <div class="form-grid">
                <div class="input-group">
                    <label>é›£åº¦ç­‰ç´š</label>
                    <select id="npcDiff">
                        <option value="minion">é›œå…µ</option>
                        <option value="standard" selected>æ¨™æº–</option>
                        <option value="elite">ç²¾è‹±</option>
                        <option value="boss">é ­ç›®</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>æˆ°é¬¥é¡å‹</label>
                    <select id="npcType">
                        <option value="melee">è¿‘æˆ°</option>
                        <option value="ranged">é ç¨‹</option>
                        <option value="mage">æ³•å¸«</option>
                        <option value="tank">å¦å…‹</option>
                        <option value="assassin">åˆºå®¢</option>
                    </select>
                </div>
            </div>
            <div class="input-group" style="margin-top:15px;">
                <label>é¢¨æ ¼æè¿° (é¸å¡«)</label>
                <input type="text" id="npcDesc" placeholder="ä¾‹å¦‚ï¼šç•°å½¢ç”Ÿç‰©ã€æ©Ÿæ¢°æ”¹é€ å…µ...">
            </div>
            <button class="btn btn-primary" onclick="generateNPC()" style="width:100%; margin-top:15px;">ğŸ² ç”Ÿæˆæ•¸æ“š</button>
            <div id="npcOutput" style="display:none; margin-top:20px; padding:20px; background:var(--bg-deep); border-radius:var(--radius-sm); white-space:pre-wrap; font-family:monospace;"></div>
        </div>
    </section>

    <section class="page" id="page-checklist">
        <div class="card">
            <div class="card-title">âœ… å‰¯æœ¬è¨­è¨ˆæª¢æŸ¥æ¸…å–®</div>
            <ul class="checklist" id="checklistItems" style="list-style:none;">
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ BOSS HP æ˜¯å¦è¶³å¤ æ‰¿å—éšŠä¼æœ€é«˜è¼¸å‡ºï¼Ÿ</li>
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ æœ‰æ²’æœ‰é‡å°é«˜æ©Ÿå‹•/é£›è¡Œè§’è‰²çš„é™åˆ¶ï¼Ÿ</li>
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ æœ‰æ²’æœ‰åç§’æ®ºæ©Ÿåˆ¶ï¼Ÿï¼ˆé–è¡€/ç„¡æ•µæ™‚é–“/å¤šéšæ®µï¼‰</li>
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ ä½æˆ°åŠ›è§’è‰²æ˜¯å¦æœ‰ç™¼æ®ç©ºé–“ï¼Ÿ</li>
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ BOSS èƒ½å¦çªç ´é«˜é˜²è§’è‰²çš„é˜²ç¦¦ï¼Ÿ</li>
                <li style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="this.style.color=this.style.color=='var(--success)'?'var(--text-primary)':'var(--success)'">â˜ ç²¾ç¥åŠ›æ§åˆ¶è€…çš„é«”é©—ï¼Ÿ</li>
            </ul>
        </div>
        <div class="card gold">
            <div class="card-title">ğŸ’¡ é­é‡è¨­è¨ˆå»ºè­°</div>
            <div class="input-group">
                <label>æè¿°å ´æ™¯èˆ‡æ§‹æƒ³</label>
                <textarea class="text-area" id="encounterDesc" style="height:100px;" placeholder="ä¾‹å¦‚ï¼šåœ¨æ–æ–æ¬²å¢œçš„åŠæ©‹ä¸Šèˆ‡ç•°å½¢å¥³çš‡æˆ°é¬¥..."></textarea>
            </div>
            <button class="btn btn-gold" onclick="getEncounterTips()" style="width:100%; margin-top:15px;">ğŸ§  ç²å– AI å»ºè­°</button>
            <div id="encounterTips" style="display:none; margin-top:15px; padding:15px; background:var(--bg-deep); border-radius:var(--radius-sm);"></div>
        </div>
    </section>

    <section class="page" id="page-history">
        <div class="card">
            <div class="card-title">
                ğŸ“Š åˆ†ææ­·å²
                <button class="btn btn-secondary" onclick="clearHistory()" style="margin-left:auto; font-size:0.8rem; padding:5px 10px;">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="historyList"><p style="text-align:center; padding:20px; color:var(--text-dim);">å°šç„¡ç´€éŒ„</p></div>
        </div>
        <div class="card purple">
            <div class="card-title">ğŸ“ˆ è§’è‰²æˆé•·è¿½è¹¤</div>
            <select id="trackSelect" style="margin-bottom:15px;">
                <option value="">-- è«‹å…ˆé€²è¡Œåˆ†æ --</option>
            </select>
            <div id="trackResult"></div>
        </div>
    </section>

    <section class="page" id="page-settings">
        <div class="card">
            <div class="card-title">ğŸ”‘ API è¨­å®š <span class="save-indicator" id="saveIndicator" style="opacity:0; color:var(--success); margin-left:10px;">âœ“ å·²å„²å­˜</span></div>
            <div class="form-grid">
                <div class="input-group">
                    <label>Google Sheets API Key</label>
                    <input type="password" id="sheetsApiKey" placeholder="AIzaSy...">
                </div>
                <div class="input-group">
                    <label>Gemini API Key (Google AI)</label>
                    <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
                </div>
            </div>
            <div class="msg info" style="margin-top:15px; color:var(--info); background:rgba(112,161,255,0.1); padding:10px; border-radius:var(--radius-sm);">
                ğŸ”’ API Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨æœ¬åœ°ç«¯ï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚
            </div>
        </div>
    </section>

</div>

<footer>
    <p>è³‡æ–™ä¾†æºï¼š<a href="https://www.hktrpg.com/INF/2.35Christmas.html" target="_blank">ç„¡é™ææ€– TRPG 2.35 è¦å‰‡æ›¸</a></p>
    <p> ç„¡é™ææ€–ç¶œåˆç³»çµ± | åƒ…ä¾›å­¸ç¿’ä½¿ç”¨</p>
</footer>

<div class="bookmark-overlay" id="bookmarkOverlay" onclick="toggleBookmarks()"></div>
<div class="bookmark-panel" id="bookmarkPanel">
    <div style="padding:20px; border-bottom:1px solid var(--accent-gold); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:var(--accent-gold);">â­ æˆ‘çš„æ›¸ç±¤</h3>
        <button onclick="toggleBookmarks()" style="background:none; border:none; color:white; cursor:pointer; font-size:1.2rem;">âœ•</button>
    </div>
    <div id="bookmarkList" style="flex:1; overflow-y:auto; padding:15px;"></div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText" style="margin-top:15px; color:white;">è™•ç†ä¸­...</div>
</div>

<script>
'use strict';

const CONFIG = {
    RULES_URL: './rules-2.35.txt',
    SHEETS_API: 'https://sheets.googleapis.com/v4/spreadsheets',
    GEMINI_API: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
    STORAGE_PREFIX: 'inf_st_v3_',
    MAX_HISTORY: 30,
    RESULTS_PER_PAGE: 15
};

let state = {
    rulesData: [],
    searchResults: [],
    searchTerms: [],
    searchPage: 1,
    isRulesLoaded: false,
    bookmarks: {},
    sheetsData: null,
    selectedSheets: new Set(),
    charText: '',
    lastAnalysis: null,
    history: [],
    radarChart: null
};

document.addEventListener('DOMContentLoaded', () => {
    setupNavigation();
    setupAutoSave();
    loadRules();
    loadBookmarks();
    loadApiKeys();
    loadHistory();
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') performSearch();
    });
});

function setupNavigation() {
    window.switchPage = function(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.page === pageName));
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach((b, i) => {
            b.classList.toggle('active', tabName === 'sheets' ? i === 0 : i === 1);
        });
        document.getElementById('tab-sheets').classList.toggle('active', tabName === 'sheets');
        document.getElementById('tab-text').classList.toggle('active', tabName === 'text');
    };

    window.toggleBookmarks = function() {
        document.getElementById('bookmarkPanel').classList.toggle('open');
        document.getElementById('bookmarkOverlay').classList.toggle('show');
    };
}

function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
async function loadRules() {
    const indicator = document.getElementById('loadIndicator');
    const text = document.getElementById('loadText');
    
    try {
        const response = await fetch(CONFIG.RULES_URL);
        if(!response.ok) throw new Error("HTTP error");
        const content = await response.text();
        
        parseRules(content);
        
        state.isRulesLoaded = true;
        indicator.style.color = 'var(--success)';
        text.textContent = `è³‡æ–™åº«å°±ç·’ (å…± ${state.rulesData.length} æ¢è¦å‰‡)`;
        document.getElementById('searchBtn').disabled = false;
    } catch(e) {
        indicator.style.color = 'var(--danger)';
        text.textContent = 'è¦å‰‡æ›¸è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆ';
    }
}

function parseRules(content) {
    state.rulesData = [];
    const lines = content.split('\n');
    let currentEntry = null;
    
    for(let i=1; i<lines.length; i++) {
        const line = lines[i];
        if(!line.trim()) continue;
        const parts = line.split('\t');
        
        if(parts.length >= 4 && parts[2] && parts[2].includes('http')) {
            if(currentEntry && currentEntry.content.length > 10) {
                state.rulesData.push(currentEntry);
            }
            currentEntry = {
                id: state.rulesData.length,
                category: (parts[0] || '').trim(),
                filename: (parts[1] || '').trim(),
                url: parts[2].trim(),
                content: parts.slice(3).join('\t').trim(),
                searchText: ''
            };
            currentEntry.searchText = (currentEntry.category + ' ' + currentEntry.filename + ' ' + currentEntry.content).toLowerCase();
        } else if(currentEntry) {
            currentEntry.content += '\n' + line.trim();
            currentEntry.searchText += ' ' + line.trim().toLowerCase();
        }
    }
    if(currentEntry) state.rulesData.push(currentEntry);
}

window.performSearch = function() {
    if(!state.isRulesLoaded) return;
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    if(query.length < 1) return;

    state.searchTerms = query.split(/\s+/).filter(t => t.length > 0);
    state.searchResults = state.rulesData.filter(item => state.searchTerms.every(t => item.searchText.includes(t)));
    state.searchPage = 1;
    renderSearchResults();
};

window.quickSearch = function(term) {
    document.getElementById('searchInput').value = term;
    performSearch();
};

function renderSearchResults() {
    const container = document.getElementById('searchResults');
    const results = state.searchResults;

    if(results.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-dim);">æ‰¾ä¸åˆ°ç¬¦åˆçš„è¦å‰‡</div>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    const start = (state.searchPage - 1) * CONFIG.RESULTS_PER_PAGE;
    const end = Math.min(start + CONFIG.RESULTS_PER_PAGE, results.length);
    const pageResults = results.slice(start, end);
    const totalPages = Math.ceil(results.length / CONFIG.RESULTS_PER_PAGE);

    let html = `<p style="margin-bottom:10px; font-size:0.9rem; color:var(--text-secondary);">æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ (ç¬¬ ${state.searchPage}/${totalPages} é )</p>`;

    pageResults.forEach(item => {
        const isBookmarked = state.bookmarks[item.id];
        const snippet = getSnippet(item.content, state.searchTerms, 250);
        const highlighted = highlightText(snippet, state.searchTerms);

        html += `
            <div class="search-result-card" data-id="${item.id}">
                <div class="search-result-header">
                    <div>
                        <div class="search-result-title">${escapeHtml(item.filename)}</div>
                        <span class="search-result-meta">ğŸ“ ${escapeHtml(item.category)}</span>
                    </div>
                    <button onclick="toggleBookmark(${item.id})" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">${isBookmarked ? 'â­' : 'â˜†'}</button>
                </div>
                <div class="search-result-content" id="content-${item.id}">${highlighted}</div>
                <div class="search-result-footer">
                    <button class="expand-btn" onclick="toggleExpand(${item.id})">ğŸ“– å±•é–‹å…¨æ–‡</button>
                    <a href="${item.url}" target="_blank" style="color:var(--accent-gold); text-decoration:none; font-size:0.9rem;">ğŸ”— æŸ¥çœ‹åŸå§‹ç¶²é </a>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    renderPagination(totalPages);
}

function renderPagination(total) {
    let html = '';
    if(total > 1) {
        html += `<button class="btn btn-secondary" onclick="changePage(-1)" ${state.searchPage===1?'disabled':''}>ä¸Šä¸€é </button>`;
        html += `<span style="align-self:center; color:var(--text-secondary);">${state.searchPage} / ${total}</span>`;
        html += `<button class="btn btn-secondary" onclick="changePage(1)" ${state.searchPage===total?'disabled':''}>ä¸‹ä¸€é </button>`;
    }
    document.getElementById('pagination').innerHTML = html;
}

window.changePage = function(delta) {
    state.searchPage += delta;
    renderSearchResults();
    window.scrollTo({ top: document.getElementById('searchResults').offsetTop - 100, behavior: 'smooth' });
};

function loadBookmarks() {
    const saved = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'bookmarks');
    if(saved) state.bookmarks = JSON.parse(saved);
    updateBookmarkCount();
    renderBookmarkList();
}

window.toggleBookmark = function(id) {
    if(state.bookmarks[id]) {
        delete state.bookmarks[id];
    } else {
        const item = state.rulesData[id];
        if(item) {
            state.bookmarks[id] = {
                id: item.id,
                title: item.filename,
                cat: item.category,
                url: item.url
            };
        }
    }
    localStorage.setItem(CONFIG.STORAGE_PREFIX + 'bookmarks', JSON.stringify(state.bookmarks));
    updateBookmarkCount();
    renderBookmarkList();
    if(state.searchResults.length > 0) renderSearchResults();
};

function updateBookmarkCount() {
    document.getElementById('bookmarkCount').textContent = `(${Object.keys(state.bookmarks).length})`;
}

function renderBookmarkList() {
    const container = document.getElementById('bookmarkList');
    const ids = Object.keys(state.bookmarks);
    
    if(ids.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-dim);">æš«ç„¡æ›¸ç±¤</p>';
        return;
    }
    
    let html = '';
    ids.forEach(id => {
        const bm = state.bookmarks[id];
        html += `
            <div style="background:var(--bg-elevated); padding:10px; margin-bottom:10px; border-radius:8px; border-left:3px solid var(--accent-gold);">
                <div style="display:flex; justify-content:space-between;">
                    <strong style="color:var(--text-primary);">${escapeHtml(bm.title)}</strong>
                    <button onclick="toggleBookmark(${id})" style="color:var(--danger); background:none; border:none; cursor:pointer;">âœ•</button>
                </div>
                <div style="font-size:0.8rem; color:var(--text-dim); margin-top:5px;">
                    ${escapeHtml(bm.cat)} | <a href="${bm.url}" target="_blank" style="color:var(--accent-ember);">é€£çµ</a>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function loadApiKeys() {
    const sk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'sheets_key');
    const gk = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'gemini_key');
    if (sk) document.getElementById('sheetsApiKey').value = sk;
    if (gk) document.getElementById('geminiApiKey').value = gk;
}

function setupAutoSave() {
    const si = document.getElementById('sheetsApiKey');
    const gi = document.getElementById('geminiApiKey');
    const ind = document.getElementById('saveIndicator');
    const save = () => {
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'sheets_key', si.value);
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'gemini_key', gi.value);
        ind.style.opacity = 1;
        setTimeout(() => ind.style.opacity = 0, 2000);
    };
    si.addEventListener('change', save);
    gi.addEventListener('change', save);
}

function getKey(type) {
    const k = document.getElementById(type + 'ApiKey')?.value?.trim();
    if (!k) {
        window.switchPage('settings');
        alert('è«‹å…ˆè¨­å®š API Key');
        throw new Error('No API Key');
    }
    return k;
}

async function callGemini(prompt, options = {}) {
    const key = getKey('gemini');

    const response = await fetch(`${CONFIG.GEMINI_API}?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: options.temperature || 0.7,
                maxOutputTokens: options.maxTokens || 4096
            }
        })
    });

    if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'API å‘¼å«å¤±æ•—');
    }

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!text) throw new Error('AI ç„¡å›æ‡‰');

    // å¦‚æœæœŸæœ› JSONï¼Œå˜—è©¦è§£æ
    if (options.expectJson) {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
            return JSON.parse(jsonMatch[1]);
        }
        try {
            return JSON.parse(text);
        } catch {
            // å¦‚æœè§£æå¤±æ•—ï¼Œå›å‚³åŸå§‹æ–‡å­—
            return { _raw: text };
        }
    }

    return text;
}

window.fetchSheets = async function() {
    try {
        const key = getKey('sheets');
        const url = document.getElementById('sheetsUrl').value;
        const id = url.match(/[-\w]{25,}/)?.[0];
        if(!id) throw new Error('é€£çµç„¡æ•ˆ');
        
        showLoading('è®€å–è©¦ç®—è¡¨...');
        
        const meta = await (await fetch(`${CONFIG.SHEETS_API}/${id}?key=${key}`)).json();
        if(meta.error) throw new Error(meta.error.message);
        
        const tabsContainer = document.getElementById('sheetTabs');
        tabsContainer.innerHTML = '';
        state.selectedSheets.clear();
        state.sheetsData = {};
        
        meta.sheets.forEach(s => {
            const title = s.properties.title;
            const btn = document.createElement('button');
            btn.className = 'quick-tag'; // Reuse style
            btn.textContent = title;
            btn.onclick = () => {
                if(state.selectedSheets.has(title)) {
                    state.selectedSheets.delete(title);
                    btn.style.background = 'var(--bg-deep)';
                    btn.style.color = 'var(--text-secondary)';
                } else {
                    state.selectedSheets.add(title);
                    btn.style.background = 'var(--accent-blood)';
                    btn.style.color = 'white';
                }
                updatePreview(id, key);
            };
            tabsContainer.appendChild(btn);
        });
        
        document.getElementById('sheetSelector').style.display = 'block';
        hideLoading();
    } catch(e) {
        hideLoading();
        alert('è®€å–å¤±æ•—: ' + e.message);
    }
};

function extractNotes(data) {
    const notes = {};
    const rows = data?.sheets?.[0]?.data?.[0]?.rowData;
    if (!rows) return notes;
    rows.forEach((row, ri) => {
        row.values?.forEach((cell, ci) => {
            if (cell.note) notes[`${ri}-${ci}`] = cell.note;
        });
    });
    return notes;
}

async function updatePreview(sheetId, key) {
    if(state.selectedSheets.size === 0) return;
    showLoading('ä¸‹è¼‰è³‡æ–™...');
    let fullText = '';
    let totalNotes = 0;

    try {
        for(const title of state.selectedSheets) {
            // è®€å–å„²å­˜æ ¼å€¼
            const res = await fetch(`${CONFIG.SHEETS_API}/${sheetId}/values/${encodeURIComponent(title)}?key=${key}`);
            const data = await res.json();

            // è®€å–å‚™è¨»
            const notesRes = await fetch(`${CONFIG.SHEETS_API}/${sheetId}?ranges=${encodeURIComponent(title)}&fields=sheets(data(rowData(values(note,formattedValue))))&key=${key}`);
            const notesData = await notesRes.json();
            const notes = extractNotes(notesData);

            fullText += `\n===== è§’è‰²ï¼š${title} =====\n`;
            if(data.values) {
                data.values.forEach((row, ri) => {
                    const rowText = row.map((cell, ci) => {
                        const noteKey = `${ri}-${ci}`;
                        if (notes[noteKey]) {
                            totalNotes++;
                            return `${cell}ã€å‚™è¨»ï¼š${notes[noteKey]}ã€‘`;
                        }
                        return cell;
                    }).join(' | ');
                    fullText += rowText + '\n';
                });
            }
        }
        state.charText = fullText;
        document.getElementById('previewBox').style.display = 'block';
        document.getElementById('previewContent').textContent = fullText.substring(0, 500) + '...';
        document.getElementById('previewStats').textContent = `${fullText.length} å­— | ${totalNotes} å€‹å‚™è¨»`;
    } catch(e) {
        console.error('Preview error:', e);
    }
    hideLoading();
}

window.analyzeCharacters = async function() {
    try {
        const text = document.getElementById('textInput').value || state.charText;
        if(!text) throw new Error('ç„¡è³‡æ–™');

        showLoading('AI åˆ†æä¸­ (å¯èƒ½éœ€è¦å¹¾ç§’)...');

        const keywords = extractKeywords(text);
        const relatedRules = searchRulesForAI(keywords);
        let ruleContext = "";
        if(relatedRules.length > 0) {
            ruleContext = "\n\nåƒè€ƒè¦å‰‡ï¼š\n" + relatedRules.map(r => `[${r.filename}] ${r.content.substring(0,200)}`).join('\n');
        }

        const prompt = `ä½ æ˜¯ç„¡é™ææ€–TRPGè³‡æ·±STã€‚åˆ†æä»¥ä¸‹è§’è‰²è³‡æ–™ï¼š
        ${text.substring(0, 10000)}
        ${ruleContext}

        è«‹å›å‚³ JSON æ ¼å¼ï¼š
        {
          "characters": [
            {
              "name": "è§’è‰²å",
              "powerLevel": "S/A/B/C/D",
              "summary": "ä¸€å¥è©±å®šä½",
              "stats": {"offense":1-10, "defense":1-10, "mobility":1-10, "control":1-10, "sustain":1-10, "utility":1-10},
              "coreAbilities": ["æ ¸å¿ƒèƒ½åŠ›1", "æ ¸å¿ƒèƒ½åŠ›2"],
              "warnings": ["âš ï¸ STè­¦å‘Šï¼šé€™å€‹èƒ½åŠ›å¯èƒ½ç ´å£å¹³è¡¡..."],
              "weaknesses": ["å¼±é»1", "å¼±é»2"],
              "suggestions": ["å°ç­–å»ºè­°1", "å°ç­–å»ºè­°2"],
              "relatedRules": ["ç›¸é—œè¦å‰‡é—œéµå­—1", "é—œéµå­—2"]
            }
          ],
          "teamSummary": {
            "overallPower": "æ•´é«”æˆ°åŠ›è©•ä¼°",
            "composition": "éšŠä¼çµ„æˆåˆ†æ",
            "synergies": ["combo1", "combo2"],
            "gaps": ["ç¼ºå¤±1", "ç¼ºå¤±2"]
          }
        }

        è©•ç´šæ¨™æº–ï¼šS=å¯ç§’æ®ºBOSSç´š, A=é«˜åº¦å„ªåŒ–, B=æœ‰æ˜é¡¯å¼·é …, C=å‡è¡¡æ™®é€š, D=æ–°æ‰‹æˆ–å¼±å‹¢
        è«‹ç‰¹åˆ¥æ³¨æ„å‚™è¨»ä¸­çš„éš±è—èƒ½åŠ›ï¼Œé€™äº›å¾€å¾€æ˜¯æœ€å±éšªçš„ã€‚`;

        const result = await callGemini(prompt, { expectJson: true, temperature: 0.7 });
        if (result._raw) {
            throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤');
        }
        
        state.lastAnalysis = result;
        saveHistory(result);

        renderRadar(result.characters);
        let html = '';
        result.characters.forEach(c => {
            html += renderCharacterCard(c);
        });

        // æ¸²æŸ“éšŠä¼ç¸½è©•
        const ts = result.teamSummary;
        if (ts) {
            const summary = typeof ts === 'string' ? ts : ts.overallPower;
            const composition = typeof ts === 'object' ? ts.composition : '';
            const synergies = typeof ts === 'object' && ts.synergies ? ts.synergies : [];
            const gaps = typeof ts === 'object' && ts.gaps ? ts.gaps : [];

            html += `<div class="team-summary-section">
                <h3 style="color:var(--accent-gold); margin-bottom:10px;">ğŸ“‹ éšŠä¼ç¸½è©•</h3>
                <p style="margin-bottom:10px;"><strong>æ•´é«”æˆ°åŠ›ï¼š</strong>${escapeHtml(summary)}</p>
                ${composition ? `<p style="margin-bottom:10px;"><strong>çµ„æˆåˆ†æï¼š</strong>${escapeHtml(composition)}</p>` : ''}
                ${synergies.length ? `<div class="synergies"><strong>âœ¨ Comboï¼š</strong><ul>${synergies.map(s => '<li>' + escapeHtml(s) + '</li>').join('')}</ul></div>` : ''}
                ${gaps.length ? `<div class="gaps"><strong>âš ï¸ ç¼ºå¤±ï¼š</strong><ul>${gaps.map(g => '<li>' + escapeHtml(g) + '</li>').join('')}</ul></div>` : ''}
            </div>`;
        }

        document.getElementById('resultsContainer').innerHTML = html;
        document.getElementById('analyzeResults').style.display = 'block';
        hideLoading();
        
    } catch(e) {
        hideLoading();
        document.getElementById('analyzeError').style.display = 'block';
        document.getElementById('analyzeError').textContent = 'åˆ†æå¤±æ•—: ' + e.message;
    }
};

function renderRadar(chars) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    if(state.radarChart) state.radarChart.destroy();

    const colors = ['rgba(196,30,58,0.5)', 'rgba(212,160,32,0.5)', 'rgba(52,152,219,0.5)'];

    state.radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['è¼¸å‡º', 'é˜²ç¦¦', 'æ©Ÿå‹•', 'æ§åˆ¶', 'çºŒèˆª', 'åŠŸèƒ½'],
            datasets: chars.slice(0,3).map((c, i) => ({
                label: c.name,
                data: Object.values(c.stats),
                backgroundColor: colors[i % 3],
                borderColor: colors[i % 3].replace('0.5','1'),
                borderWidth: 2
            }))
        },
        options: {
            scales: { r: { min: 0, max: 10, ticks: { display: false }, grid: { color: '#333' } } },
            plugins: { legend: { labels: { color: '#ccc' } } }
        }
    });
}

function renderCharacterCard(char) {
    const powerClass = `power-${char.powerLevel}`;
    let html = `<div class="char-card">
        <h3 style="color:var(--accent-gold); margin-bottom:8px;">
            ${escapeHtml(char.name)}
            <span class="power-badge ${powerClass}">${char.powerLevel}</span>
        </h3>
        <p style="color:var(--text-secondary); margin-bottom:15px;">${escapeHtml(char.summary)}</p>`;

    // æ ¸å¿ƒèƒ½åŠ›
    if (char.coreAbilities?.length) {
        html += `<div class="core-abilities">
            <strong style="color:var(--accent-gold);">ğŸ¯ æ ¸å¿ƒèƒ½åŠ›ï¼š</strong>
            <ul>${char.coreAbilities.map(a => '<li>' + escapeHtml(a) + '</li>').join('')}</ul>
        </div>`;
    }

    // STè­¦å‘Š
    if (char.warnings?.length) {
        html += `<div class="warnings">
            <strong>âš ï¸ STè­¦å‘Šï¼š</strong>
            <ul>${char.warnings.map(w => '<li>' + escapeHtml(w) + '</li>').join('')}</ul>
        </div>`;
    }

    // å¼±é»
    if (char.weaknesses?.length) {
        html += `<div class="weaknesses">
            <strong>ğŸ›¡ï¸ å¼±é»ï¼š</strong>
            <ul>${char.weaknesses.map(w => '<li>' + escapeHtml(w) + '</li>').join('')}</ul>
        </div>`;
    }

    // å°ç­–å»ºè­°
    if (char.suggestions?.length) {
        html += `<div class="suggestions">
            <strong>ğŸ’¡ å°ç­–å»ºè­°ï¼š</strong>
            <ul>${char.suggestions.map(s => '<li>' + escapeHtml(s) + '</li>').join('')}</ul>
        </div>`;
    }

    // ç›¸é—œè¦å‰‡æ¨™ç±¤
    if (char.relatedRules?.length) {
        html += `<div style="margin-top:10px;">
            <strong style="color:var(--text-secondary); font-size:0.85rem;">ğŸ“š ç›¸é—œè¦å‰‡ï¼š</strong><br>`;
        char.relatedRules.forEach(rule => {
            html += `<span class="rule-tag" onclick="quickSearch('${escapeHtml(rule)}')">${escapeHtml(rule)}</span>`;
        });
        html += `</div>`;
    }

    html += `</div>`;
    return html;
}

function extractKeywords(text) {
    const regex = /[\[ã€](.+?)[\]ã€‘]/g;
    const matches = [];
    let m;
    while((m = regex.exec(text)) !== null) matches.push(m[1]);
    return matches.slice(0, 5);
}

function searchRulesForAI(keywords) {
    if(!keywords.length) return [];
    return state.rulesData.filter(r => keywords.some(k => r.filename.includes(k))).slice(0, 3);
}

function smartSearchRules(query, maxResults = 5) {
    // åˆ†è©
    const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1);
    if (!terms.length) return [];

    // è¨ˆç®—æ¯æ¢è¦å‰‡çš„åŒ¹é…åˆ†æ•¸
    const scored = state.rulesData.map(rule => {
        let score = 0;
        terms.forEach(term => {
            // æ¨™é¡ŒåŒ¹é…æ¬Šé‡é«˜
            if (rule.filename.toLowerCase().includes(term)) score += 3;
            // åˆ†é¡åŒ¹é…
            if (rule.category.toLowerCase().includes(term)) score += 2;
            // å…§å®¹åŒ¹é…
            if (rule.searchText.includes(term)) score += 1;
        });
        return { ...rule, score };
    });

    // æ’åºä¸¦å–å‰ N ç­†
    return scored
        .filter(r => r.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, maxResults);
}

window.simulateBoss = async function() {
    try {
        showLoading('æ¨¡æ“¬ä¸­...');
        const hp = document.getElementById('bossHp').value;
        const def = document.getElementById('bossDef').value;
        const atk = document.getElementById('bossAtk').value;
        const dmg = document.getElementById('bossDmg').value;
        const init = document.getElementById('bossInit').value;
        const resist = document.getElementById('bossResist').value;
        const ability = document.getElementById('bossAbilities').value;

        let charContext = "";
        if(state.lastAnalysis) {
            charContext = "\n\né¢å°ç©å®¶éšŠä¼ï¼š\n" + state.lastAnalysis.characters.map(c =>
                `${c.name}(${c.powerLevel}) - ${c.summary}`
            ).join('\n');
        }

        const prompt = `ä½œç‚ºç„¡é™ææ€– TRPG è³‡æ·± STï¼Œåˆ†æä»¥ä¸‹ BOSS æˆ°é¬¥ï¼š

BOSS æ•¸å€¼ï¼š
- ç”Ÿå‘½å€¼ï¼š${hp}
- é˜²ç¦¦ï¼š${def}
- æ”»æ“Šï¼š${atk}
- å‚·å®³ï¼š${dmg}
- å…ˆæ”»ï¼š${init}
- æŠ—æ€§ï¼š${resist}
- ç‰¹æ®Šèƒ½åŠ›ï¼š${ability || 'ç„¡'}

${charContext}

è«‹ç”¨ JSON æ ¼å¼å›è¦†ï¼š
{
  "predictions": [
    {"name": "è§’è‰²å", "killRounds": "é ä¼°æ“Šæ®ºå›åˆ", "threat": "danger/warning/safe", "reason": "åŸå› "}
  ],
  "overallRounds": "3-5",
  "winRate": "80%",
  "risk": "ä½/ä¸­/é«˜",
  "analysis": "æ•´é«”åˆ†æ",
  "adjustments": {
    "recommendedHp": å»ºè­°HPæ•¸å€¼,
    "recommendedDef": å»ºè­°é˜²ç¦¦æ•¸å€¼,
    "suggestedMechanics": ["å»ºè­°åŠ å…¥çš„æ©Ÿåˆ¶1", "æ©Ÿåˆ¶2"],
    "warnings": ["éœ€è¦æ³¨æ„çš„äº‹é …"]
  }
}

threat èªªæ˜ï¼šdanger=å¯èƒ½1-2å›åˆç§’æ®º, warning=3-5å›åˆæ“Šæ®º, safe=éœ€è¦è¼ƒé•·æ™‚é–“
è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚`;

        const result = await callGemini(prompt, { expectJson: true });

        // é¡¯ç¤ºå„è§’è‰²é æ¸¬
        let html = '<h4 style="margin-bottom:15px;">ğŸ“Š å„è§’è‰²å¨è„…è©•ä¼°</h4>';
        if (result.predictions?.length) {
            result.predictions.forEach(p => {
                const color = p.threat === 'danger' ? 'var(--danger)' :
                             p.threat === 'warning' ? 'var(--warning)' : 'var(--success)';
                html += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                    <span>${escapeHtml(p.name)}</span>
                    <span style="color:${color};">${escapeHtml(p.killRounds)} å›åˆ (${p.threat})</span>
                </div>`;
            });
        }

        html += `<div style="margin-top:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-size:1.2rem; font-weight:bold; color:var(--accent-gold);">é è¨ˆ ${result.overallRounds} å›åˆ</span>
                <span style="color:var(--success);">å‹ç‡ ${result.winRate}</span>
            </div>
            <p style="color:var(--text-secondary);">${escapeHtml(result.analysis)}</p>
        </div>`;

        document.getElementById('bossResultContent').innerHTML = html;
        document.getElementById('bossResult').style.display = 'block';

        // é¡¯ç¤ºèª¿æ•´å»ºè­°
        if (result.adjustments) {
            const adj = result.adjustments;
            let tipsHtml = `
                <p><strong>å»ºè­° HPï¼š</strong>${adj.recommendedHp}</p>
                <p><strong>å»ºè­°é˜²ç¦¦ï¼š</strong>${adj.recommendedDef}</p>`;
            if (adj.suggestedMechanics?.length) {
                tipsHtml += `<p><strong>å»ºè­°æ©Ÿåˆ¶ï¼š</strong></p>
                <ul style="margin-left:20px;">${adj.suggestedMechanics.map(m => '<li>' + escapeHtml(m) + '</li>').join('')}</ul>`;
            }
            if (adj.warnings?.length) {
                tipsHtml += `<p style="color:var(--danger); margin-top:10px;"><strong>âš ï¸ æ³¨æ„ï¼š</strong>${adj.warnings.join('ã€')}</p>`;
            }
            document.getElementById('bossTips').innerHTML = tipsHtml;
        }

        hideLoading();
    } catch(e) {
        hideLoading();
        alert('æ¨¡æ“¬å¤±æ•—: ' + e.message);
    }
};

window.sendChat = async function() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if(!msg) return;

    input.value = '';
    const container = document.getElementById('chatMessages');
    container.innerHTML += `<div class="chat-msg user"><div class="chat-bubble">${escapeHtml(msg)}</div></div>`;

    try {
        const rules = smartSearchRules(msg, 5);
        let context = "";
        if(rules.length) {
            context = "\n\nç›¸é—œè¦å‰‡åƒè€ƒï¼š\n" + rules.map(r =>
                `ã€${r.filename}ã€‘\n${r.content.substring(0, 400)}`
            ).join('\n\n');
        }

        const prompt = `ä½ æ˜¯ç„¡é™ææ€– TRPG è¦å‰‡å°ˆå®¶ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¦å‰‡è³‡æ–™å›ç­”å•é¡Œã€‚

å•é¡Œï¼š${msg}
${context}

å›ç­”è¦æ±‚ï¼š
- ä½¿ç”¨ç¹é«”ä¸­æ–‡
- ç°¡æ½”æ˜ç­
- å¦‚æœè¦å‰‡è³‡æ–™ä¸­æœ‰ç›¸é—œå…§å®¹ï¼Œè«‹å¼•ç”¨
- å¦‚æœä¸ç¢ºå®šï¼Œè«‹æ˜ç¢ºèªªæ˜`;

        const text = await callGemini(prompt, { expectJson: false });

        container.innerHTML += `<div class="chat-msg ai"><div class="chat-bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div></div>`;
        container.scrollTop = container.scrollHeight;
    } catch(e) {
        container.innerHTML += `<div class="chat-msg ai"><div class="chat-bubble" style="color:var(--danger);">éŒ¯èª¤: ${e.message}</div></div>`;
    }
};

window.generateNPC = async function() {
    try {
        showLoading('ç”Ÿæˆä¸­...');
        const diff = document.getElementById('npcDiff').value;
        const type = document.getElementById('npcType').value;
        const desc = document.getElementById('npcDesc').value;

        const prompt = `ç”Ÿæˆç„¡é™ææ€–NPC: ${diff} ${type} ${desc}ã€‚\nè«‹çµ¦å‡ºå…­åœå±¬æ€§ã€HPã€ç°¡å–®æŠ€èƒ½åˆ—è¡¨ã€‚`;

        const text = await callGemini(prompt, { expectJson: false });

        const output = document.getElementById('npcOutput');
        output.textContent = text;
        output.style.display = 'block';
        hideLoading();
    } catch(e) {
        hideLoading();
        alert('ç”Ÿæˆå¤±æ•—');
    }
};

window.getEncounterTips = async function() {
    try {
        const desc = document.getElementById('encounterDesc').value;
        if(!desc) return;

        showLoading('æ€è€ƒä¸­...');
        const text = await callGemini("çµ¦å‡ºç„¡é™ææ€–é­é‡è¨­è¨ˆå»ºè­°: " + desc, { expectJson: false });

        const out = document.getElementById('encounterTips');
        out.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
        out.style.display = 'block';
        hideLoading();
    } catch(e) { hideLoading(); }
};

function loadHistory() {
    const h = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'history');
    if(h) state.history = JSON.parse(h);
    renderHistory();
    updateTrackSelect();
}

function saveHistory(data) {
    if (!data?.characters?.length) return;

    const item = {
        id: Date.now(),
        date: new Date().toLocaleString('zh-TW'),
        characters: data.characters.map(c => ({
            name: c.name,
            level: c.powerLevel,
            summary: c.summary
        })),
        fullData: data  // ä¿ç•™å®Œæ•´æ•¸æ“š
    };

    state.history.unshift(item);
    if(state.history.length > CONFIG.MAX_HISTORY) state.history.pop();
    localStorage.setItem(CONFIG.STORAGE_PREFIX + 'history', JSON.stringify(state.history));
    renderHistory();
    updateTrackSelect();
}

function renderHistory() {
    const list = document.getElementById('historyList');
    if(state.history.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-dim);">å°šç„¡ç´€éŒ„</p>';
        return;
    }

    list.innerHTML = state.history.map(h => `
        <div class="history-item" onclick="loadHistoryItem(${h.id})">
            <div class="history-header" style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="font-weight:bold; color:var(--text-primary);">${h.characters?.map(c => c.name + '(' + c.level + ')').join(', ') || 'åˆ†æçµæœ'}</span>
                <span style="font-size:0.85rem; color:var(--text-dim);">${h.date}</span>
            </div>
        </div>
    `).join('');
}

window.loadHistoryItem = function(id) {
    const item = state.history.find(h => h.id === id);
    if (item?.fullData) {
        state.lastAnalysis = item.fullData;
        // é‡æ–°æ¸²æŸ“çµæœ
        renderRadar(item.fullData.characters);
        let html = '';
        item.fullData.characters.forEach(c => {
            html += renderCharacterCard(c);
        });

        // æ¸²æŸ“éšŠä¼ç¸½è©•
        const ts = item.fullData.teamSummary;
        if (ts) {
            const summary = typeof ts === 'string' ? ts : ts.overallPower;
            const composition = typeof ts === 'object' ? ts.composition : '';
            const synergies = typeof ts === 'object' && ts.synergies ? ts.synergies : [];
            const gaps = typeof ts === 'object' && ts.gaps ? ts.gaps : [];

            html += `<div class="team-summary-section">
                <h3 style="color:var(--accent-gold); margin-bottom:10px;">ğŸ“‹ éšŠä¼ç¸½è©•</h3>
                <p style="margin-bottom:10px;"><strong>æ•´é«”æˆ°åŠ›ï¼š</strong>${escapeHtml(summary)}</p>
                ${composition ? `<p style="margin-bottom:10px;"><strong>çµ„æˆåˆ†æï¼š</strong>${escapeHtml(composition)}</p>` : ''}
                ${synergies.length ? `<div class="synergies"><strong>âœ¨ Comboï¼š</strong><ul>${synergies.map(s => '<li>' + escapeHtml(s) + '</li>').join('')}</ul></div>` : ''}
                ${gaps.length ? `<div class="gaps"><strong>âš ï¸ ç¼ºå¤±ï¼š</strong><ul>${gaps.map(g => '<li>' + escapeHtml(g) + '</li>').join('')}</ul></div>` : ''}
            </div>`;
        }

        document.getElementById('resultsContainer').innerHTML = html;
        document.getElementById('analyzeResults').style.display = 'block';
        switchPage('analyze');
    }
};

function updateTrackSelect() {
    const select = document.getElementById('trackSelect');
    const charMap = {};

    // æ”¶é›†æ‰€æœ‰è§’è‰²åç¨±å’Œå‡ºç¾æ¬¡æ•¸
    state.history.forEach(h => {
        h.characters?.forEach(c => {
            if (!charMap[c.name]) charMap[c.name] = 0;
            charMap[c.name]++;
        });
    });

    // åªé¡¯ç¤ºå‡ºç¾è¶…é1æ¬¡çš„è§’è‰²
    const repeatChars = Object.entries(charMap).filter(([_, count]) => count > 1);

    if (repeatChars.length === 0) {
        select.innerHTML = '<option value="">-- ç„¡å¯è¿½è¹¤è§’è‰² --</option>';
        return;
    }

    select.innerHTML = '<option value="">-- é¸æ“‡è§’è‰² --</option>' +
        repeatChars.map(([name, count]) =>
            `<option value="${escapeHtml(name)}">${escapeHtml(name)} (${count}æ¬¡)</option>`
        ).join('');

    select.onchange = () => showCharacterTrack(select.value);
}

window.showCharacterTrack = function(name) {
    if (!name) {
        document.getElementById('trackResult').innerHTML = '';
        return;
    }

    // æ‰¾å‡ºè©²è§’è‰²çš„æ‰€æœ‰æ­·å²è¨˜éŒ„
    const records = [];
    state.history.forEach(h => {
        const char = h.fullData?.characters?.find(c => c.name === name);
        if (char) {
            records.push({
                date: h.date,
                level: char.powerLevel,
                stats: char.stats,
                summary: char.summary
            });
        }
    });

    if (records.length < 2) {
        document.getElementById('trackResult').innerHTML = '<p style="color:var(--text-dim);">éœ€è¦è‡³å°‘2æ¬¡åˆ†ææ‰èƒ½è¿½è¹¤</p>';
        return;
    }

    // æ¯”è¼ƒæœ€æ–°å’Œæœ€èˆŠ
    const latest = records[0];
    const oldest = records[records.length - 1];

    let html = `<h4 style="color:var(--accent-gold); margin-bottom:10px;">${escapeHtml(name)} æˆé•·è¿½è¹¤</h4>`;
    html += `<p>è©•ç´šè®ŠåŒ–ï¼š<strong>${oldest.level}</strong> â†’ <strong style="color:var(--accent-ember);">${latest.level}</strong></p>`;

    // å…­ç¶­è®ŠåŒ–
    if (latest.stats && oldest.stats) {
        html += '<div style="margin-top:10px;">';
        ['offense', 'defense', 'mobility', 'control', 'sustain', 'utility'].forEach(stat => {
            const diff = (latest.stats[stat] || 0) - (oldest.stats[stat] || 0);
            const color = diff > 0 ? 'var(--success)' : diff < 0 ? 'var(--danger)' : 'var(--text-dim)';
            const sign = diff > 0 ? '+' : '';
            html += `<span style="margin-right:10px;">${stat}: <span style="color:${color};">${sign}${diff}</span></span>`;
        });
        html += '</div>';
    }

    // æ­·å²åˆ—è¡¨
    html += '<div style="margin-top:15px; max-height:200px; overflow-y:auto;">';
    records.forEach(r => {
        html += `<div style="padding:8px; border-bottom:1px solid var(--border); font-size:0.85rem;">
            <span style="color:var(--text-dim);">${r.date}</span> -
            <span style="color:var(--accent-gold);">${r.level}</span>
        </div>`;
    });
    html += '</div>';

    document.getElementById('trackResult').innerHTML = html;
};

window.clearHistory = function() {
    if(confirm('ç¢ºå®šæ¸…é™¤ï¼Ÿ')) {
        state.history = [];
        localStorage.removeItem(CONFIG.STORAGE_PREFIX + 'history');
        renderHistory();
        updateTrackSelect();
    }
};

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function highlightText(text, terms) {
    if (!terms || !terms.length) return escapeHtml(text);
    let result = escapeHtml(text);
    terms.forEach(term => {
        if (term) result = result.replace(new RegExp(`(${escapeRegex(term)})`, 'gi'), '<mark>$1</mark>');
    });
    return result;
}

function getSnippet(text, terms, maxLen) {
    if (!text) return '';
    if (!terms || !terms.length) return text.substring(0, maxLen) + (text.length > maxLen ? '...' : '');
    let firstPos = text.length;
    terms.forEach(t => {
        const pos = text.toLowerCase().indexOf(t);
        if (pos !== -1 && pos < firstPos) firstPos = pos;
    });
    const start = Math.max(0, firstPos - 50);
    const end = Math.min(text.length, start + maxLen);
    let snippet = text.substring(start, end);
    if (start > 0) snippet = '...' + snippet;
    if (end < text.length) snippet += '...';
    return snippet;
}

window.exportResults = function(format) {
    if (!state.lastAnalysis) return;
    const data = state.lastAnalysis;

    if (format === 'discord') {
        let text = '**ğŸ“Š è§’å¡æˆ°åŠ›åˆ†æ**\n\n';
        data.characters.forEach(c => {
            text += `**${c.name}** [${c.powerLevel}]\n`;
            text += `> ${c.summary}\n`;
            if (c.warnings?.length) {
                text += `âš ï¸ ${c.warnings.join('\nâš ï¸ ')}\n`;
            }
            text += '\n';
        });
        const ts = data.teamSummary;
        if (ts) {
            const summary = typeof ts === 'string' ? ts : ts.overallPower;
            text += `**éšŠä¼ç¸½è©•ï¼š** ${summary}\n`;
        }
        navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'));

    } else if (format === 'markdown') {
        let text = '# è§’å¡æˆ°åŠ›åˆ†æ\n\n';
        data.characters.forEach(c => {
            text += `## ${c.name} [${c.powerLevel}]\n\n`;
            text += `${c.summary}\n\n`;
            if (c.coreAbilities?.length) {
                text += `### æ ¸å¿ƒèƒ½åŠ›\n${c.coreAbilities.map(a => '- ' + a).join('\n')}\n\n`;
            }
            if (c.warnings?.length) {
                text += `### âš ï¸ è­¦å‘Š\n${c.warnings.map(w => '- ' + w).join('\n')}\n\n`;
            }
        });
        navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½ Markdownï¼'));

    } else {
        // JSON ä¸‹è¼‰
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analysis_' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }
};

window.toggleExpand = function(id) {
    const el = document.getElementById('content-' + id);
    const btn = el?.closest('.search-result-card')?.querySelector('.expand-btn');
    if (!el || !btn) return;
    const item = state.rulesData[id];
    if (el.classList.contains('expanded')) {
        el.classList.remove('expanded');
        el.innerHTML = highlightText(getSnippet(item.content, state.searchTerms, 250), state.searchTerms);
        btn.textContent = 'ğŸ“– å±•é–‹å…¨æ–‡';
    } else {
        el.classList.add('expanded');
        el.innerHTML = highlightText(item.content, state.searchTerms);
        btn.textContent = 'ğŸ“• æ”¶åˆ';
    }
};

</script>

</body>
</html>